## 📋 QIRO 서비스 데이터베이스 설계 진행 가이드

데이터베이스 설계는 보통 **요구사항 분석 → 개념적 설계 → 논리적 설계 → 물리적 설계 → 구현 및 테스트**의 단계를 따릅니다. 지금까지 저희가 진행한 FRS 및 API 설계 논의가 "요구사항 분석" 및 일부 "개념적/논리적 설계"의 기초가 됩니다.

### 1단계: 요구사항 재검토 및 핵심 데이터 식별 (Review Requirements & Identify Key Data)

- 기존 문서 종합 검토:

  - 지금까지 작성된 모든 **기능 명세서(FRS)** (예: 건물 정보 관리, 임대 계약 관리, 관리비 항목 관리, 청구월 관리, 회계 관리 등)를 다시 한번 꼼꼼히 검토합니다.
  - 각 FRS의 **4절 "데이터 요구사항"**에 명시된 주요 엔티티, 속성, 그리고 입출력 데이터를 종합합니다.
  - 설계된 **API 명세서**의 요청(Request) 및 응답(Response) DTO도 중요한 참고 자료입니다. DTO의 필드들은 데이터베이스 컬럼과 밀접하게 연관됩니다.

- 핵심 엔티티 목록화:

   QIRO 서비스에 필요한 모든 주요 엔티티(테이블로 변환될 대상)를 목록으로 만듭니다.

  - 예시: `건물`, `동`, `호실`, `임대인`, `임차인`, `임대계약`, `관리비항목마스터`, `청구월`, `청구월별항목설정`, `세대별월별검침`, `공용시설월별검침`, `외부고지서계정`, `월별외부고지서금액`, `세대별월별관리비`, `세대별월별관리비상세`, `수납기록`, `미납/연체기록`, `시설물`, `시설물점검이력`, `협력업체`, `협력업체담당자`, `협력업체계약`, `민원`, `민원이력`, `공지사항`, `시스템알림설정`, `알림템플릿`, `알림발송이력`, `내부사용자(직원)`, `역할`, `권한`, `시스템환경설정`, (회계) `계정과목`, `전표`, `분개라인` 등.

### 2단계: 개념적 데이터 모델링 (Conceptual Data Modeling)

- 주요 엔티티 간 관계 정의:

   1단계에서 식별된 핵심 엔티티들 간의 관계를 파악합니다.

  - **관계 유형:** 일대일(1:1), 일대다(1:N), 다대다(M:N).
  - **참여 조건:** 필수적 관계인지, 선택적 관계인지 정의합니다.

- 개념적 ERD(Entity-Relationship Diagram) 작성:

  - 주요 엔티티와 그 관계를 중심으로 단순화된 다이어그램을 작성합니다. 이 단계에서는 아직 속성을 상세히 기술하지 않아도 됩니다.
  - **도구 예시:** draw.io (무료, 웹 기반), Lucidchart, Miro 등 시각화 도구 사용.

### 3단계: 논리적 데이터 모델링 (Logical Data Modeling)

- 엔티티별 속성 상세 정의:

   각 엔티티에 필요한 모든 속성(Attribute)을 상세히 정의합니다.

  - **속성명:** (API 설계 시 논의된 `camelCase` JSON 필드명을 참고하여 DB 컬럼명 규칙(예: `snake_case`)에 맞게 변환)
  - **데이터 타입:** 일반적인 데이터 타입 (예: 문자열, 숫자, 날짜, 불리언) 우선 정의.
  - **기본키 (Primary Key - PK):** 각 엔티티를 고유하게 식별할 수 있는 속성 또는 시스템 생성 ID(예: UUID, Auto-increment Long) 지정.
  - **외래키 (Foreign Key - FK):** 엔티티 간의 관계를 표현하기 위한 외래키 지정.
  - **제약조건:** `NOT NULL`, `UNIQUE`, 기본값(Default), 체크(CHECK) 제약 등.

- **다대다(M:N) 관계 처리:** 다대다 관계는 별도의 연결 테이블(Junction Table 또는 Associative Entity)로 해소합니다. (예: `사용자-역할 연결`, `역할-권한 연결`)

- **정규화 (Normalization):** 데이터 중복을 최소화하고 데이터 무결성을 높이기 위해 정규화 과정(보통 제3 정규형(3NF)까지)을 거칩니다.

- **논리적 ERD 상세화:** 개념적 ERD를 바탕으로 모든 속성, PK, FK, 관계의 카디널리티(Cardinality) 및 선택성(Optionality)을 포함한 상세한 ERD를 작성합니다.

### 4단계: 물리적 데이터 모델링 (Physical Data Modeling - PostgreSQL 기준)

- 데이터 타입 매핑:

   논리적 모델의 데이터 타입을 실제 사용할 데이터베이스(QIRO의 경우 

  PostgreSQL

  )의 특정 데이터 타입으로 매핑합니다.

  - 예: 문자열 → `VARCHAR(n)`, `TEXT`; 숫자 → `INTEGER`, `BIGINT`, `NUMERIC(p,s)`; 날짜 → `DATE`, `TIMESTAMP WITH TIME ZONE`; 불리언 → `BOOLEAN`; 고유ID → `UUID`, `BIGSERIAL`.

- **테이블 및 컬럼명 확정:** PostgreSQL 명명 규칙에 따라 최종 테이블명과 컬럼명을 확정합니다. (일반적으로 `snake_case` 사용)

- 인덱스(Index) 설계:

  - PK, FK에는 자동으로 인덱스가 생성되는 경우가 많습니다.
  - 조회 성능 향상을 위해 자주 검색 조건(WHERE 절)으로 사용되거나, 정렬(ORDER BY) 기준으로 사용되는 컬럼에 적절한 인덱스를 추가합니다. (예: 건물명, 호실번호, 임차인명, 날짜 범위 등)
  - `UNIQUE` 제약이 필요한 컬럼 조합에 대한 인덱스도 고려합니다.

- (선택) 고급 객체 설계:

  - 파티셔닝(Partitioning): 대용량 테이블의 성능 향상을 위해 고려. (예: `전표`, `로그` 테이블)
  - 뷰(View): 복잡한 조회나 자주 사용되는 조인 결과를 단순화하기 위해 사용.
  - 저장 프로시저/함수 (Stored Procedures/Functions): 특정 로직을 데이터베이스 수준에서 처리할 필요가 있을 때 (QIRO는 Spring Boot 백엔드 로직 우선).

- **물리적 ERD 작성:** 물리적 데이터 타입, 인덱스 정보 등을 포함한 ERD를 완성합니다.

### 5단계: 데이터베이스 스키마 생성 및 검증

- DDL (Data Definition Language) 스크립트 작성:

  ```
  CREATE TABLE
  ```

  , 

  ```
  ALTER TABLE
  ```

  , 

  ```
  CREATE INDEX
  ```

   등 데이터베이스 스키마를 생성하고 수정하기 위한 SQL 스크립트를 작성합니다.

  - (DB 마이그레이션 도구(Flyway, Liquibase) 사용 시 해당 도구의 형식에 맞춰 작성)

- **개발/테스트 환경에 스키마 적용:** 작성된 DDL을 사용하여 실제 데이터베이스에 스키마를 생성합니다.

- **샘플 데이터 입력 및 주요 기능 테스트:** 주요 FRS의 시나리오를 기반으로 샘플 데이터를 입력하고, 예상되는 주요 조회(Query)들이 정상적으로 동작하는지, 성능에 문제는 없는지 검증합니다.

- **설계 반복 및 개선:** 검증 과정에서 발견된 문제점이나 개선 필요 사항을 바탕으로 논리적/물리적 설계를 반복적으로 수정하고 개선합니다.

### 6단계: 데이터베이스 설계 문서화

- **최종 ERD:** 논리적 ERD와 물리적 ERD.
- **테이블 정의서 (Data Dictionary):** 각 테이블 및 컬럼에 대한 상세 설명, 데이터 타입, 제약조건, 관계, 인덱스 정보 등을 포함.
- **주요 설계 결정 사항 및 근거:** 특정 기술 선택 이유, 정규화/비정규화 결정 근거 등 기록.

**추가 조언:**

- **도구 활용:** ERD 작성 및 모델링에는 draw.io, Lucidchart, AQueryTool, pgModeler (PostgreSQL 전용) 등 다양한 도구를 활용할 수 있습니다. DbDiagram.io와 같이 텍스트로 스키마를 정의하면 다이어그램이 생성되는 도구도 효율적입니다.
- **팀과의 협업:** 데이터베이스 설계는 백엔드 개발자뿐만 아니라, 프론트엔드 개발자, 기획자 등 팀 전체의 의견을 수렴하고 검토하는 과정이 중요합니다. 특히 API를 통해 데이터를 주고받는 방식과 밀접하게 연관되므로 백엔드-프론트엔드 간의 긴밀한 협의가 필요합니다.
- **확장성 및 유지보수성 고려:** 초기 설계 시부터 향후 기능 확장이나 데이터 증가에 따른 변경 용이성 및 유지보수 편의성을 고려해야 합니다.
- **보안 고려:** 개인정보 등 민감한 데이터는 암호화 저장 방안을 물리 설계 시 함께 고려합니다.

이러한 단계를 따라 진행하시면 QIRO 서비스에 적합한 견고하고 효율적인 데이터베이스를 설계하실 수 있을 것입니다. 가장 먼저 **1단계(기존 문서 종합 검토 및 핵심 엔티티 목록화)**부터 시작하여, 저희가 이미 논의한 엔티티와 속성들을 정리하는 작업부터 진행하시면 좋겠습니다. 😊
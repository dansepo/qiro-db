데이터의 무결성을 보장하고, 시스템이 올바르게 동작하기 위한 중요한 규칙들을 설정하는 과정입니다. 여기서는 주요 엔티티들을 중심으로 관계와 제약 조건을 설명드리겠습니다.

------

## 🔗 QIRO 주요 엔티티 간 관계 및 상세 제약 조건 정의

*(참고: 실제 물리적 설계 시에는 각 DBMS(PostgreSQL)의 특성에 맞는 정확한 구문과 추가적인 제약조건(예: CHECK 제약의 구체적인 조건식)이 정의되어야 합니다. 여기서는 개념적인 관계와 주요 제약 조건을 중심으로 기술합니다.)*

### 1. 건물 및 호실 정보 관련 엔티티

#### 1.1. `Building` (건물)

- 관계:

  - ```
    Building
    ```

     (1) --- (N) 

    ```
    BuildingDong
    ```

     (건물은 여러 동을 가질 수 있음 - 선택적)

    - **FK:** `BuildingDong.buildingId` references `Building.buildingId`
    - **ON DELETE:** `CASCADE` (건물 삭제 시 하위 동 정보도 함께 삭제) 또는 `RESTRICT` (하위 동이 있으면 건물 삭제 불가) - 정책 결정 필요. 일반적으로 `RESTRICT` 후 수동 처리.

  - ```
    Building
    ```

     (1) --- (N) 

    ```
    Unit
    ```

     (건물은 여러 호실을 가짐)

    - **FK:** `Unit.buildingId` references `Building.buildingId`
    - **ON DELETE:** `RESTRICT` (호실이 있는 건물은 삭제 불가)

  - ```
    Building
    ```

     (1) --- (N) 

    ```
    BuildingCommonFacility
    ```

     (건물은 여러 공용시설을 가질 수 있음)

    - **FK:** `BuildingCommonFacility.buildingId` references `Building.buildingId`
    - **ON DELETE:** `CASCADE` 또는 `RESTRICT`

  - ```
    Lessor
    ```

     (N) --- (M) 

    ```
    Building
    ```

     (임대인은 여러 건물을 소유/위탁하고, 건물은 여러 임대인에게 공동 소유될 수 있음 - 단, QIRO에서는 주 임대인 개념이거나, 

    ```
    LessorPropertyLink
    ```

    를 통한 연결이 더 적합할 수 있음. 여기서는 Building에 

    ```
    mainLessorId
    ```

     FK가 있다면 1:N 관계)

    - (만약 

      ```
      Building.mainLessorId
      ```

      가 있다면) 

      ```
      Building
      ```

       (N) --- (1) 

      ```
      Lessor
      ```

      - **FK:** `Building.mainLessorId` references `Lessor.lessorId`
      - **ON DELETE:** `SET NULL` 또는 `RESTRICT`

- 주요 제약 조건:

  - `buildingName` + `addressStreet`: UNIQUE 조합 (동일 주소에 같은 이름의 건물 중복 방지)
  - `status`: 정의된 값만 허용 (예: `ACTIVE`, `INACTIVE`, `PREPARING_MGMT` - CHECK 제약)

#### 1.2. `BuildingDong` (건물 동)

- 관계:

  - ```
    BuildingDong
    ```

     (1) --- (N) 

    ```
    Unit
    ```

     (하나의 동은 여러 호실을 가짐)

    - **FK:** `Unit.dongId` references `BuildingDong.dongId`
    - **ON DELETE:** `RESTRICT` (호실이 있는 동은 삭제 불가)

- 주요 제약 조건:

  - `buildingId` + `dongName`: UNIQUE 조합 (동일 건물 내 동 이름 중복 방지)

#### 1.3. `Unit` (호실/세대)

- 관계:

  - ```
    Unit
    ```

     (1) --- (N) 

    ```
    LeaseContract
    ```

     (하나의 호실은 시간에 따라 여러 임대 계약을 가질 수 있음)

    - **FK:** `LeaseContract.unitId` references `Unit.unitId`
    - **ON DELETE:** `RESTRICT` (계약이 연결된 호실은 삭제 불가)

  - ```
    Unit
    ```

     (1) --- (N) 

    ```
    UnitMonthlyMeterReading
    ```

     (하나의 호실은 여러 월의 검침 데이터를 가짐)

    - **FK:** `UnitMonthlyMeterReading.unitId` references `Unit.unitId`
    - **ON DELETE:** `CASCADE` 또는 `RESTRICT`

  - ```
    Unit
    ```

     (1) --- (N) 

    ```
    UnitMonthlyUnpaidAmount
    ```

    - **FK:** `UnitMonthlyUnpaidAmount.unitId` references `Unit.unitId`
    - **ON DELETE:** `CASCADE` 또는 `RESTRICT`

  - ```
    Unit
    ```

     (1) --- (N) 

    ```
    UnitMonthlyFee
    ```

    - **FK:** `UnitMonthlyFee.unitId` references `Unit.unitId`
    - **ON DELETE:** `RESTRICT`

  - (만약 

    ```
    LessorPropertyLink
    ```

    를 사용하지 않고 

    ```
    Unit
    ```

    에 직접 임대인을 연결한다면) 

    ```
    Unit
    ```

     (N) --- (1) 

    ```
    Lessor
    ```

    - **FK:** `Unit.currentLessorId` references `Lessor.lessorId`
    - **ON DELETE:** `SET NULL` 또는 `RESTRICT`

  - (현재 임차인, 현재 계약 직접 연결은 `currentTenantId`, `currentLeaseContractId` FK로 표현됨)

- 주요 제약 조건:

  - `buildingId` + (`dongId`가 NULL이 아닐 경우 `dongId`) + `unitNumber`: UNIQUE 조합 (동일 건물/동 내 호실번호 중복 방지)
  - `currentStatus`: 정의된 값만 허용 (예: `VACANT`, `LEASED` - CHECK 제약)
  - `exclusiveArea`, `contractArea`: 양수여야 함 (CHECK 제약)

------

### 2. 임대차 관련 엔티티

#### 2.1. `Lessor` (임대인)

- 관계:

   (1.1 및 1.3에서 반대 방향 관계 참조)

  - `Lessor` (1) --- (N) `LessorPropertyLink`
  - `Lessor` (1) --- (N) `LessorBankAccount`
  - `Lessor` (1) --- (N) `LeaseContract`

- 주요 제약 조건:

  - `businessNumber`: UNIQUE (입력 시)
  - `lessorType`, `status`: 정의된 Enum 값만 허용 (CHECK 제약)

#### 2.2. `Tenant` (임차인/세대주)

- 관계:

  - ```
    Tenant
    ```

     (1) --- (N) 

    ```
    LeaseContract
    ```

     (한 명의 임차인은 여러 계약을 가질 수 있음 - 예: 이전 계약, 현재 계약)

    - **FK:** `LeaseContract.tenantId` references `Tenant.tenantId`

  - ```
    Tenant
    ```

     (1) --- (N) 

    ```
    TenantVehicle
    ```

    - **FK:** `TenantVehicle.tenantId` references `Tenant.tenantId`
    - **ON DELETE:** `CASCADE`

- 주요 제약 조건:

  - `contactNumber`: (정책에 따라) UNIQUE 또는 부분적 UNIQUE.
  - `status`: 정의된 Enum 값만 허용 (CHECK 제약)

#### 2.3. `LeaseContract` (임대 계약)

- 관계:

   (이미 

  ```
  Unit
  ```

  , 

  ```
  Lessor
  ```

  , 

  ```
  Tenant
  ```

  에서 FK로 정의됨)

  - `LeaseContract` (N) --- (1) `Unit`

  - `LeaseContract` (N) --- (1) `Lessor`

  - `LeaseContract` (N) --- (1) `Tenant`

  - ```
    LeaseContract
    ```

     (1) --- (N) 

    ```
    ContractAttachment
    ```

     (계약서는 여러 첨부파일을 가질 수 있음)

    - **FK:** `ContractAttachment.contractId` references `LeaseContract.contractId`
    - **ON DELETE:** `CASCADE`

  - ```
    LeaseContract
    ```

     (1) --- (1) 

    ```
    MoveOutSettlement
    ```

     (하나의 계약 종료는 하나의 퇴실 정산과 연결 - 선택적)

    - **FK:** `MoveOutSettlement.contractId` references `LeaseContract.contractId`

  - ```
    LeaseContract
    ```

     (1) --- (N) 

    ```
    MonthlyRentLedger
    ```

     (또는 

    ```
    Invoice
    ```

     중 임대료 부분)

    - **FK:** `MonthlyRentLedger.contractId` references `LeaseContract.contractId`

- 주요 제약 조건:

  - `unitId` + `startDate` + `endDate` 기간 중첩 방지: 특정 호실에 대해 계약 기간이 겹치는 활성 계약이 동시에 존재할 수 없도록 하는 복합 UNIQUE 또는 별도 로직 필요.
  - `endDate` >= `startDate` (CHECK 제약)
  - `depositAmount`, `rentAmount`: 0 이상 (CHECK 제약)
  - `status`: 정의된 Enum 값만 허용 (CHECK 제약)
  - `parentContractId`: 자기 자신을 참조하며, 순환 참조 방지 필요.

------

### 3. 관리비 설정 및 청구월 관련 엔티티

#### 3.1. `FeeItem` (관리비 부과 항목 마스터)

- 관계:

  - ```
    FeeItem
    ```

     (1) --- (N) 

    ```
    BillingMonthFeeItemSetting
    ```

    - **FK:** `BillingMonthFeeItemSetting.feeItemId` references `FeeItem.feeItemId`

  - ```
    FeeItem
    ```

     (1) --- (N) 

    ```
    BillToFeeItemLink
    ```

    - **FK:** `BillToFeeItemLink.feeItemId` references `FeeItem.feeItemId`

- 주요 제약 조건:

  - `itemName`: UNIQUE (또는 `itemName` + `isActive` + 유효기간 조합 UNIQUE)
  - `impositionMethod`, `status`: 정의된 Enum 값만 허용 (CHECK 제약)

#### 3.2. `ExternalBillAccount` (외부 고지서 계정 정보)

- 관계:

  - ```
    ExternalBillAccount
    ```

     (1) --- (N) 

    ```
    BillToFeeItemLink
    ```

    - **FK:** `BillToFeeItemLink.extBillAccountId` references `ExternalBillAccount.extBillAccountId`
    - **ON DELETE:** `CASCADE`

  - ```
    ExternalBillAccount
    ```

     (1) --- (N) 

    ```
    MonthlyExternalBillAmount
    ```

    - **FK:** `MonthlyExternalBillAmount.extBillAccountId` references `ExternalBillAccount.extBillAccountId`
    - **ON DELETE:** `RESTRICT` (월별 입력 금액이 있으면 계정 정보 삭제 불가)

  - ```
    Building
    ```

     (1) --- (N) 

    ```
    ExternalBillAccount
    ```

    - **FK:** `ExternalBillAccount.buildingId` references `Building.buildingId`

- 주요 제약 조건:

  - `buildingId` + `customerNumber` + `utilityType`: UNIQUE 조합 (또는 `accountNickname` 포함)
  - `utilityType`: 정의된 Enum 값 (CHECK 제약)
  - `isForIndividualUsage`, `isForCommonUsage` 중 하나는 `true`여야 함 (CHECK 제약 - R-EXTBILL-002 규칙)

#### 3.3. `BillingMonth` (청구월)

- 관계:

  - ```
    BillingMonth
    ```

     (1) --- (N) 

    ```
    BillingMonthFeeItemSetting
    ```

    - **ON DELETE:** `CASCADE`

  - ```
    BillingMonth
    ```

     (1) --- (N) 

    ```
    UnitMonthlyPreviousMeterReading
    ```

    - **ON DELETE:** `CASCADE`

  - ```
    BillingMonth
    ```

     (1) --- (N) 

    ```
    UnitMonthlyUnpaidAmount
    ```

    - **ON DELETE:** `CASCADE`

  - ```
    BillingMonth
    ```

     (1) --- (N) 

    ```
    CommonFacilityMonthlyReading
    ```

    - **ON DELETE:** `CASCADE`

  - ```
    BillingMonth
    ```

     (1) --- (N) 

    ```
    UnitMonthlyMeterReading
    ```

    - **ON DELETE:** `CASCADE`

  - ```
    BillingMonth
    ```

     (1) --- (N) 

    ```
    MonthlyExternalBillAmount
    ```

    - **ON DELETE:** `CASCADE`

  - ```
    BillingMonth
    ```

     (1) --- (N) 

    ```
    UnitMonthlyFee
    ```

    - **ON DELETE:** `RESTRICT` (관리비 산정 내역이 있으면 청구월 삭제 불가)

- 주요 제약 조건:

  - `year` + `month` (+ `buildingId` 만약 건물별 청구월 관리 시): UNIQUE 조합
  - `status`: 정의된 Enum 값 (`PREPARING`, `IN_PROGRESS`, `COMPLETED`)만 허용 (CHECK 제약)
  - `endDate` >= `startDate` (CHECK 제약)

------

### 4. 관리비 산정, 고지, 수납 관련 엔티티

#### 4.1. `UnitMonthlyFee` (월별 세대 관리비 - 계산 결과 총괄)

- 관계:

  - ```
    UnitMonthlyFee
    ```

     (1) --- (N) 

    ```
    UnitFeeDetail
    ```

    - **ON DELETE:** `CASCADE`

  - ```
    UnitMonthlyFee
    ```

     (1) --- (1 or 0) 

    ```
    Invoice
    ```

     (고지서가 이 정보를 바탕으로 생성)

    - **FK:** `Invoice.unitMonthlyFeeId` references `UnitMonthlyFee.unitMonthlyFeeId`

  - ```
    UnitMonthlyFee
    ```

     (1) --- (N) 

    ```
    PaymentRecord
    ```

     (하나의 월별 관리비에 여러 번 수납 가능 - 분할 납부)

    - **FK:** `PaymentRecord.unitMonthlyFeeId` (또는 `invoiceId` 통해 간접 연결)

  - `UnitMonthlyFee` (1) --- (1 or 0) `DelinquencyRecord` (미납 발생 시 연결)

- 주요 제약 조건:

  - `billingMonthId` + `unitId`: UNIQUE 조합
  - `paymentStatus`, `calculationStatus`: 정의된 Enum 값 (CHECK 제약)
  - `finalAmountDue` >= `paidAmount` (항상 그런 것은 아님, 과납 가능성) -> `currentUnpaidBalance` 계산 로직에서 처리.

#### 4.2. `Invoice` (관리비 고지서)

- 관계:

  - ```
    Invoice
    ```

     (1) --- (N) 

    ```
    PaymentRecord
    ```

     (하나의 고지서에 여러 번 수납 가능)

    - **FK:** `PaymentRecord.invoiceId` references `Invoice.invoiceId`

- 주요 제약 조건:

  - `billingMonthId` + `unitId`: UNIQUE 조합 (한 달에 한 세대 고지서는 하나)
  - `status`: 정의된 Enum 값 (CHECK 제약)

#### 4.3. `PaymentRecord` (수납 이력)

- 주요 제약 조건:
  - `paidAmount` > 0 (CHECK 제약)
  - `paymentMethod`: 정의된 Enum 값 (CHECK 제약)

------

### 5. 시설, 민원, 회계, 알림, 시스템 설정 관련 엔티티

각각의 기능 명세서에서 정의된 주요 엔티티 간 관계를 유사한 방식으로 정의합니다. 예를 들어:

- **`Facility` (시설물):** `Building` (N) --- (1) `Facility` (시설물은 특정 건물에 속함). `Facility` (1) --- (N) `FacilityInspectionRecord`.
- **`Complaint` (민원):** `Unit` (1) --- (N) `Complaint`. `Tenant` (1) --- (N) `Complaint`. `InternalUser` (N) --- (M) `Complaint` (담당자).
- **`JournalEntry` (전표):** `JournalEntry` (1) --- (N) `JournalEntryLine`. `JournalEntryLine` (N) --- (1) `ChartOfAccount`.
- **`Announcement` (공지사항):** (대상 지정 방식에 따라) `Building` (N) --- (M) `Announcement`. `InternalUser` (1) --- (N) `Announcement` (작성자).
- **`SystemConfiguration`:** Key-Value 쌍이거나, 각 설정 그룹이 하나의 레코드가 될 수 있음.

------

**일반적인 제약 조건 고려사항:**

- **참조 무결성 (Referential Integrity):** 모든 FK 관계에 대해 `ON DELETE` 및 `ON UPDATE` 액션(예: `RESTRICT`, `CASCADE`, `SET NULL`, `SET DEFAULT`)을 신중하게 정의해야 합니다. 일반적으로 중요한 마스터 데이터는 `RESTRICT`를, 종속적인 상세 데이터는 `CASCADE`를 고려할 수 있습니다.
- **데이터 타입 및 길이:** 각 속성의 PostgreSQL 데이터 타입을 선정하고, 문자열의 경우 최대 길이를 적절히 지정합니다.
- **NULL 허용 여부:** 모든 속성에 대해 `NULL` 값 허용 여부(`NOT NULL` 제약)를 명확히 합니다.
- **기본값 (Default Values):** 특정 속성에 대해 기본값을 설정할 수 있습니다 (예: `isActive = true`).
- **CHECK 제약:** Enum과 유사한 역할을 하는 문자열 컬럼이나, 특정 범위의 값을 가져야 하는 숫자/날짜 컬럼에 대해 CHECK 제약을 사용하여 데이터 유효성을 강화합니다.

이처럼 각 엔티티와 그 관계, 제약조건을 상세히 정의하는 것은 데이터베이스의 안정성과 일관성을 확보하는 데 매우 중요합니다. 다음 단계로는 이 논리적 설계를 바탕으로 실제 PostgreSQL에 맞는 물리적 ERD를 그리고 DDL을 작성하는 과정이 될 것입니다.

이 내용에 대해 더 구체화하거나 특정 부분에 대한 질문이 있으시면 언제든지 말씀해주세요! 😊
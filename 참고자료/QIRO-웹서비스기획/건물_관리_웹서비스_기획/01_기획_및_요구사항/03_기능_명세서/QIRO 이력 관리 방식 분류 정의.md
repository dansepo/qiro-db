# 🗂️ QIRO 이력 관리 방식 분류 정의

## 1. 문서 정보
- **문서명:** QIRO 이력 관리 방식 분류 정의
- **프로젝트명:** QIRO (중소형 건물관리 SaaS) 프로젝트
- **작성일:** 2025년 06월 27일
- **최종 수정일:** 2025년 06월 27일
- **작성자:** QIRO 기획팀
- **검토자/승인자 (선택 사항):** (이름 또는 팀)
- **문서 버전:** 1.0

## 2. 개요
### 2.1. 문서 목적
본 문서는 QIRO 시스템에서 발생하는 다양한 데이터 변경 이력을 관리하기 위한 표준 방식을 정의한다. 데이터의 성격에 따라 **"기간 기반 이력 관리"**와 **"범용 감사 로그 관리"**로 이원화하여, 데이터의 추적성과 역사적 정합성을 모두 확보하는 것을 목적으로 한다. 이 가이드는 개발팀이 일관된 방식으로 이력 관리 기능을 구현하는 기준이 된다.

### 2.2. 이력 관리 방식 정의
#### A. 기간 기반 이력 관리 (Period-based History Management)
- **목적:** "과거 특정 시점에 A호실의 소유주는 누구였는가?" 와 같이, 시간이 지남에 따라 변하는 **'관계'나 '상태'의 과거 시점**을 명확히 조회하기 위함이다.
- **방법:** 변경 이력을 관리할 전용 테이블을 만들고, `시작일자`와 `종료일자` 같은 기간 정보를 사용하여 각 관계의 유효 기간을 명시적으로 기록한다. `종료일자`가 `NULL`이면 현재 유효한 관계임을 의미한다.
- **장점:** 특정 시점의 상태를 조회하는 쿼리가 매우 효율적이고 명확하다.

#### B. 범용 감사 로그 관리 (Generic Audit Log Management)
- **목적:** "언제, 누가, 어떤 데이터의, 어떤 필드를, 무엇에서 무엇으로 바꿨는가?" 와 같이, 데이터 레코드 내부의 **'속성값' 변경 자체를 추적**하기 위함이다.
- **방법:** 시스템의 모든 주요 변경 이벤트를 기록하는 단일 `audit_log` 테이블을 사용한다.
- **장점:** 시스템 전체의 모든 변경 사항을 한 곳에서 통합 관리할 수 있어 감사 및 문제 추적에 용이하다.

---

## 3. 모듈 및 데이터별 추천 이력 관리 방식 일람

| 관리 대상 (Item to Manage)                   | 이력 유형 (History Type) | 추천 관리 방식                              | 관련 테이블/엔티티 (Related Table(s))                        | 설명 및 이유                                                 |
| :------------------------------------------- | :----------------------- | :------------------------------------------ | :----------------------------------------------------------- | :----------------------------------------------------------- |
| **1. 호실의 소유주(임대인) 변경**            | **관계의 변경**          | **개별 이력 관리**<br/>(기간 기반)          | `unit_ownership_history`                                     | `ownership_start_date`, `ownership_end_date`로 소유 기간을 명시적으로 기록하여, 특정 시점의 소유주를 정확히 알 수 있습니다. |
| **2. 호실의 임차인 변경**                    | **관계의 변경**          | **개별 이력 관리**<br/>(기간 기반)          | `lease_contracts`                                            | `lease_contracts` 테이블 자체가 `unit_id`, `tenant_id`, `start_date`, `end_date`를 가지고 있어, 특정 기간 동안의 점유 이력을 완벽하게 표현하므로 별도의 이력 테이블이 필요 없습니다. |
| **3. 임대인의 정산 계좌번호 변경**           | **속성값의 변경**        | **범용 이력 관리**<br/>(감사 로그)          | `audit_log`, `lessor_bank_account`                           | `lessor_bank_account` 테이블의 특정 레코드(`account_id`) 내에서 `account_number` 필드의 변경 전/후 값을 `audit_log`에 기록합니다. |
| **4. 임대인/임차인 연락처 등 개인정보 변경** | **속성값의 변경**        | **범용 이력 관리**<br/>(감사 로그)          | `audit_log`, `lessors`, `tenant`                             | `lessors` 또는 `tenant` 테이블의 특정 레코드 내에서 `contact_number`, `email` 등 중요 필드의 변경 이력을 `audit_log`에 기록합니다. |
| **5. 임대 계약의 주요 조건 변경**            | **속성값의 변경**        | **범용 이력 관리**<br/>(감사 로그)          | `audit_log`, `lease_contract`                                | 계약서의 `rent_amount`, `deposit_amount`, `end_date` 등 민감한 조건이 수정될 경우, 그 이력을 `audit_log`에 상세히 남겨 추적합니다. (원칙적으로는 갱신 계약으로 처리 권장) |
| **6. 관리비 항목 마스터 변경**               | **속성값의 변경**        | **범용 이력 관리**<br/>(감사 로그)          | `audit_log`, `fee_item`                                      | `fee_item` 마스터 데이터의 `단가`, `부과 방식`, `부과 대상` 등 주요 설정이 변경될 때마다 그 이력을 `audit_log`에 기록하여 과거 관리비 산정의 근거를 보존합니다. |
| **7. 월별 관리비 데이터 수정**               | **속성값의 변경**        | **범용 이력 관리**<br/>(감사 로그)          | `audit_log`, `unit_monthly_meter_reading`, `unit_monthly_fee` 등 | 이미 입력된 `검침값`이나 자동 산정 후 `수동 조정된 금액` 등 월별 거래 데이터의 수정은 분쟁의 소지가 크므로, 모든 변경 이력을 `audit_log`에 반드시 기록합니다. |
| **8. 시설물 정보 변경**                      | **속성값의 변경**        | **범용 이력 관리**<br/>(감사 로그)          | `audit_log`, `facility`                                      | 시설물의 명칭, 위치, 점검 주기 등 주요 마스터 정보 변경 시 `audit_log`에 기록합니다. |
| **9. 시설물 점검 수행 이력**                 | **이벤트 기록**          | **개별 이력 관리**<br/>(자체 테이블이 이력) | `facility_inspection_record`                                 | 점검은 발생 시마다 하나의 레코드로 기록됩니다. 이 테이블 자체가 점검 '이벤트'의 이력이 되므로, `audit_log`는 이 레코드의 '수정/삭제' 시에만 기록합니다. |
| **10. 협력업체와의 계약 관계 변경**          | **관계의 변경**          | **개별 이력 관리**<br/>(기간 기반)          | `vendor_contract`                                            | `start_date`, `end_date`를 통해 특정 기간 동안 어떤 업체와 계약했는지 이력을 관리합니다. |
| **11. 민원 처리 과정 이력**                  | **이벤트 기록**          | **개별 이력 관리**<br/>(자체 테이블이 이력) | `complaint_history`                                          | 민원 접수, 담당자 배정, 상태 변경 등 모든 처리 과정이 하나의 레코드로 기록됩니다. 이 테이블 자체가 민원 처리 이력입니다. |
| **12. 회계 전표 수정/삭제**                  | **속성값/상태 변경**     | **범용 이력 관리**<br/>(감사 로그)          | `audit_log`, `journal_entry`                                 | 확정된 전표의 수정은 원칙적으로 금지되나, 예외적으로 수정 또는 취소 처리 시 `audit_log`에 상세한 기록을 남겨 회계 감사를 대비합니다. |
| **13. 사용자 계정 및 권한 변경**             | **관계 및 속성값 변경**  | **범용 이력 관리**<br/>(감사 로그)          | `audit_log`, `internal_user`, `user_role_link`               | 시스템 보안을 위해 직원 계정의 상태 변경(`활성`->`비활성`), 역할 변경 등 모든 관리자 활동을 `audit_log`에 기록합니다. |


## 4. 결론
QIRO 시스템의 이력 관리는 위 분류에 따라 두 가지 방식을 함께 적용합니다.

* **개별 이력 관리 (기간 기반):** 소유주, 임차인, 협력업체 등 **'관계'의 변화**를 추적하는 데 사용합니다.
* **범용 이력 관리 (감사 로그):** 그 외 모든 **중요 데이터의 '값' 변경**을 추적하는 데 사용합니다.

이러한 이원화된 이력 관리 전략은 시스템의 데이터 조회 성능과 감사 추적성을 모두 만족시키는 견고하고 확장 가능한 구조를 제공할 것입니다.
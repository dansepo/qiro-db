# 📢 QIRO - 알림 및 공지사항 관리 기능 명세서

## 1. 문서 정보
- **문서명:** QIRO - 알림 및 공지사항 관리 기능 명세서
- **기능 ID (선택 사항):** F-NOTICEMGMT-001 (Notification & Announcement Management)
- **관련 요구사항 ID:** (예: QIRO-FR-COMM-001 ~ QIRO-FR-COMM-010)
- **관련 사용자 스토리 ID:** (예: US-BM-XXX, US-SA-XXX, US-TENANT-XXX)
- **작성일:** 2025년 06월 03일
- **최종 수정일:** 2025년 06월 03일
- **작성자:** QIRO 기획팀
- **검토자/승인자 (선택 사항):** (이름 또는 팀)
- **문서 버전:** 1.0

## 2. 기능 개요
### 2.1. 목적
건물 관리자와 입주민/임대인 간의 정보 전달을 원활하게 하고, QIRO 시스템 내에서 발생하는 주요 이벤트(예: 계약 만료 임박, 관리비 미납, 시설 점검 예정 등)에 대한 자동 알림을 설정 및 발송하여 모든 이해관계자가 필요한 정보를 적시에 인지하고 대응할 수 있도록 지원한다. 이를 통해 관리 업무의 효율성을 높이고, 투명한 소통 환경을 조성하며, 사용자 만족도를 증진시킨다.

### 2.2. 설명
본 기능은 크게 두 가지로 구성된다:
1.  **공지사항 관리:** 관리자가 특정 대상(전체, 건물별, 그룹별 등)에게 일반 공지, 긴급 공지 등을 작성하고 게시(예약 게시 포함)하며, 게시된 공지사항을 관리(수정/삭제/이력조회)하는 기능.
2.  **시스템 알림 관리:** 시스템 내 특정 조건(이벤트) 발생 시, 사전에 정의된 대상에게 지정된 채널(이메일, SMS, 앱 푸시 등)로 자동 발송되는 알림의 유형, 내용(템플릿), 발송 조건, 대상 등을 설정하고 발송 이력을 관리하는 기능.

### 2.3. 범위
- **In-Scope (포함 범위):**
    - **공지사항 관리:**
        - 공지사항 CRUD (제목, 내용-텍스트 에디터 지원, 대상 지정, 게시 기간, 중요도, 첨부 파일).
        - 공지사항 목록 조회 (필터링 및 검색).
        - 예약 게시 기능.
    - **시스템 알림 관리:**
        - 주요 알림 유형 정의 및 관리 (예: 계약 만료 임박, 납부 마감일 도래, 미납 발생, 시설 점검 예정, 민원 상태 변경 등).
        - 알림 유형별 템플릿 관리 (제목/내용 템플릿, 변수 사용 지원).
        - 알림 유형별 발송 조건 및 수신 대상(역할/그룹) 설정.
        - 알림 발송 채널(이메일, SMS/LMS/알림톡 - 외부 연동) 설정 및 우선순위 관리.
    - **공통:**
        - 모든 공지/알림 발송 이력 조회 (대상, 내용, 채널, 발송 시간, 성공/실패 여부).
- **Out-of-Scope (제외 범위):**
    - 입주민/임대인용 포털에서의 공지사항 확인 및 알림 수신 설정 UI 자체 (본 명세서는 관리자용 설정 기능에 집중. 단, 수신 대상 정보는 연동).
    - SMS/LMS/알림톡 발송 서비스 자체 구축 (외부 전문 서비스 연동 방식).
    - 실시간 양방향 채팅 또는 문의 기능.
    - 앱 푸시 알림 서버 및 클라이언트 구현 상세 (본 명세서는 앱 푸시 발송 '요청'까지).

## 3. 사용자 인터페이스 (UI) 및 상호작용
### 3.1. 관련 화면
- `관리자 포털 > 소통 관리 > 공지사항 관리`
- `관리자 포털 > 시스템 설정 > 알림 설정 > 시스템 알림 관리`
- `관리자 포털 > 소통 관리 > 발송 이력 조회`

### 3.2. UI 요소별 상세 설명 (예시)
- **화면 1: 공지사항 관리 화면 (목록 및 등록/수정)**
    * **목록 뷰:**
        | UI 요소 ID (선택) | 요소명 (Label)              | 유형 (Type) | 기본값/표시 데이터 | 동작 설명                                                    |
        | :---------------- | :-------------------------- | :---------- | :----------------- | :----------------------------------------------------------- |
        | AN-LST-01         | [제목/내용] 검색            | 입력 필드   | -                  | 키워드 검색                                                  |
        | AN-LST-02         | [대상] 필터                 | 드롭다운    | 전체               | 전체, 특정 건물 등 대상별 필터링                             |
        | AN-LST-03         | [상태] 필터                 | 드롭다운    | 전체               | 게시중, 예약됨, 만료됨 등 상태별 필터링                      |
        | AN-LST-04         | `[+ 새 공지사항 작성]` 버튼 | 버튼        | -                  | '공지사항 작성 폼' 표시                                      |
        | AN-LST-05         | 공지사항 목록               | 표          | -                  | 제목, 대상, 게시 시작일, 게시 종료일, 작성자, 상태, (관리) 등을 표시 |
    * **작성/수정 폼 (모달 또는 페이지):**
        | UI 요소 ID (선택) | 요소명 (Label)                        | 유형 (Type)       | 예시/설명                                                    |
        | :---------------- | :------------------------------------ | :---------------- | :----------------------------------------------------------- |
        | AN-FRM-01         | 제목                                  | 입력 필드         |                                                              |
        | AN-FRM-02         | 내용                                  | Rich Text Editor  | (서식, 이미지 삽입 등 지원)                                  |
        | AN-FRM-03         | 대상 지정                             | 다중선택/드롭다운 | 전체, 특정 건물(목록), 특정 동(목록), 특정 사용자 그룹(임대인/임차인) 등 |
        | AN-FRM-04         | 게시 시작일시                         | 날짜/시간 선택    | (예약 게시 시)                                               |
        | AN-FRM-05         | 게시 종료일시                         | 날짜/시간 선택    | (미지정 시 계속 게시)                                        |
        | AN-FRM-06         | 중요도                                | 드롭다운/라디오   | 일반, 중요, 긴급 (긴급 시 상단 고정 또는 별도 알림 옵션)     |
        | AN-FRM-07         | 첨부 파일                             | 파일 업로드       | (다중 파일 업로드)                                           |
        | AN-FRM-08         | 발송 채널 선택(선택)                  | 체크박스 그룹     | QIRO 포털, 이메일, SMS 등 (공지사항 성격에 따라)             |
        | AN-FRM-09         | `[저장]`, `[예약]`, `[임시저장]` 버튼 | 버튼              |                                                              |

- **화면 2: 시스템 알림 설정 화면**
    * **알림 유형 목록:** 시스템에서 정의된 알림 유형들이 나열됨 (예: 계약 만료 30일 전 알림, 관리비 미납 1차 알림). 각 유형별로 설정 가능.
    * **유형별 설정 폼:**
        | UI 요소 ID (선택) | 요소명 (Label)       | 유형 (Type)             | 예시/설명                                                    |
        | :---------------- | :------------------- | :---------------------- | :----------------------------------------------------------- |
        | SN-CFG-01         | 알림 사용 여부       | 스위치/체크박스         | 해당 유형 알림 활성화/비활성화                               |
        | SN-CFG-02         | 기본 발송 채널       | 다중선택 체크박스       | 이메일, SMS, (앱푸시) - 사용자가 별도 설정 안했을 때 기본 발송 채널 |
        | SN-CFG-03         | 수신 대상            | 드롭다운/체크박스       | 관련 임차인, 관련 임대인, 담당 관리소장, 총괄관리자 등 역할 기반 선택 |
        | SN-CFG-04         | 발송 조건/시기       | (유형별 고정 또는 설정) | 예: "계약 만료일 30일 전 오전 10시", "미납 발생 후 3일 뒤"   |
        | SN-CFG-05         | **알림 템플릿 수정** | 버튼/링크               | 클릭 시 해당 알림 유형의 채널별(이메일/SMS) 템플릿 편집 모달 호출 |
    * **템플릿 편집 모달:**
        * 채널 선택 (이메일/SMS 등)
        * 제목 템플릿 입력 필드 (변수 사용 가능: 예: `{tenantName}`, `{buildingName}`, `{dueDate}`)
        * 본문 템플릿 입력 필드 (Rich Text 또는 Plain Text, 변수 사용 가능)
        * `[미리보기]`, `[저장]` 버튼

- **화면 3: 발송 이력 조회 화면**
    * **필터:** 기간, 발송 채널, 수신자, 알림 유형/공지사항 제목, 발송 상태(성공/실패) 등.
    * **목록 테이블:** 발송일시, 유형(공지/알림), 제목/내용 요약, 수신자, 채널, 발송 상태, (실패 시) 오류 메시지.

#### 3.3. 주요 사용자 시나리오 (흐름)
- **시나리오 1: 관리자가 중요 공지사항을 작성하고 즉시 게시 (특정 건물 대상)**
    1. 관리자가 '공지사항 관리' 화면에서 `[+ 새 공지사항 작성]` 버튼을 클릭한다.
    2. 제목, 내용, 중요도('긴급')를 입력하고, 대상 지정을 '특정 건물'로 선택 후 해당 건물을 지정한다.
    3. 게시 시작일시를 '즉시'(또는 현재 시간)로 설정하고, 발송 채널(예: QIRO 포털, 이메일)을 선택한다.
    4. `[저장 및 게시]` 버튼을 클릭한다.
    5. 시스템은 공지사항을 저장하고, 지정된 대상 건물 관련 사용자들에게 선택된 채널로 공지를 발송(또는 포털에 게시)한다. 발송 이력이 기록된다.
- **시나리오 2: 시스템 관리자가 '계약 만료 임박 알림' 설정 변경**
    1. 시스템 관리자가 '시스템 알림 설정' 화면으로 이동하여 "계약 만료 임박 알림" 유형을 선택한다.
    2. 현재 설정을 확인하고, '발송 조건/시기'를 "계약 만료일 60일, 30일, 7일 전 각 오전 9시"로 수정한다.
    3. '수신 대상'에 "관련 임대인"을 추가한다.
    4. '이메일 템플릿 수정'을 통해 임대인에게 발송될 메시지 내용을 일부 변경하고 저장한다.
    5. 최종적으로 변경된 알림 설정을 저장한다. 이후 시스템은 변경된 조건에 따라 자동으로 알림을 발송한다.
- **시나리오 3: 특정 기간의 SMS 발송 실패 이력 확인**
    1. 관리자가 '발송 이력 조회' 화면으로 이동한다.
    2. 필터에서 '기간'을 최근 1주일로, '발송 채널'을 'SMS'로, '발송 상태'를 '실패'로 설정하고 조회한다.
    3. 시스템은 해당 조건의 SMS 발송 실패 목록과 실패 사유를 표시한다.

### 4. 데이터 요구사항
#### 4.1. 입력 데이터
- **공지사항:** 제목, 내용, 대상(전체/건물ID/그룹ID/사용자ID), 게시 시작/종료일시, 중요도 코드, 첨부 파일 정보, 발송 채널.
- **시스템 알림 설정:** 알림 유형 코드, 활성화 여부, 기본 발송 채널, 수신 대상 역할/그룹, 발송 조건/규칙.
- **알림 템플릿:** 템플릿 ID, 알림 유형 코드, 채널 코드, 제목/본문 템플릿 문자열.

#### 4.2. 출력 데이터
- 공지사항 목록 및 상세 내용.
- 시스템 알림 설정 현황.
- 발송 이력 목록 (상세 내용 포함).

#### 4.3. 주요 엔티티 속성 (예시)
- **`Announcement` (공지사항)**
    | 속성명                         | 데이터 타입       | 필수 | 설명                                                         |
    | :----------------------------- | :---------------- | :--- | :----------------------------------------------------------- |
    | `announcementId`               | UUID/Long (PK)    | Y    | 공지사항 고유 ID                                             |
    | `title`                        | String            | Y    | 제목                                                         |
    | `content`                      | Text              | Y    | 내용 (HTML 또는 Markdown 저장 가능)                          |
    | `targetType`                   | Enum/String       | Y    | 대상 유형 (`ALL`, `BUILDING`, `USER_GROUP`, `INDIVIDUAL_USER`) |
    | `targetIdentifiers`            | JSON/List<String> | Y    | 대상 식별자 목록 (예: 빌딩ID 목록, 유저ID 목록)              |
    | `startDateTime`                | DateTime          | Y    | 게시 시작 일시                                               |
    | `endDateTime`                  | DateTime          | N    | 게시 종료 일시 (null이면 계속 게시)                          |
    | `importance`                   | Enum/String       | Y    | 중요도 (`NORMAL`, `IMPORTANT`, `URGENT`)                     |
    | `status`                       | Enum/String       | Y    | 상태 (`DRAFT`, `SCHEDULED`, `PUBLISHED`, `EXPIRED`)          |
    | `attachments`                  | JSON/Array        | N    | 첨부 파일 정보 (파일명, S3 경로 등)                          |
    | ... (작성자, 생성/수정일시 등) |                   |      |                                                              |

- **`SystemNotificationSetting` (시스템 알림 설정)**
    | 속성명             | 데이터 타입       | 필수 | 설명                                       |
    | :----------------- | :---------------- | :--- | :----------------------------------------- |
    | `notificationType` | String (PK)       | Y    | 알림 유형 코드 (예: `CONTRACT_EXPIRY_30D`) |
    | `isEnabled`        | Boolean           | Y    | 해당 알림 사용 여부                        |
    | `defaultChannels`  | JSON/List<String> | Y    | 기본 발송 채널 목록 (예: `EMAIL`, `SMS`)   |
    | `recipientRoles`   | JSON/List<String> | Y    | 기본 수신 대상 역할 목록                   |
    | `triggerCondition` | String/JSON       | Y    | 발송 조건/규칙 (예: "endDate - 30 days")   |
    | ... (수정일시 등)  |                   |      |                                            |

- **`NotificationTemplate` (알림 템플릿)**
    | 속성명                 | 데이터 타입    | 필수 | 설명                                          |
    | :--------------------- | :------------- | :--- | :-------------------------------------------- |
    | `templateId`           | UUID/Long (PK) | Y    | 템플릿 고유 ID                                |
    | `notificationType`     | String (FK)    | Y    | 관련 알림 유형 코드                           |
    | `channelType`          | String (Enum)  | Y    | 발송 채널 (`EMAIL`, `SMS`, `APP_PUSH`)        |
    | `subjectTemplate`      | String         | Y    | 제목 템플릿 (변수 사용: `{userName}`)         |
    | `bodyTemplate`         | Text           | Y    | 본문 템플릿 (HTML 또는 Plain Text, 변수 사용) |
    | ... (생성/수정일시 등) |                |      |                                               |

- **`NotificationLog` (발송 이력)**
    | 속성명             | 데이터 타입    | 필수 | 설명                                       |
    | :----------------- | :------------- | :--- | :----------------------------------------- |
    | `logId`            | UUID/Long (PK) | Y    | 발송 이력 고유 ID                          |
    | `notificationType` | String         | Y    | 발송된 알림/공지 유형                      |
    | `recipientInfo`    | String         | Y    | 수신자 정보 (예: userId, email, phone)     |
    | `channelType`      | String (Enum)  | Y    | 실제 발송된 채널                           |
    | `subject`          | String         | Y    | 발송된 제목 (템플릿 적용 후)               |
    | `content`          | Text           | Y    | 발송된 내용 (템플릿 적용 후)               |
    | `sentDateTime`     | DateTime       | Y    | 발송 시도 일시                             |
    | `status`           | String (Enum)  | Y    | 발송 상태 (`SUCCESS`, `FAILED`, `PENDING`) |
    | `errorMessage`     | Text           | N    | (실패 시) 오류 메시지                      |
    | ... (관련 ID 등)   |                |      |                                            |

### 5. 처리 로직 및 비즈니스 규칙
- **R-NOTICE-001 (공지사항 게시 기간):** 현재 시간이 `startDateTime`과 `endDateTime` 사이인 `PUBLISHED` 상태의 공지사항만 사용자에게 노출된다. `endDateTime`이 지나면 자동으로 `EXPIRED` 상태로 변경될 수 있다.
- **R-NOTICE-002 (공지사항 대상 필터링):** 공지사항 발송/표시 시, `targetType`과 `targetIdentifiers`를 기준으로 정확한 대상에게만 전달되어야 한다.
- **R-NOTICE-003 (예약 발송/게시):** `startDateTime`이 미래로 설정된 공지사항은 해당 시간이 되면 시스템 스케줄러에 의해 자동으로 `PUBLISHED` 상태로 변경되고 발송/게시 작업이 트리거된다.
- **R-NOTICE-004 (시스템 알림 자동 발송):** 시스템은 각 `SystemNotificationSetting`의 `triggerCondition`을 주기적으로 또는 이벤트 기반으로 확인하여, 조건 충족 시 해당 `notificationType`의 활성화된 템플릿을 사용하여 지정된 `recipientRoles`에게 알림을 자동 발송한다.
- **R-NOTICE-005 (템플릿 변수 치환):** 알림/공지 발송 시, 템플릿 내의 변수(예: `{userName}`, `{buildingName}`, `{dueDate}` 등)는 실제 해당 데이터로 정확히 치환되어야 한다.
- **R-NOTICE-006 (발송 채널 처리):** 각 발송 채널(이메일, SMS 등)별로 외부 연동 API 호출 및 결과 처리가 이루어져야 한다. SMS/LMS의 경우 글자 수에 따른 자동 구분 발송 또는 제한이 필요할 수 있다.
- **R-NOTICE-007 (수신 거부 처리 - 선택적):** 사용자가 특정 유형의 알림 수신을 거부한 경우(별도 수신 설정 기능 필요), 해당 알림은 발송 대상에서 제외되어야 한다.

### 6. 오류 처리 및 예외 관리
| 오류 코드 (선택) | 발생 조건                               | 오류 메시지 (User-facing)                                    |
| :--------------- | :-------------------------------------- | :----------------------------------------------------------- |
| E-NOTICE-01      | 공지사항 필수 입력 항목 누락            | "[필드명]은(는) 필수 입력 항목입니다."                       |
| E-NOTICE-02      | 유효하지 않은 대상 지정                 | "공지사항 대상을 올바르게 지정해주세요."                     |
| E-NOTICE-03      | 알림 템플릿 저장 시 변수 형식 오류      | "템플릿 내 사용된 변수 형식이 올바르지 않습니다: [{변수명}]" |
| E-NOTICE-04      | 외부 발송 서비스(SMS/이메일) 연동 실패  | "알림 발송 중 외부 서비스 연동에 실패했습니다. 잠시 후 다시 시도해주세요." |
| E-NOTICE-05      | 수신자 정보(연락처) 누락 또는 형식 오류 | "알림을 발송할 수신자의 연락처 정보가 유효하지 않습니다."    |

### 7. (기능별) 성능 요구사항
- P-NOTICE-01: 공지사항 목록 조회 (1,000건 기준) 시 2초 이내 응답.
- P-NOTICE-02: 단일 공지사항/알림 발송 처리 시간 1초 이내 (외부 서비스 응답 시간 제외).
- P-NOTICE-03: 대량 알림(예: 1,000명 대상) 발송 시, 발송 작업은 백그라운드로 N분 이내 완료되어야 하며, 시스템 성능에 영향을 주지 않아야 한다.
- P-NOTICE-04: 발송 이력 조회 (10만 건 기준, 필터 적용) 시 3초 이내 응답.

### 8. (기능별) 보안 요구사항
- S-NOTICE-01: 공지사항 작성/수정/삭제 및 시스템 알림 설정 변경은 인가된 관리자 역할만 수행 가능하다.
- S-NOTICE-02: 알림 내용에 개인정보가 포함될 경우, 해당 정보는 안전하게 처리(암호화 등)되어야 하며, 발송 대상자에게만 전달되어야 한다.
- S-NOTICE-03: 첨부 파일 업로드 시 악성코드 검사 및 파일 형식/크기 제한을 적용한다.
- S-NOTICE-04: 알림 발송 실패 시, 실패 사유에 민감한 시스템 정보가 노출되지 않도록 한다.

### 9. 다른 기능/모듈과의 연관성
- **모든 주요 관리 모듈 (임대 계약, 관리비, 시설, 민원 등):** 시스템 알림의 트리거가 되는 이벤트(예: 계약 만료 임박, 미납 발생, 시설 점검일 도래, 민원 상태 변경)를 제공한다.
- **사용자 관리 (내부 직원, 임차인, 임대인):** 공지사항 및 알림의 발송 대상자 정보(역할, 그룹, 이메일, 휴대폰 번호 등)를 제공받는다.
- **외부 연동 서비스:** SMS/LMS/알림톡 발송, 이메일 발송을 위해 외부 게이트웨이 또는 서비스와 연동된다.
- **파일 스토리지 (S3 등):** 공지사항 첨부 파일 저장을 위해 연동된다.

### 10. (선택 사항) 테스트 고려 사항
- 다양한 대상 지정(전체, 특정 건물, 그룹 등)에 대한 공지사항 발송 정확성 테스트.
- 예약 게시 기능의 정확한 시간에 게시되는지 테스트.
- 모든 시스템 알림 유형별 발송 조건 및 템플릿 변수 치환 정확성 테스트.
- 각 발송 채널(이메일, SMS 등)별 실제 발송 성공/실패 및 이력 기록 테스트.
- 대량 알림 발송 시 성능 및 안정성 테스트.
- 수신 거부 설정에 따른 알림 제외 로직 테스트 (구현 시).
- 첨부 파일 관리(업로드, 다운로드) 기능 테스트.

### 11. 용어 정의 (선택 사항)
- **공지사항 (Announcement):** 관리자가 특정 또는 전체 대상에게 전달하는 정보성 메시지.
- **시스템 알림 (System Notification):** 특정 이벤트 발생 시 시스템이 자동으로 생성하여 관련자에게 전달하는 메시지.
- **알림 템플릿 (Notification Template):** 알림 메시지의 표준 형식으로, 변수를 사용하여 개인화된 내용을 구성할 수 있음.
- **발송 채널 (Delivery Channel):** 알림이나 공지사항이 전달되는 수단 (예: 이메일, SMS, 앱 푸시, QIRO 포털 내 알림).

### 12. 문서 이력
| 버전 | 날짜             | 작성자      | 주요 변경 내용      |
| :--- | :--------------- | :---------- | :------------------ |
| 1.0  | 2025년 06월 03일 | QIRO 기획팀 | 초기 명세서 안 작성 |

---
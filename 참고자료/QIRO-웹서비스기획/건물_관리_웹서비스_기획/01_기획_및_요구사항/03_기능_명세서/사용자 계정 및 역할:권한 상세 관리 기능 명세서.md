# 👤 QIRO - 사용자 계정 및 역할/권한 상세 관리 기능 명세서

## 1. 문서 정보
- **문서명:** QIRO - 사용자 계정 및 역할/권한 상세 관리 기능 명세서
- **기능 ID (선택 사항):** F-USERROLEMGMT-001 (User, Role & Permission Management)
- **관련 요구사항 ID:** (예: QIRO-FR-SEC-010, QIRO-FR-ADMIN-001)
- **관련 사용자 스토리 ID:** (예: US-SA-XXX)
- **작성일:** 2025년 06월 03일
- **최종 수정일:** 2025년 06월 03일
- **작성자:** QIRO 기획팀
- **검토자/승인자 (선택 사항):** (이름 또는 팀)
- **문서 버전:** 1.0

## 2. 기능 개요
### 2.1. 목적
QIRO 시스템을 사용하는 건물 관리 회사 또는 사업장의 내부 직원(총괄관리자, 관리소장, 경리 담당자, 시설 담당자 등)에 대한 사용자 계정을 안전하고 효율적으로 관리한다. 또한, 직원의 업무 범위에 따라 역할을 정의하고 각 역할에 시스템 기능 및 데이터 접근 권한을 세밀하게 부여하여, 최소 권한 원칙을 준수하고 정보 보안을 강화하며 업무 분장을 명확히 한다.

### 2.2. 설명
본 기능은 시스템 관리자(주로 총괄관리자)가 내부 직원의 사용자 계정을 생성, 조회, 수정, 비활성화/활성화하고, 비밀번호를 재설정하는 등의 계정 관리 기능을 제공한다. 또한, 시스템에 사전 정의된 역할(예: 관리소장, 경리) 외에 필요시 커스텀 역할을 생성하고, 각 역할별로 접근 가능한 메뉴, 기능 수행(읽기, 쓰기, 수정, 삭제 등), 데이터 범위 등을 설정할 수 있는 권한 관리 인터페이스를 포함한다. 사용자에게 하나 이상의 역할을 부여하여 최종 권한을 결정한다.

### 2.3. 범위
- **In-Scope (포함 범위):**
    - **내부 사용자(직원) 계정 관리:**
        - 계정 생성 (초대 또는 직접 등록 방식): 이름, 이메일(ID), 초기 비밀번호 설정 방식, 소속 부서, 담당 건물(들) 지정 등.
        - 계정 목록 조회 (검색 및 필터링: 이름, 이메일, 역할, 상태 등).
        - 계정 상세 정보 조회 및 수정.
        - 계정 상태 관리 (`활성`, `비활성`, `잠김`).
        - (관리자에 의한) 사용자 비밀번호 강제 재설정.
        - (관리자에 의한) 사용자 MFA(2단계 인증) 설정 초기화/강제 해제.
    - **역할 관리 (Role Management):**
        - 시스템 기본 제공 역할 목록 조회 (예: 총괄관리자, 관리소장, 경리, 시설담당).
        - (선택적 고급 기능) 커스텀 역할 생성, 수정, 삭제 기능.
        - 역할별 설명 및 부여된 권한 목록 조회.
    - **권한 관리 (Permission Management) 및 역할-권한 매핑:**
        - 시스템 내 정의된 세분화된 권한 목록(예: `건물정보:조회`, `관리비:생성`) 조회.
        - 역할 편집 화면에서 해당 역할에 부여할 권한들을 선택(체크박스 트리 등)하여 매핑.
    - **사용자-역할 매핑:**
        - 사용자 계정 생성/수정 시 해당 사용자에게 하나 이상의 역할 할당.
- **Out-of-Scope (제외 범위):**
    - 임대인/임차인 계정 관리 (이는 각 "임대인 관리", "임차인 관리" 또는 별도 "입주민 포털 사용자 관리"에서 다룸).
    - SSO(Single Sign-On) 또는 외부 ID 공급자(IdP) 연동 (초기 버전 제외, 향후 확장 고려).
    - 권한 자체(Permission)의 CRUD (권한 목록은 주로 시스템 개발 시 정의되고, 관리자는 역할을 통해 이들을 조합하여 사용).

## 3. 사용자 인터페이스 (UI) 및 상호작용
### 3.1. 관련 화면
- `관리자 포털 > 시스템 설정 > 사용자 및 권한 관리`
    - `사용자(직원) 계정 관리` 탭/메뉴
    - `역할 및 권한 관리` 탭/메뉴

### 3.2. UI 요소별 상세 설명 (예시)
- **화면 1: 사용자(직원) 계정 관리 화면**
    | UI 요소 ID (선택) | 요소명 (Label)            | 유형 (Type) | 기본값/표시 데이터 | 동작 설명                                                    | 비고                            |
    | :---------------- | :------------------------ | :---------- | :----------------- | :----------------------------------------------------------- | :------------------------------ |
    | UAM-LST-01        | [이름/이메일] 검색        | 입력 필드   | -                  | 직원 이름 또는 이메일로 검색                                 |                                 |
    | UAM-LST-02        | [역할] 필터               | 드롭다운    | 전체               | 특정 역할을 가진 직원만 필터링                               |                                 |
    | UAM-LST-03        | [상태] 필터               | 드롭다운    | 전체               | 활성, 비활성, 잠김 등 상태별 필터링                          |                                 |
    | UAM-LST-04        | `[+ 직원 계정 추가]` 버튼 | 버튼        | -                  | '직원 계정 등록 폼' 화면/모달 호출                           |                                 |
    | UAM-LST-05        | 직원 계정 목록            | 표          | -                  | ID(이메일), 이름, 역할(들), 담당 건물(요약), 상태, 최근 접속일, (관리) 등을 표시 | 정렬, 클릭 시 상세/수정 폼 이동 |
    | (표 내부)         | [수정] 버튼               | 버튼/아이콘 | -                  | 해당 직원 계정 수정 폼 호출                                  |                                 |
    | (표 내부)         | [상태변경] 드롭다운       | 드롭다운    | (현재 상태)        | 활성/비활성/잠금해제 등 상태 변경                            |                                 |
    | (표 내부)         | [비밀번호 재설정] 버튼    | 버튼/아이콘 | -                  | 관리자 강제 비밀번호 재설정 기능 실행                        |                                 |

- **화면 2: 직원 계정 등록/수정 폼 (모달 또는 페이지)**
    | UI 요소 ID (선택) | 요소명 (Label)            | 유형 (Type)                      | 예시/설명                                                   | 유효성 규칙/제약조건                               |
    | :---------------- | :------------------------ | :------------------------------- | :---------------------------------------------------------- | :------------------------------------------------- |
    | UAM-FRM-01        | 이메일 주소 (ID)          | 입력 필드                        | (로그인 ID로 사용)                                          | 필수, 이메일 형식, 시스템 내 고유                  |
    | UAM-FRM-02        | 이름                      | 입력 필드                        |                                                             | 필수, 최대 30자                                    |
    | UAM-FRM-03        | 초기 비밀번호 설정        | 라디오/옵션                      | 시스템 자동 생성 후 이메일 발송 / 관리자 직접 입력 후 전달  | (등록 시에만)                                      |
    | UAM-FRM-04        | 비밀번호 (직접 입력시)    | 입력 필드 (비밀번호)             |                                                             | (초기 설정 및 관리자 재설정 시) 비밀번호 정책 준수 |
    | UAM-FRM-05        | 비밀번호 확인             | 입력 필드 (비밀번호)             |                                                             | (위와 동일)                                        |
    | UAM-FRM-06        | 소속 부서 (선택)          | 입력 필드/드롭다운               |                                                             |                                                    |
    | UAM-FRM-07        | **역할 할당**             | 다중 선택 드롭다운/체크박스 목록 | 시스템에 정의된 역할 목록(총괄관리자, 관리소장 등)에서 선택 | 최소 1개 이상 역할 필수                            |
    | UAM-FRM-08        | **담당 건물 지정** (선택) | 건물 선택 (다중 가능)            | 시스템에 등록된 건물 목록에서 담당할 건물(들) 선택          | (관리소장 등 특정 역할에 필요할 수 있음)           |
    | UAM-FRM-09        | 계정 상태                 | 드롭다운/라디오                  | 활성, 비활성 (수정 시에만 표시)                             |                                                    |
    | UAM-FRM-10        | [저장], [취소] 버튼       | 버튼                             |                                                             |                                                    |

- **화면 3: 역할 및 권한 관리 화면**
    * **영역 1: 역할 목록**
        * 시스템 기본 역할 및 커스텀 역할 목록 표시 (역할명, 설명, (수정/삭제 버튼 - 커스텀 역할만)).
        * `[+ 신규 역할 생성]` 버튼 (커스텀 역할 생성 기능 활성화 시).
    * **영역 2: 역할별 권한 설정 (역할 목록에서 특정 역할 선택 시)**
        * 선택된 역할명, 설명 표시 (및 수정 가능 - 커스텀 역할).
        * 권한 목록 트리 또는 카테고리별 체크박스 목록 표시 (예: 건물관리 - 조회/생성/수정/삭제, 관리비 - 조회/산정/고지 등).
        * 관리자가 각 권한 항목을 체크하여 해당 역할에 부여/해제.
        * `[권한 저장]` 버튼.

#### 3.3. 주요 사용자 시나리오 (흐름)
- **시나리오 1: 신규 직원(예: 관리소장) 계정 생성**
    1. 총괄관리자가 '사용자(직원) 계정 관리' 화면에서 `[+ 직원 계정 추가]` 버튼을 클릭한다.
    2. '직원 계정 등록 폼'에 신규 직원의 이메일, 이름 등 기본 정보를 입력한다.
    3. '역할 할당'에서 "관리소장" 역할을 선택한다.
    4. '담당 건물 지정'에서 해당 관리소장이 담당할 건물(들)을 선택한다.
    5. 초기 비밀번호 설정 방식을 선택하고 [저장] 버튼을 클릭한다.
    6. 시스템은 새 계정을 생성하고, "직원 계정이 성공적으로 생성되었습니다." 메시지를 표시한다. (선택한 방식에 따라 신규 직원에게 계정 정보 안내)
- **시나리오 2: 기존 직원의 역할 변경 (예: 일반 직원 -> 경리 담당)**
    1. 총괄관리자가 목록에서 해당 직원을 찾아 [수정] 버튼을 클릭한다.
    2. '직원 계정 수정 폼'의 '역할 할당'에서 기존 역할을 해제하고 "경리" 역할을 새로 선택한다.
    3. [저장] 버튼을 클릭하면, 직원의 역할 및 시스템 접근 권한이 변경된다.
- **시나리오 3: (커스텀 역할 기능 사용 시) 신규 커스텀 역할 생성 및 권한 부여**
    1. 총괄관리자가 '역할 및 권한 관리' 화면에서 `[+ 신규 역할 생성]` 버튼을 클릭한다.
    2. 역할명(예: "임시 데이터 입력 담당"), 설명을 입력하고 저장한다.
    3. 생성된 역할을 선택하고, '역할별 권한 설정' 영역에서 해당 역할에게 필요한 최소한의 기능 접근 권한(예: 특정 메뉴 조회, 특정 데이터 입력)만 선택하여 부여한다.
    4. `[권한 저장]` 버튼을 클릭한다. 이후 이 커스텀 역할을 직원에게 할당할 수 있다.

### 4. 데이터 요구사항
#### 4.1. 입력 데이터
- 직원 계정 정보: 이메일, 이름, 비밀번호(초기/재설정), 소속 부서, 담당 건물 ID 목록, 할당된 역할 ID 목록, 계정 상태.
- 역할 정보: 역할명, 설명.
- 권한 매핑 정보: 역할 ID, 해당 역할에 부여된 권한 ID 목록.

#### 4.2. 출력 데이터
- 직원 계정 목록 및 상세 정보.
- 역할 목록 및 상세 정보 (부여된 권한 포함).
- (내부용) 시스템에 정의된 전체 권한 목록.

#### 4.3. 주요 엔티티 속성 (예시)
- **`InternalUser` (내부 사용자/직원)**
    | 속성명                 | 데이터 타입    | 필수 | 설명                                       |
    | :--------------------- | :------------- | :--- | :----------------------------------------- |
    | `userId`               | UUID/Long (PK) | Y    | 사용자 고유 ID                             |
    | `email`                | String         | Y    | 이메일 주소 (로그인 ID)                    |
    | `passwordHash`         | String         | Y    | 해시된 비밀번호                            |
    | `name`                 | String         | Y    | 이름                                       |
    | `department`           | String         | N    | 소속 부서                                  |
    | `status`               | Enum/String    | Y    | 계정 상태 (`ACTIVE`, `INACTIVE`, `LOCKED`) |
    | `mfaEnabled`           | Boolean        | Y    | MFA(2단계인증) 사용 여부 (기본값 `false`)  |
    | ... (생성/수정일시 등) |                |      |                                            |

- **`Role` (역할)**
    | 속성명         | 데이터 타입    | 필수 | 설명                                                       |
    | :------------- | :------------- | :--- | :--------------------------------------------------------- |
    | `roleId`       | UUID/Long (PK) | Y    | 역할 고유 ID                                               |
    | `roleName`     | String         | Y    | 역할명 (예: "SuperAdmin", "BuildingManager", "Accountant") |
    | `description`  | String         | N    | 역할 설명                                                  |
    | `isSystemRole` | Boolean        | Y    | 시스템 기본 제공 역할 여부 (삭제/주요 변경 불가)           |

- **`Permission` (권한 - 주로 시스템에 사전 정의된 마스터 데이터)**
    | 속성명          | 데이터 타입    | 필수 | 설명                                             |
    | :-------------- | :------------- | :--- | :----------------------------------------------- |
    | `permissionId`  | UUID/Long (PK) | Y    | 권한 고유 ID                                     |
    | `permissionKey` | String         | Y    | 권한 식별 키 (예: `building:read`, `fee:create`) |
    | `description`   | String         | N    | 권한 설명                                        |
    | `category`      | String         | N    | 권한 그룹/카테고리 (예: "건물관리", "관리비")    |

- **`UserRoleLink` (사용자-역할 매핑, Many-to-Many)**
    | 속성명   | 데이터 타입    | 필수 | 설명      |
    | :------- | :------------- | :--- | :-------- |
    | `userId` | UUID/Long (FK) | Y    | 사용자 ID |
    | `roleId` | UUID/Long (FK) | Y    | 역할 ID   |

- **`RolePermissionLink` (역할-권한 매핑, Many-to-Many)**
    | 속성명         | 데이터 타입    | 필수 | 설명    |
    | :------------- | :------------- | :--- | :------ |
    | `roleId`       | UUID/Long (FK) | Y    | 역할 ID |
    | `permissionId` | UUID/Long (FK) | Y    | 권한 ID |

- **`UserBuildingAccess` (사용자-담당건물 매핑, Many-to-Many - 선택적, 역할에 따라 필요)**
    | 속성명       | 데이터 타입    | 필수 | 설명      |
    | :----------- | :------------- | :--- | :-------- |
    | `userId`     | UUID/Long (FK) | Y    | 사용자 ID |
    | `buildingId` | UUID/Long (FK) | Y    | 건물 ID   |

### 5. 처리 로직 및 비즈니스 규칙
- **R-URM-001 (최소 권한 원칙):** 사용자는 업무 수행에 필요한 최소한의 권한만 가져야 한다.
- **R-URM-002 (역할 기반 권한 상속):** 사용자는 할당된 모든 역할이 가진 권한들의 합집합을 최종 권한으로 가진다.
- **R-URM-003 (총괄관리자 역할):** '총괄관리자' 역할은 시스템의 모든 기능에 접근할 수 있는 최상위 권한을 가지며, 이 역할의 권한은 수정/삭제할 수 없다.
- **R-URM-004 (시스템 기본 역할):** 시스템에서 기본으로 제공하는 역할(관리소장, 경리 등)은 삭제할 수 없으며, 권한 변경도 제한될 수 있다 (정책에 따라).
- **R-URM-005 (계정 고유성):** 사용자 이메일(로그인 ID)은 시스템 전체에서 고유해야 한다.
- **R-URM-006 (비밀번호 정책 강제):** 새 계정 생성 또는 비밀번호 재설정 시, "보안 요구사항 및 정책"에 정의된 비밀번호 정책(복잡도, 길이 등)을 강제한다.
- **R-URM-007 (계정 상태 관리):** 퇴사자 계정은 즉시 '비활성' 처리한다. 로그인 연속 실패 시 '잠김' 처리하고, 관리자만 해제할 수 있다.

### 6. 오류 처리 및 예외 관리
| 오류 코드 (선택) | 발생 조건                                   | 오류 메시지 (User-facing)                           |
| :--------------- | :------------------------------------------ | :-------------------------------------------------- |
| E-URM-01         | 필수 입력 항목(이메일, 이름, 역할 등) 누락  | "[필드명]은(는) 필수 입력 항목입니다."              |
| E-URM-02         | 이메일 형식 오류 또는 이미 사용 중인 이메일 | "유효하지 않거나 이미 사용 중인 이메일 주소입니다." |
| E-URM-03         | 비밀번호 정책 위반                          | "비밀번호는 [정책 상세]를 만족해야 합니다."         |
| E-URM-04         | 존재하지 않는 역할/건물 등을 지정 시도      | "선택한 [역할/건물] 정보가 유효하지 않습니다."      |
| E-URM-05         | 시스템 역할 수정/삭제 시도                  | "시스템 기본 역할은 수정하거나 삭제할 수 없습니다." |

### 7. (기능별) 성능 요구사항
- P-URM-01: 직원 계정 목록(100명 기준) 조회 시 2초 이내 응답.
- P-URM-02: 사용자 계정/역할 정보 저장(생성/수정) 시 1초 이내 처리 완료.
- P-URM-03: 특정 사용자의 최종 권한 계산(로그인 시 또는 API 요청 시)은 빠르게 수행되어야 함 (예: 100ms 이내).

### 8. (기능별) 보안 요구사항
- S-URM-01: 사용자 계정 및 역할/권한 관리 기능은 오직 '총괄관리자' 또는 이에 준하는 최상위 관리 권한을 가진 역할만 접근 및 수정 가능하다.
- S-URM-02: 사용자 비밀번호는 안전한 단방향 해시 함수(Salt 포함)를 사용하여 저장한다.
- S-URM-03: 모든 계정 관리 활동(생성, 수정, 삭제, 상태 변경, 권한 변경 등)은 상세한 감사 로그로 기록되어야 한다 (작업자, 대상, 시간, 변경 내용).
- S-URM-04: MFA 설정/해제 등 민감한 작업 시 추가 인증을 요구할 수 있다.

### 9. 다른 기능/모듈과의 연관성
- **인증 및 권한 관리 설계:** 본 기능은 시스템의 전반적인 "인증 및 권한 관리 설계"에서 정의된 정책과 메커니즘을 관리자가 설정하고 운영하는 사용자 인터페이스를 제공한다.
- **QIRO 서비스의 모든 기능:** 본 기능에서 설정된 사용자별 역할과 권한은 QIRO 서비스 내 모든 기능의 접근 가능 여부 및 데이터 조회/수정 범위를 결정하는 기준이 된다.
- **감사 로그:** 모든 관리 행위는 감사 로그 시스템에 기록되어 추적성을 보장한다.

### 10. (선택 사항) 테스트 고려 사항
- 다양한 역할 조합을 가진 사용자 생성 및 각 역할별 권한 정상 동작 여부 테스트.
- 시스템 기본 역할 및 커스텀 역할 생성/수정/삭제 시나리오 테스트.
- 권한 매핑 변경 시 해당 역할의 사용자에게 즉시(또는 다음 로그인 시) 반영되는지 확인.
- 계정 상태 변경(활성, 비활성, 잠금)에 따른 로그인 및 기능 접근 제한 테스트.
- 비밀번호 정책 및 MFA 관련 설정/동작 테스트.
- 최소 권한 원칙이 각 역할에 맞게 잘 적용되었는지 검증.

### 11. 용어 정의 (선택 사항)
- **내부 사용자 (Internal User):** QIRO 시스템을 운영/관리하는 건물 관리 회사 또는 사업장의 직원.
- **역할 (Role):** 특정 직무 또는 책임에 따라 그룹화된 권한의 집합. (예: 관리소장, 경리담당)
- **권한 (Permission):** 시스템 내 특정 기능 또는 데이터에 대해 수행할 수 있는 작업(읽기, 쓰기, 삭제 등)에 대한 허가.
- **RBAC (Role-Based Access Control):** 역할 기반 접근 제어. 사용자에게 직접 권한을 부여하는 대신 역할을 부여하고, 역할에 권한을 할당하는 방식.

### 12. 문서 이력
| 버전 | 날짜             | 작성자      | 주요 변경 내용      |
| :--- | :--------------- | :---------- | :------------------ |
| 1.0  | 2025년 06월 03일 | QIRO 기획팀 | 초기 명세서 안 작성 |

---
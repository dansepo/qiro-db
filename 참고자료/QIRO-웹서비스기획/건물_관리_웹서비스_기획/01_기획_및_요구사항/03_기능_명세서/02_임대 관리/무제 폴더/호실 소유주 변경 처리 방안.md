# **호실 소유주 변경 처리 방안**

### **1. 문서 개요**

본 문서는 건물 관리 시스템에서 매매, 증여 등으로 인해 **특정 호실의 소유주(임대인)가 변경**되었을 때, 데이터의 정합성을 유지하며 소유권 이전 내역을 정확하게 관리하는 시스템 설계 및 업무 처리 방안을 정의합니다.

### **2. 핵심 원칙: "이력 추적 및 유효일자 기반 관리"**

소유주 변경을 처리하는 데 있어 가장 중요한 원칙은 다음과 같습니다.

1. **비파괴적 이력 관리 (Non-Destructive History):** 과거의 소유주 기록을 덮어쓰거나 삭제하지 않습니다. 모든 소유권 변경은 새로운 이력으로 누적되어, 언제든 과거의 소유주를 추적할 수 있어야 합니다.
2. **유효일자(Effective Date) 기준:** 소유권 변경은 즉시 모든 과거에 영향을 미치는 것이 아니라, 계약서상의 명의 이전일 등 **특정 '유효일자'**를 기준으로 적용되어야 합니다.

### **3. 데이터베이스 설계 변경 제안**

이러한 이력 관리를 위해, 기존 `bms.units` 테이블의 `owner_id`를 직접 사용하는 대신, **소유권 이력을 전담하는 새로운 테이블을 도입**하는 것을 제안합니다.

#### **`bms.unit_ownership_history` (호실 소유권 이력)**

| 컬럼명                 | 데이터 타입   | 키   | 설명                                                         |
| ---------------------- | ------------- | ---- | ------------------------------------------------------------ |
| `history_id`           | `uuid`        | PK   | 소유권 이력의 고유 식별자                                    |
| `unit_id`              | `uuid`        | FK   | 대상 호실의 ID (`bms.units` 참조)                            |
| `owner_id`             | `uuid`        | FK   | 해당 기간의 소유주 ID (`bms.owners` 참조)                    |
| `effective_start_date` | `date`        |      | 이 소유권이 효력을 **시작**하는 날짜                         |
| `effective_end_date`   | `date`        |      | 이 소유권이 효력을 **종료**하는 날짜 (현재 소유주는 이 값이 NULL) |
| `change_reason`        | `text`        | NULL | 변경 사유 (예: 매매, 증여)                                   |
| `created_at`           | `timestamptz` |      | 이 이력 레코드가 생성된 시각                                 |

#### **기존 `bms.units` 테이블 변경**

- **`owner_id` 컬럼 제거:** `units` 테이블의 `owner_id`는 더 이상 '현재 소유주'를 정확하게 나타내지 못하므로, 이 컬럼을 제거합니다. 특정 시점의 소유주 정보는 항상 `unit_ownership_history` 테이블을 통해 조회해야 합니다.

### **4. 업무 흐름 및 화면 설계**

#### **방법 1: 단일 호실 소유주 변경 (기본)**

- **관련 화면:** `[건물 정보] > [호실 관리]`에서 특정 호실(예: 101호)을 클릭하여 진입하는 **'호실 상세 관리'** 화면
- **핵심 UI:** 화면에 **`[소유주 변경]`** 버튼을 제공합니다.
- **처리 절차:**
  1. 관리자가 `[소유주 변경]` 버튼을 클릭합니다.
  2. 새로운 소유주와 변경일자를 입력받는 팝업이 나타납니다.
  3. 저장 시, 해당 호실(`unit_id`)에 대해서만 소유권 이력(과거 이력 마감, 신규 이력 생성)이 처리됩니다.

#### **방법 2: 다수 호실 일괄 소유주 변경 (신규 제안)**

> **이럴 때 사용합니다:** 한 임대인이 소유한 **모든 호실 또는 일부 호실**의 소유권을 다른 한 명에게 이전할 때 사용합니다.

- **관련 화면:** `[임대 관리] > [임대인 관리]`에서 특정 임대인(예: '홍길동')을 클릭하여 진입하는 **'임대인 상세 관리'** 화면
- **핵심 UI:** 화면의 소유 호실 목록 영역에 **`[소유 호실 일괄 이전]`** 버튼을 추가로 제공합니다.
- **처리 절차:**
  1. 관리자가 `[소유 호실 일괄 이전]` 버튼을 클릭합니다.
  2. 다음과 같은 정보를 입력받는 **'일괄 이전' 전용 팝업(Modal) 창**이 나타납니다.

| UI 요소                 | 입력 방식         | 설명                                                         |
| ----------------------- | ----------------- | ------------------------------------------------------------ |
| **현재 소유주**         | 고정 텍스트       | '홍길동'                                                     |
| **새로운 소유주**       | 검색/선택         | 시스템에 등록된 소유주 목록에서 새로운 소유주('김철수')를 검색하여 선택합니다. |
| **소유권 변경일**       | 날짜 선택         | 소유권이 이전되는 기준일(유효 시작일)을 선택합니다.          |
| **이전 대상 호실 선택** | **체크박스 목록** | **현재 소유주('홍길동')가 소유한 모든 호실 목록**이 체크박스와 함께 표시됩니다. 관리자는 이전할 호실을 직접 선택할 수 있습니다. • **'모든 호실'**을 이전하려면, 전체 선택 체크박스를 사용합니다. • **'일부 호실'**만 이전하려면, 해당되는 호실만 체크합니다. |
| **변경 사유**           | 텍스트 입력       | '일괄 매각', '자산 이전' 등 변경 사유를 기입합니다.          |

- **데이터 처리 (저장 시):**
  - 관리자가 **[저장]** 버튼을 클릭하면, 시스템은 **'이전 대상 호실'에서 선택된 모든 `unit_id`에 대해**, 방법 1과 동일한 소유권 이력 처리(과거 이력 마감, 신규 이력 생성)를 **하나의 트랜잭션**으로 묶어 순차적으로 수행합니다.

### **5. 이 방식의 장점**

- **효율성:** 여러 호실의 소유주를 한 번의 작업으로 변경할 수 있어, 반복적인 수작업을 획기적으로 줄여줍니다.
- **유연성:** 전체 이전과 부분 이전을 모두 지원하여, 실제 현장에서 발생하는 다양한 매매 시나리오에 유연하게 대응할 수 있습니다.
- **정확성:** 여러 건의 변경 작업을 하나의 트랜잭션으로 처리하여, 데이터 정합성을 보장하고 누락이나 중복의 위험을 방지합니다.
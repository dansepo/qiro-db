# **임대차 계약 라이프사이클에 따른 데이터 변화**

### **1. 문서 개요**

본 문서는 하나의 임대차 계약이 생성, 실행, 종료되는 전체 생명주기(Lifecycle) 동안, **`bms.lease_contracts`** 테이블과 관련 테이블의 데이터가 각 단계별로 어떻게 변화하는지를 정의합니다. 특히, 계약 기간 중 **소유주가 변경되는 복합적인 시나리오**의 처리 방안을 포함합니다.

### **2. 임대차 계약의 주요 라이프사이클 단계**

임대차 계약의 라이프사이클은 크게 **①계약 등록 → ②계약 실행 → ③계약 조정(소유권 이전) → ④계약 종료**의 4단계로 나눌 수 있습니다.

### **단계 1 & 2: 계약 등록 및 실행**

> **시나리오:** "임대인 **A**가 소유한 **101호**에 대해, 임차인 **B**와 2년간의 임대차 계약을 체결했습니다."

- **데이터 변경 내용:**
  1. **`bms.lease_contracts` 테이블:** 101호에 대한 계약 정보가 `ACTIVE` 상태로 **`INSERT`** 됩니다.
  2. **`bms.units` 테이블:** 101호의 `current_lease_id`가 새로운 계약 ID로 **`UPDATE`** 됩니다.

### **단계 3: 계약 조정 (소유권 이전 시)**

> **시나리오:** "계약 기간 중, 임대인 **A**가 **101호**를 새로운 임대인 **C**에게 매각했습니다. 소유권 이전일은 **2026-01-01**입니다."

- **처리 화면:** `[건물 정보] > [호실 관리] > 101호 선택 > [소유주 변경]`
- **시스템 동작:** 시스템은 101호에 `ACTIVE` 상태의 계약이 존재함을 인지하고, **'소유권 이전 처리'** 전용 팝업(Modal) 창을 표시합니다.

#### **'소유권 이전 처리' 팝업 화면 설계**

| UI 요소                   | 입력 방식                        | 설명                                                         |
| ------------------------- | -------------------------------- | ------------------------------------------------------------ |
| **이전 대상 호실**        | 고정 텍스트                      | **101호**                                                    |
| **현재 소유주**           | 고정 텍스트                      | '임대인 A'                                                   |
| **새로운 소유주**         | **검색/선택 (필수)**             | 새로운 소유주('임대인 C')를 검색하여 선택합니다.             |
| **소유권 변경일**         | **날짜 선택 (필수)**             | 소유권이 이전되는 기준일을 선택합니다. (예: 2026-01-01)      |
| **현재 임대차 계약 처리** | **라디오 버튼 선택 (핵심 기능)** | **기존 계약을 어떻게 처리할지 선택합니다.**<br>◎ **계약 승계:** 새로운 소유주가 기존 계약 조건을 그대로 이어받습니다.<br>○ **계약 종료 후 신규 계약:** 기존 계약은 해지되고, 필요시 새로운 계약을 별도로 등록합니다. |

#### **데이터 처리 흐름 (사용자 선택에 따라 분기)**

##### **Case 1: "계약 승계"를 선택한 경우**

> **처리 목적:** 기존 계약의 연속성을 유지하며 임대인만 변경합니다.

- **데이터 변경 내용 (하나의 트랜잭션으로 처리):**
  1. **`bms.unit_ownership_history` 테이블 (소유권 이력):**
     - 임대인 **A**의 소유 이력을 마감하고(`end_date` 업데이트), 임대인 **C**의 새로운 소유 이력을 생성(`INSERT`)합니다.
  2. **`bms.lease_contracts` 테이블 (계약 조정):**
     - **(기존 계약 해지):** 임대인 **A**와 임차인 **B** 간의 기존 계약 `status`를 **`TERMINATED`**로, `end_date`를 **`2025-12-31`**(이전일-1일)로 **`UPDATE`** 합니다.
     - **(신규 계약 승계 생성):** 새로운 임대인 **C**와 임차인 **B** 간의 **새로운 계약**을 **`INSERT`** 합니다. 이 계약은 원본 계약의 종료일과 대부분의 조건을 그대로 승계받습니다.
  3. **`bms.units` 테이블:**
     - 101호의 `current_lease_id`를 방금 생성된 **새로운 승계 계약의 ID**로 **`UPDATE`** 합니다.

##### **Case 2: "계약 종료 후 신규 계약"을 선택한 경우**

> **처리 목적:** 기존 계약 관계를 완전히 종료시키고, 호실을 '공실' 상태로 만듭니다.

- **데이터 변경 내용 (하나의 트랜잭션으로 처리):**
  1. **`bms.unit_ownership_history` 테이블 (소유권 이력):**
     - (Case 1과 동일) 임대인 **A**의 이력을 마감하고, **C**의 새로운 이력을 생성합니다.
  2. **`bms.lease_contracts` 테이블 (계약 완전 종료):**
     - 임대인 **A**와 임차인 **B** 간의 기존 계약 `status`를 **`TERMINATED`**로, `end_date`를 **`2025-12-31`**로 **`UPDATE`** 합니다.
     - **(중요)** 이 경우에는 새로운 계약이 자동으로 생성되지 않습니다.
  3. **`bms.units` 테이블:**
     - 101호의 `current_lease_id`를 **`NULL`**로 **`UPDATE`** 하여 **'공실'** 상태로 전환합니다.
  4. **후속 안내:** 시스템은 사용자에게 "101호의 소유권 이전 및 기존 계약 종료가 완료되었습니다. 새로운 임대인과 신규 계약이 필요하시면, 임대차 계약 관리 메뉴에서 진행해주세요." 라고 안내합니다.



### **3.2. 소유권 이전 (고도화된 시나리오)**

| 추가 케이스              | 상황 예시                                                    | 시스템 처리 방안                                             |
| ------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| **공동 소유주 발생**     | 임대인 **A**가 소유한 101호를, 새로운 투자자인 **C**에게 **지분 50%만** 매각했습니다. 이제 101호는 **A와 C가 공동으로 소유**하게 됩니다. | • **(DB 변경)** `unit_ownership_history`와 `unit_owners`의 관계를 1:N에서 **N:M(다대다)**으로 변경하고, 각 소유주의 **지분율(%)**을 저장할 수 있는 구조가 필요합니다.<br>• **(UI 변경)** '소유주 변경' 화면에서, 새로운 소유주를 추가할 때 지분율을 함께 입력받고, 기존 소유주의 지분율을 자동으로 조정하여 합계가 100%가 되도록 유도하는 기능이 필요합니다.<br>• **(정산 로직)** 임대료 정산 시, 각 공동 소유주의 지분율에 따라 임대 수익을 안분하여 계산하는 로직이 추가되어야 합니다. |
| **임차인의 소유권 취득** | 101호의 임차인 **B**가 계약 기간 중, 임대인 **A**로부터 해당 호실을 **직접 매입**했습니다. 이제 임차인 B가 새로운 소유주가 됩니다. | • **(UI)** '소유주 변경' 화면의 '새로운 소유주' 선택 시, 기존 임대인 목록뿐만 아니라 **현재 임차인도 선택**할 수 있도록 옵션을 제공해야 합니다.<br>• **(DB 처리)** 시스템은 `tenants` 테이블에 있는 '임차인 B'의 정보를 `unit_owners` 테이블에 복사하거나 연결하여 새로운 소유주로 등록합니다. 이후, 기존 임대차 계약은 '소유권 취득으로 인한 계약 종료' 사유로 **`TERMINATED`** 처리하고, 호실을 '공실(자가)' 상태로 변경합니다. |
| **임차권 양도 (전대차)** | 101호의 임차인 **B**가, 남은 계약 기간 동안 자신의 모든 권리를 새로운 임차인 **D**에게 넘기기로 임대인 **A**와 합의했습니다. (소유주는 그대로 A) | • **(UI)** '계약 상세 관리' 화면에 **`[임차권 양도]`** 버튼을 추가합니다.<br>• **(DB 처리)** 클릭 시, 기존 임차인 B의 계약은 `status`를 `TRANSFERRED`(양도됨)로 변경하고, 새로운 임차인 D에 대한 계약을 생성하되, 기존 계약의 남은 기간과 조건을 대부분 승계하도록 합니다. 두 계약은 `previous_lease_id` 와 같은 컬럼으로 연결하여 이력을 추적할 수 있습니다. |
| **법인 합병/인수**       | 101호를 소유한 **'A 건설'**이 **'C 그룹'**에 인수합병되었습니다. 법적으로는 소유주가 'C 그룹'으로 변경되었습니다. | • **(UI)** '소유주(임대인) 관리' 마스터 화면에서, 특정 소유주 정보를 다른 소유주 정보로 **'통합(Merge)'**하거나 **'상호 변경'**할 수 있는 기능을 제공합니다.<br>• **(DB 처리)** 'A 건설'의 소유주 ID를 가진 모든 `unit_ownership_history`의 최신 이력을 찾아, 새로운 소유주인 'C 그룹'의 ID로 업데이트하는 **일괄 변경(Batch Update)** 로직이 필요합니다. 이 과정에서 변경 사유와 이력을 명확히 기록해야 합니다. |

### **단계 4: 계약 종료 (정상 만료 또는 중도 해지)**

> **시나리오:** "이후 각 계약이 만료되거나 중도 해지되었습니다."

- **처리 화면:** `[임대 관리] > [임대차 계약 관리] > [계약 만료/해지 처리]`
- **데이터 변경 내용:**
  1. **`bms.lease_contracts` 테이블:** 해당 계약 레코드의 `status`를 **`EXPIRED`(만료됨)** 또는 **`TERMINATED`(중도해지)**로 **`UPDATE`** 합니다.
  2. **`bms.units` 테이블:** 해당 호실의 `current_lease_id`를 **`NULL`**로 **`UPDATE`** 하여 '공실' 상태로 전환합니다.

이처럼 다양한 시나리오에 대한 처리 방안을 미리 설계해두면, 시스템이 복잡한 실제 운영 환경의 요구사항에 부딪혔을 때, 구조 변경 없이 유연하게 기능을 확장해 나갈 수 있습니다.
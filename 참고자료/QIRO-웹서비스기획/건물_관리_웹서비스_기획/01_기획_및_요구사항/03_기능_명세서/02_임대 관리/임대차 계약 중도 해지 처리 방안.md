- - # **임대차 계약 해지 처리 방안**

    ### **1. 문서 개요**

    본 문서는 건물 관리 시스템에서 임대차 계약을 **즉시 해지**하거나, **미래의 특정 날짜에 해지되도록 예약**하는 모든 경우를 처리하는 통합된 기능의 상세 설계 및 업무 처리 방안을 정의합니다. 또한, **해지 예약의 수정 및 취소** 절차를 포함합니다.

    ### **2. 핵심 원칙: "기준일 기반의 지능적 처리"**

    이 기능의 핵심은, 사용자가 `[즉시 해지]`와 `[해지 예약]`을 구분하여 선택하는 것이 아니라, **오직 '실제 계약 종료일'만 입력**하면 **시스템이 해당 날짜를 기준으로 즉시 처리할지, 예약할지를 자동으로 판단**하는 것입니다.

    > **개선된 업무 흐름:** `① 계약 해지 처리 기능 실행` → `② 실제 계약 종료일 입력` → `③ 시스템이 날짜를 비교하여 즉시 또는 예약 처리`

    ### **3. 데이터베이스 설계**

    이 기능을 지원하기 위해, **`bms.lease_contracts`** 테이블에 다음 컬럼들이 필요합니다.

    | 컬럼명                           | 데이터 타입 | 설명                                                         |
    | -------------------------------- | ----------- | ------------------------------------------------------------ |
    | **`end_date`**                   | `date`      | 계약서상의 원래 만료일 또는 **실제 계약이 종료된 날짜**      |
    | **`status`**                     | `enum`      | 계약의 현재 상태 (`ACTIVE`, `EXPIRED`, **`TERMINATED`**)     |
    | **`scheduled_termination_date`** | `date`      | **해지 예정일.** 이 날짜가 되면 스케줄러가 자동으로 해지 처리합니다. 평상시에는 `NULL` 값을 가집니다. |
    | **`termination_reason`**         | `text`      | **해지 사유.** 중도 해지 시 관리자가 입력하는 사유입니다.    |

    ### **4. 업무 흐름 및 화면 설계**

    #### **가. 계약 해지 설정 (신규)**

    - **관련 화면:** `[임대 관리] > [임대차 계약 관리]`에서 현재 '계약중(ACTIVE)'인 특정 계약을 클릭하여 진입하는 **'계약 상세 관리'** 화면

    - **핵심 UI:** 화면에 **`[계약 해지 처리]`** 라는 단일 버튼을 제공합니다.

    - **처리 절차:**

      1. 관리자가 `[계약 해지 처리]` 버튼을 클릭합니다.

      2. '실제 계약 종료일'과 '해지 사유'를 입력받는 팝업이 나타납니다.

      3. 관리자가 **[저장]** 버튼을 클릭하면, 시스템은 **하나의 트랜잭션**으로 다음 로직을 수행합니다.

         **`IF (입력된 '실제 계약 종료일' <= 오늘 날짜)`  →  즉시 해지 처리**

         - `status`를 `TERMINATED`로, `end_date`를 '실제 계약 종료일'로 즉시 **`UPDATE`** 합니다.
         - 관련 호실의 `current_lease_contract_id`를 `NULL`로 변경합니다.

         **`ELSE (입력된 '실제 계약 종료일' > 오늘 날짜)`  →  해지 예약 처리**

         - `scheduled_termination_date` 컬럼에 미래의 '실제 계약 종료일'을 저장합니다.
         - `status`는 계속 `ACTIVE` 상태를 유지합니다.
         - 이후 시스템 스케줄러가 예약된 날짜에 자동으로 해지 처리를 수행합니다.

    #### **나. 해지 예약의 수정 및 취소 (신규 추가)**

    해지 예약이 설정된 계약은 **'계약 상세 관리'** 화면에서 다음과 같이 표시되고 관리되어야 합니다.

    **[화면 표시 예시]**

    > **계약 상태:** 계약중 (ACTIVE)
    >
    > **해지 예정:** `2025-09-30` (사유: 임차인 요청)  `[수정]` `[취소]`

    ##### **1. 해지일을 잘못 입력한 경우 (수정 방법)**

    - **사용자 행동:** 관리자가 **`[수정]`** 버튼을 클릭합니다.
    - **시스템 동작:**
      1. '계약 해지 처리' 팝업이 다시 나타나며, 기존에 입력했던 '해지 예정일'과 '해지 사유'가 채워져 있습니다.
      2. 관리자는 **새로운 날짜**를 선택하고 저장합니다.
      3. 시스템은 `bms.lease_contracts` 테이블의 **`scheduled_termination_date`** 컬럼을 새로운 날짜로 **`UPDATE`** 합니다.

    ##### **2. 해지일이 없는 경우 (해지 예약 취소 방법)**

    - **사용자 행동:** 관리자가 **`[취소]`** 버튼을 클릭합니다.
    - **시스템 동작:**
      1. "해지 예약을 취소하시겠습니까?" 라는 확인 팝업을 표시합니다.
      2. 관리자가 **[확인]**을 누르면, 시스템은 `bms.lease_contracts` 테이블의 **`scheduled_termination_date`와 `termination_reason` 컬럼을 모두 `NULL`로 `UPDATE`** 합니다.
      3. 이제 해당 계약은 해지 예약이 없는 순수한 '계약중(ACTIVE)' 상태로 돌아갑니다.

    ### **5. 이 방식의 장점**

    - **직관적인 UX:** 관리자는 '즉시'와 '예약'을 고민할 필요 없이, 오직 **실제 계약이 종료되는 날짜만** 정확하게 입력하면 됩니다.
    - **유연한 관리:** 잘못 설정된 해지 예약을 쉽게 수정하거나, 없던 일로 되돌릴 수 있어 실제 운영 환경의 다양한 변화에 유연하게 대응할 수 있습니다.
    - **업무의 통합:** 즉시 해지, 예약 해지, 예약 수정/취소 등 모든 관련 업무를 하나의 통합된 기능과 화면 흐름 안에서 처리하여 시스템 구조를 단순하고 명료하게 만듭니다.
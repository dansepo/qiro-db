# 💸 QIRO - 이사 정산 기능 명세서

## 1. 문서 정보
- **문서명:** QIRO - 이사 정산 기능 명세서
- **기능 ID (선택 사항):** F-MVOUTSETTLE-001 (Move-Out Settlement)
- **관련 요구사항 ID:** (예: QIRO-FR-LM-040, QIRO-FR-FE-020)
- **관련 사용자 스토리 ID:** (예: US-BM-XXX, US-AS-XXX)
- **작성일:** 2025년 06월 02일
- **최종 수정일:** 2025년 06월 02일
- **작성자:** QIRO 기획팀
- **검토자/승인자 (선택 사항):** (이름 또는 팀)
- **문서 버전:** 1.0

## 2. 기능 개요
### 2.1. 목적
임차인의 계약 종료 또는 중도 퇴실에 따른 이사 시, 해당 임차인과 관련된 모든 재정적 항목(미납 임대료/관리비, 최종 공과금, 보증금, 손해 배상금 등)을 정확하게 계산하고 정산한다. 이를 통해 임대인과 임차인 간의 분쟁을 최소화하고, 투명하고 신속한 퇴실 정산 업무를 지원한다.

### 2.2. 설명
본 기능은 특정 임차인의 이사(퇴실)가 확정되었을 때, 해당 임대 계약 정보를 기반으로 정산 대상 항목들을 집계하고, 최종 정산액(임차인에게 반환 또는 추가 징수액)을 산출한다. 정산 내역서를 생성하고, 정산 완료 상태를 기록 및 관리하는 기능을 포함한다.

### 2.3. 범위
- **In-Scope (포함 범위):**
    - 이사 정산 대상 임차인(계약) 선택 및 이사일(정산 기준일) 입력.
    - 정산 항목 자동 계산 및 수동 입력 지원:
        - 최종 임대료 (일할 계산 지원)
        - 최종 관리비 (일할 계산 지원)
        - 최종 공과금 (퇴실 시점의 최종 검침값 입력 및 요금 계산)
        - 기타 미납 비용 (이전 달 미납 임대료/관리비, 연체료 등)
        - 보증금 정보 조회.
        - (선택) 시설 손망실 비용, 청소 비용 등 기타 정산 비용 입력.
    - 최종 정산액 자동 계산 (보증금 - 총 정산 비용).
    - 이사 정산 내역서 생성 (인쇄 또는 PDF 저장 기능).
    - 정산 완료 처리 및 상태 관리 (예: `정산 대기`, `정산 완료`, `추가 징수 필요`).
    - (선택) 정산금 지급/수령 내역 기록.
- **Out-of-Scope (제외 범위):**
    - 실제 금융 거래(계좌 이체 등) 자동 실행 (본 기능은 계산 및 기록에 중점).
    - 시설 손망실에 대한 상세 실사 및 감정 평가 기능.
    - 법적 분쟁 중재 기능.
    - 퇴실 후 호실의 원상복구 관련 상세 관리 (이는 '시설 관리' 또는 별도 기능에서 일부 다룰 수 있음).

## 3. 사용자 인터페이스 (UI) 및 상호작용
### 3.1. 관련 화면
- `관리자 포털 > 임대 관리 > 이사 정산 관리`
- `관리자 포털 > 임대 계약 관리 > [계약 선택] > 이사 정산 탭`

### 3.2. UI 요소별 상세 설명 (예시)
- **화면 1: 이사 정산 목록 조회 화면**
    | UI 요소 ID (선택) | 요소명 (Label)           | 유형 (Type)   | 기본값/표시 데이터 | 동작 설명                                                    | 비고                                   |
    | :---------------- | :----------------------- | :------------ | :----------------- | :----------------------------------------------------------- | :------------------------------------- |
    | MOS-LST-01        | [건물/동/호실] 필터      | 드롭다운/검색 | 전체               | 특정 건물/동/호실의 정산 내역 필터링                         |                                        |
    | MOS-LST-02        | [정산 상태] 필터         | 드롭다운      | 전체               | `정산 대기`, `정산 완료` 등 상태별 필터링                    |                                        |
    | MOS-LST-03        | [정산(이사)일 범위] 필터 | 날짜 범위     | -                  | 특정 기간 내 정산(이사) 건 필터링                            |                                        |
    | MOS-LST-04        | [검색] 입력 필드         | 입력 필드     | -                  | 임차인명, 계약번호 등으로 검색                               |                                        |
    | MOS-LST-05        | [검색] 버튼              | 버튼          | -                  | 입력된 조건으로 목록 조회                                    |                                        |
    | MOS-LST-06        | [+ 이사 정산 추가] 버튼  | 버튼          | -                  | '이사 정산 등록 화면'으로 이동 (보통 계약 해지/만료 시 연동) |                                        |
    | MOS-LST-07        | 이사 정산 목록           | 표            | -                  | 호실, 임차인명, 이사(정산)일, 계약 종료일, 보증금, 총 정산 비용, 최종 정산액, 상태 등을 표시 | 정렬, 클릭 시 상세 조회/수정 화면 이동 |
    | MOS-LST-08        | 페이지네이션             | 페이지네이션  | 1                  | 목록이 많을 경우 페이지 이동                                 |                                        |

- **화면 2: 이사 정산 등록/상세 조회/수정 화면**
    * **섹션 구성:** 기본 계약 정보, 정산 항목 입력, 보증금 정산, 최종 정산액 확인, 정산 완료 처리 등
    | UI 요소 ID (선택) | 요소명 (Label)               | 유형 (Type)               | 예시/설명                                                    | 유효성 규칙/제약조건         |
    | :---------------- | :--------------------------- | :------------------------ | :----------------------------------------------------------- | :--------------------------- |
    | MOS-FRM-01        | 계약 정보 (임차인/호실)      | 텍스트 (읽기전용)         | 선택된 계약의 임차인명, 호실, 계약 기간, 기존 보증금 등 자동 표시 | (계약 선택 필수)             |
    | MOS-FRM-02        | 이사일 (정산 기준일)         | 날짜 선택                 | 실제 퇴실일 또는 정산 기준일 입력                            | 필수, 계약 기간 내 또는 직후 |
    | MOS-FRM-03        | **최종 임대료 (일할)**       | 숫자 (자동계산/수정가능)  | 이사일까지의 임대료 (예: 월 임대료 / 해당월일수 * 거주일수)  | 숫자, 자동 계산 로직 명시    |
    | MOS-FRM-04        | **최종 관리비 (일할)**       | 숫자 (자동계산/수정가능)  | 이사일까지의 관리비                                          | 숫자, 자동 계산 로직 명시    |
    | MOS-FRM-05        | **최종 공과금 (전기)**       | 숫자 입력 (또는 검침연동) | 이사일 기준 최종 전기 사용 요금 (최종 검침값 입력 UI 연동 또는 금액 직접 입력) | 숫자                         |
    | MOS-FRM-06        | **최종 공과금 (수도)**       | 숫자 입력 (또는 검침연동) | 이사일 기준 최종 수도 사용 요금                              | 숫자                         |
    | MOS-FRM-07        | **최종 공과금 (가스)**       | 숫자 입력 (또는 검침연동) | 이사일 기준 최종 가스 사용 요금                              | 숫자                         |
    | MOS-FRM-08        | 기타 미납액 (이월)           | 숫자 (자동표시/수정가능)  | 이전까지의 총 미납 임대료/관리비/연체료 합계                 | 숫자                         |
    | MOS-FRM-09        | 손해 배상금 (시설 등)        | 숫자 입력                 | 임차인 귀책 사유로 인한 손망실 비용 등                       | 숫자                         |
    | MOS-FRM-10        | 기타 비용/공제액 (+)         | 반복 입력 영역            | 항목명, 금액 입력 (예: 청소비, 키 반납 비용 등)              |                              |
    | MOS-FRM-11        | 기타 환급액 (-)              | 반복 입력 영역            | 항목명, 금액 입력 (예: 장기수선충당금 선수금 반환 등)        |                              |
    | MOS-FRM-12        | **납입 보증금 총액**         | 숫자 (읽기전용)           | 계약 시 납입된 보증금                                        |                              |
    | MOS-FRM-13        | **공제/정산 총액**           | 숫자 (자동계산)           | (FRM-03 ~ FRM-11) 항목들의 합계                              |                              |
    | MOS-FRM-14        | **최종 정산액**              | 숫자 (자동계산)           | (보증금 - 공제/정산 총액). 양수면 임차인 반환액, 음수면 임차인 추가 납부액. |                              |
    | MOS-FRM-15        | 정산 메모                    | 텍스트 영역               | 정산 관련 특이사항 기록                                      |                              |
    | MOS-FRM-16        | [정산 내역서 인쇄/저장] 버튼 | 버튼                      | 클릭 시 정산 내역서(PDF 등) 생성                             |                              |
    | MOS-FRM-17        | [정산 완료 처리] 버튼        | 버튼                      | 클릭 시 정산 상태를 '정산 완료'로 변경                       | 모든 항목 확정 후 활성화     |
    | MOS-FRM-18        | (선택) 지급/수령일           | 날짜 선택                 | 실제 정산금 지급 또는 수령일                                 | ('정산 완료' 처리 시 입력)   |
    | MOS-FRM-19        | (선택) 지급/수령 방법        | 드롭다운                  | 계좌이체, 현금 등                                            | ('정산 완료' 처리 시 입력)   |

#### 3.3. 주요 사용자 시나리오 (흐름)
- **시나리오 1: 임차인 퇴실에 따른 이사 정산 진행**
    1. 관리자가 '임대 계약 관리'에서 퇴실 예정인 임차인의 계약을 선택하고 [이사 정산 시작] 버튼을 클릭하거나, '이사 정산 관리'에서 [+ 이사 정산 추가]를 통해 대상을 선택한다.
    2. '이사 정산 등록 화면'으로 이동하며, 선택된 계약의 기본 정보(임차인, 호실, 보증금 등)가 자동으로 채워진다.
    3. 관리자가 실제 이사일(정산 기준일)을 입력한다.
    4. 시스템은 이사일까지의 임대료, 관리비를 일할 계산하여 제안한다 (관리자 수정 가능).
    5. 관리자가 최종 검침값을 입력하여 공과금을 정산하고, 기타 미납액, 손해 배상금, 추가 공제/환급 항목들을 입력한다.
    6. 시스템은 모든 항목을 합산하여 '공제/정산 총액'을 계산하고, 이를 '납입 보증금'에서 차감하여 '최종 정산액'(반환 또는 추가 징수)을 표시한다.
    7. 관리자가 [정산 내역서 인쇄/저장] 버튼을 클릭하여 내역서를 생성하고 임차인과 확인한다.
    8. 실제 정산금 지급/수령 후, 관리자는 [정산 완료 처리] 버튼을 클릭하고, (필요시) 지급/수령 정보를 입력하여 정산을 최종 마무리한다.
    9. 시스템은 해당 계약 및 임차인의 상태를 '종료/퇴거 완료'로, 호실 상태를 '공실(정산완료)'로 업데이트한다.

### 4. 데이터 요구사항
#### 4.1. 입력 데이터
- 정산 대상 계약 ID (또는 임차인 ID, 호실 ID)
- 이사일 (정산 기준일)
- 최종 사용분 공과금 계산을 위한 최종 검침값 또는 확정 금액
- 기타 정산 항목 (손해 배상금, 청소비 등) 및 금액
- (정산 완료 시) 실제 정산금 지급/수령 정보 (날짜, 방법, 금액)

#### 4.2. 출력 데이터 (화면 표시 및 정산서용)
- 정산 대상 기본 정보 (임차인, 호실, 계약 기간, 보증금)
- 항목별 정산 금액 (임대료, 관리비, 공과금, 기타 비용/환급액)
- 공제/정산 총액
- 최종 정산액 (임차인 반환액 또는 추가 납부액)
- 이사 정산 내역서 (PDF 또는 인쇄 가능한 형태)

#### 4.3. 이사 정산 (MoveOutSettlement) 엔티티 속성 (예시)
| 속성명 (Attribute)     | 데이터 타입 (Type)  | 필수 | 설명                                                         |
| :--------------------- | :------------------ | :--- | :----------------------------------------------------------- |
| `settlementId`         | UUID / Long (PK)    | Y    | 이사 정산 고유 ID                                            |
| `contractId`           | UUID / Long (FK)    | Y    | 관련 임대 계약 ID                                            |
| `tenantId`             | UUID / Long (FK)    | Y    | 대상 임차인 ID                                               |
| `unitId`               | UUID / Long (FK)    | Y    | 대상 호실 ID                                                 |
| `moveOutDate`          | Date                | Y    | 실제 이사일 (정산 기준일)                                    |
| `depositAmountHeld`    | BigDecimal / Double | Y    | 계약 시 납입된 보증금                                        |
| `finalRentAmount`      | BigDecimal / Double | Y    | 최종 정산 임대료 (일할 계산분)                               |
| `finalMaintenanceFee`  | BigDecimal / Double | Y    | 최종 정산 관리비 (일할 계산분)                               |
| `finalUtilityBills`    | JSON / Text         | Y    | 최종 정산 공과금 (항목별 금액 상세: `{"ELEC": 15000, "WATER": 8000}`) |
| `outstandingDues`      | BigDecimal / Double | Y    | 기타 미납액 합계 (이전 미납 관리비/임대료, 연체료 등)        |
| `damageRepairCosts`    | BigDecimal / Double | N    | 손해 배상금                                                  |
| `otherDeductions`      | JSON / Text         | N    | 기타 공제 항목 및 금액 목록 (`[{"item": "청소비", "amount": 50000}]`) |
| `otherRefunds`         | JSON / Text         | N    | 기타 환급 항목 및 금액 목록                                  |
| `totalDeductions`      | BigDecimal / Double | Y    | 공제/정산 총액 (시스템 자동 계산)                            |
| `netSettlementAmount`  | BigDecimal / Double | Y    | 최종 정산액 (시스템 자동 계산, 양수: 임차인 반환, 음수: 추가 징수) |
| `status`               | Enum / String       | Y    | 정산 상태 (예: `PENDING`, `CALCULATED`, `SETTLED`, `AWAITING_PAYMENT`) |
| `settlementDate`       | Date                | N    | 실제 정산금 지급/수령 완료일                                 |
| `settlementMethod`     | String              | N    | 정산금 지급/수령 방법                                        |
| `remarks`              | Text                | N    | 정산 관련 비고                                               |
| ... (생성/수정일시 등) |                     |      |                                                              |

### 5. 처리 로직 및 비즈니스 규칙
- **R-MVOUT-001:** 이사 정산은 유효한 임대 계약이 존재하고, 해당 계약이 '종료 예정' 또는 '해지 진행중' 등의 상태일 때 시작될 수 있다.
- **R-MVOUT-002:** 이사일(정산 기준일)을 기준으로 최종 임대료 및 관리비는 일할 계산된다. (일할 계산 방식: 예 - 월액 / 해당월총일수 * 실제거주일수)
- **R-MVOUT-003:** 최종 공과금은 이사일에 가장 가까운 시점의 최종 검침값을 기준으로 계산하거나, 관리자가 직접 해당 기간의 확정 금액을 입력한다.
- **R-MVOUT-004:** '최종 정산액'은 `납입 보증금 - (최종 임대료 + 최종 관리비 + 최종 공과금 + 기타 미납액 + 손해 배상금 + 기타 공제액 - 기타 환급액)`으로 계산된다.
- **R-MVOUT-005:** 정산이 '완료' 처리되면, 연결된 임대 계약의 상태는 '종료(정산완료)'로, 임차인의 상태는 '퇴거 완료'로, 해당 호실의 상태는 '공실'로 최종 업데이트되어야 한다.
- **R-MVOUT-006:** 모든 정산 항목 및 계산 근거는 이사 정산 내역서에 명확히 포함되어야 한다.

### 6. 오류 처리 및 예외 관리
| 오류 코드 (선택) | 발생 조건                              | 오류 메시지 (User-facing)                                    |
| :--------------- | :------------------------------------- | :----------------------------------------------------------- |
| E-MVOUT-01       | 필수 입력 항목(이사일 등) 누락         | "[필드명]은(는) 필수 입력 항목입니다."                       |
| E-MVOUT-02       | 금액 입력 필드 형식 오류               | "금액은 숫자로 입력해야 합니다."                             |
| E-MVOUT-03       | 유효하지 않은 계약 또는 임차인 선택    | "정산 대상 계약 또는 임차인 정보가 유효하지 않습니다."       |
| E-MVOUT-04       | 최종 정산액 계산 오류 (내부 로직 오류) | "정산액 계산 중 오류가 발생했습니다. 관리자에게 문의하세요." |

### 7. (기능별) 성능 요구사항
- P-MVOUT-01: 이사 정산 화면 로드 및 관련 데이터(계약정보, 이전 미납액 등) 조회 시 3초 이내 응답.
- P-MVOUT-02: 정산 내역 저장 및 최종 정산액 계산 시 2초 이내 완료.
- P-MVOUT-03: 이사 정산 내역서 생성(PDF 등) 시 5초 이내 완료.

### 8. (기능별) 보안 요구사항
- S-MVOUT-01: 이사 정산 기능은 '관리소장', '경리담당자' 등 인가된 역할만 접근 가능하다.
- S-MVOUT-02: 보증금, 정산액 등 민감한 금융 정보는 안전하게 처리되며, 접근 및 변경 이력은 감사 로그로 기록된다.
- S-MVOUT-03: 생성된 이사 정산 내역서는 임차인 본인 또는 인가된 관리자만 조회 가능하도록 접근을 통제한다.

### 9. 다른 기능/모듈과의 연관성
- **임대 계약 관리:** 정산 대상이 되는 임대 계약의 모든 조건(보증금, 임대료, 계약 기간 등)을 참조한다. 정산 완료 시 계약 상태를 업데이트한다.
- **임차인 관리:** 정산 대상 임차인 정보를 참조하고, 정산 완료 시 임차인 상태(퇴거 완료)를 업데이트한다.
- **호실 정보 관리:** 정산 완료 시 해당 호실의 상태('공실' 등)를 업데이트한다.
- **관리비 관리 / 공과금 입력:** 최종 관리비 및 공과금 정산을 위해 관련 데이터를 참조하거나 입력받는다.
- **수납 처리 / 미납 관리:** 이전까지의 미납 내역을 정산에 반영한다.
- **회계 관리:** 보증금 반환, 최종 비용 정산 등의 결과는 회계 처리와 연동되어야 한다 (예: 관련 전표 자동 생성 제안).

### 10. (선택 사항) 테스트 고려 사항
- 다양한 계약 조건(일할 계산 기간, 관리비 조건 등)에 대한 정산액 계산 정확성 테스트.
- 모든 정산 항목(임대료, 관리비, 공과금, 기타 비용/환급) 포함 및 누락 시나리오 테스트.
- 보증금이 정산액보다 많거나 적은 경우(반환/추가징수) 처리 로직 테스트.
- 정산 완료 후 관련 데이터(계약 상태, 임차인 상태, 호실 상태) 정상 업데이트 여부 확인.
- 이사 정산 내역서 출력 내용 정확성 검증.

### 11. 용어 정의 (선택 사항)
- **이사 정산 (Move-out Settlement):** 임차인이 퇴실할 때, 임대차 계약 기간 동안 발생한 모든 재정적 채권/채무 관계를 최종적으로 정리하는 절차.
- **일할 계산 (Pro-rata Calculation):** 특정 기간 전체에 대한 금액을 실제 사용일 또는 잔여일수에 비례하여 계산하는 방식.
- **손해 배상금 (Damages/Repair Costs):** 임차인의 귀책 사유로 발생한 시설물 손상 등에 대한 변상 비용.

### 12. 문서 이력
| 버전 | 날짜             | 작성자      | 주요 변경 내용      |
| :--- | :--------------- | :---------- | :------------------ |
| 1.0  | 2025년 06월 02일 | QIRO 기획팀 | 초기 명세서 안 작성 |
# 💸 QIRO - 입주/퇴실 시 임대료 및 관리비 정산 처리 기능 명세서

## 1. 문서 정보
- **문서명:** QIRO - 입주/퇴실 시 임대료 및 관리비 정산 처리 기능 명세서
- **기능 ID (선택 사항):** F-MVOUTSETTLE-001 (Move-Out/Move-In Settlement) - v1.1
- **관련 요구사항 ID:** (예: QIRO-FR-LM-040, QIRO-FR-FE-020, QIRO-FR-FE-021)
- **관련 사용자 스토리 ID:** (예: US-BM-XXX, US-AS-XXX)
- **작성일:** 2025년 06월 02일
- **최종 수정일:** 2025년 06월 02일
- **작성자:** QIRO 기획팀
- **검토자/승인자 (선택 사항):** (이름 또는 팀)
- **문서 버전:** 1.1 (입주/퇴실 시 임대료 및 관리비 정산 로직 상세화)

## 2. 기능 개요
### 2.1. 목적
임차인의 입주 또는 퇴실 시 발생하는 임대료, 관리비(고정 및 변동 공과금 포함)에 대한 정산 업무를 시스템을 통해 정확하고 효율적으로 처리한다. 일할 계산 등 다양한 정산 기준을 적용하여 최종 정산액을 산출하고, 관련 내역을 투명하게 관리하여 임대인 및 임차인과의 분쟁을 최소화한다. (본 명세서는 특히 '퇴실 시 정산'에 중점을 두며, '입주 시 정산'은 초기 청구분 생성과 연관된다.)

### 2.2. 설명
본 기능은 임차인의 계약 시작(입주) 또는 종료(퇴실) 시점에, 계약 조건 및 실제 사용 내역을 바탕으로 정산 대상 기간의 임대료와 관리비를 계산한다. 퇴실 시에는 보증금과의 연계, 기타 비용(손망실, 청소비 등) 및 환급 항목(선수관리비, 장기수선충당금 등)을 종합하여 최종 정산액(반환 또는 추가 징수)을 산출하고, 정산 내역서를 생성하며, 정산 완료 상태를 기록 관리한다. 입주 시에는 첫 달 임대료/관리비의 일할 계산 및 초기 검침값 기록 등을 지원한다.

### 2.3. 범위
- **In-Scope (포함 범위):**
    - **입주 시 정산 관련:**
        - 첫 달 임대료 및 고정 관리비 일할 계산 지원.
        - 입주 시점의 세대별 공과금 초기 계량기 검침값 기록.
        - (선택) 선수 관리비(관리비 예치금) 납부 기록.
    - **퇴실 시 정산 관련:**
        - 정산 대상 임차인(계약) 선택 및 이사일(정산 기준일) 입력.
        - 마지막 달 임대료 및 고정 관리비 일할 계산 지원.
        - 퇴실 시점 최종 계량기 검침값 입력 및 최종 사용 공과금 계산.
        - 기타 미납 비용(이전 미납 임대료/관리비, 연체료) 자동 집계.
        - 보증금 정보 조회 및 연동.
        - 시설 손망실 비용, 청소 비용 등 기타 정산 비용 수동 입력.
        - (선택) 장기수선충당금 등 기타 환급 항목 수동 입력.
        - 최종 정산액 자동 계산 (보증금 - 총 정산 비용).
        - 이사 정산 내역서 생성 (인쇄 또는 PDF 저장).
        - 정산 완료 처리 및 상태 관리.
        - (선택) 정산금 실제 지급/수령 내역 기록.
- **Out-of-Scope (제외 범위):**
    - 실제 금융 거래(계좌 이체 등) 자동 실행.
    - 시설 손망실에 대한 상세 실사 및 감정 평가 기능.
    - 법적 분쟁 중재 기능.

## 3. 사용자 인터페이스 (UI) 및 상호작용
### 3.1. 관련 화면
- `관리자 포털 > 임대 관리 > 이사 정산 관리 > [+ 이사 정산 추가]` (주로 퇴실 시)
- `관리자 포털 > 임대 계약 관리 > [계약 선택] > 입주 처리 시 정산 정보 입력` (입주 시)
- `관리자 포털 > 임대 계약 관리 > [계약 선택] > 퇴실 처리 및 이사 정산 탭` (퇴실 시)

### 3.2. UI 요소별 상세 설명 (예시 - 퇴실 정산 화면 중심)
- **화면: 이사 정산 등록/상세 조회 화면**
    * **섹션 1: 기본 정보**
        - 계약 정보 (임차인명, 호실, 계약 기간 등 - 읽기 전용, 자동표시)
        - 이사일 (정산 기준일): 날짜 선택 (필수)
        - 보증금 총액: 숫자 (읽기 전용, 계약 정보에서 자동표시)
    * **섹션 2: 임대료 및 고정 관리비 정산**
        - 마지막 달 임대료: 숫자 (일할 자동계산 표시, 수정 가능 - 수정 시 사유 입력 권장)
        - 마지막 달 고정 관리비: 숫자 (일할 자동계산 표시, 수정 가능)
    * **섹션 3: 변동 관리비 (공과금) 정산**
        (반복 영역 - 전기, 수도, 가스 등 시스템에 설정된 공과금 항목별로)
        - 항목명 (예: 전기료)
        - 전월 검침값: 숫자 (자동표시)
        - 최종(당월) 검침값: 숫자 입력 (필수)
        - 사용량: 숫자 (자동계산)
        - 단가: 숫자 (자동표시 또는 관리자 입력)
        - 최종 요금: 숫자 (자동계산, 수정 가능)
    * **섹션 4: 기타 정산 항목**
        - 이전 미납 총액: 숫자 (자동표시 - 미납 임대료/관리비/연체료 합계)
        - 손해 배상금: 숫자 입력
        - 퇴실 청소비: 숫자 입력
        - (항목 추가 가능) 기타 공제 항목: [항목명 입력], [금액 입력]
        - (항목 추가 가능) 기타 환급 항목 (예: 장기수선충당금 반환분): [항목명 입력], [금액 입력]
    * **섹션 5: 최종 정산**
        - 총 공제(비용)액: 숫자 (자동계산 - 섹션2,3,4의 비용 항목 합계)
        - 총 환급(수입)액: 숫자 (자동계산 - 섹션4의 환급 항목 합계)
        - **최종 정산액 (보증금 기준):** 숫자 (자동계산: `보증금 + 총 환급액 - 총 공제액`)
            - (양수 시: 임차인에게 반환할 금액)
            - (음수 시: 임차인에게 추가 징수할 금액)
    * **버튼 영역:** `[정산 내역서 미리보기/인쇄]`, `[임시 저장]`, `[정산 완료 처리]`

#### 3.3. 주요 사용자 시나리오 (흐름)
- **시나리오 1: 임차인 퇴실(이사나갈 때) 정산**
    1. 관리자가 퇴실 예정 임차인의 계약을 선택하고 [이사 정산 시작]을 클릭한다.
    2. 시스템은 '이사 정산 등록 화면'을 표시하며, 계약 정보 및 기존 보증금액을 자동 로드한다.
    3. 관리자가 실제 이사일(정산 기준일)을 입력한다.
    4. 시스템은 이사일까지의 임대료, 고정 관리비를 일할 계산하여 제안한다 (관리자 확인/수정 가능).
    5. 관리자가 퇴실일 기준 최종 계량기 검침값을 각 공과금 항목(전기, 수도, 가스 등)에 입력한다. 시스템은 이를 바탕으로 최종 사용량 및 요금을 계산하여 제안한다.
    6. 관리자가 기타 미납액(시스템 자동 집계), 손해 배상금, 청소비 등 추가 공제 항목과 장기수선충당금 반환 등 추가 환급 항목을 입력한다.
    7. 시스템은 모든 공제/환급 항목을 합산하고 보증금과 비교하여 최종 정산액(임차인에게 반환 또는 추가 징수)을 계산하여 표시한다.
    8. 관리자가 [정산 내역서 미리보기/인쇄]를 통해 내용을 확인하고 임차인과 공유/확인한다.
    9. 실제 정산금 지급/수령 후, 관리자가 [정산 완료 처리] 버튼을 클릭하고 관련 정보(지급/수령일, 방법 등)를 입력하여 정산을 최종 마무리한다.
    10. 시스템은 해당 계약 및 임차인의 상태를 '종료/퇴거 완료'로, 호실 상태를 '공실(정산완료)'로 업데이트한다. 회계 관련 데이터 생성 또는 연동.
- **시나리오 2: 신규 임차인 입주(이사올 때) 초기 정보 기록**
    1. 관리자가 신규 임대 계약 등록 시 또는 입주 처리 시 관련 정보 입력.
    2. 시스템은 계약 시작일을 기준으로 첫 달 임대료 및 고정 관리비 일할 계산액을 참고용으로 제시하거나, 초기 청구 데이터로 생성한다 (실제 청구는 첫 관리비 고지 시).
    3. 관리자가 입주일 기준 각 공과금 항목의 초기 계량기 검침값을 시스템에 기록한다. 이 값은 다음 달 관리비 정산 시 '전월 검침값'으로 사용된다.
    4. (필요시) 선수 관리비(관리비 예치금) 납부 내역을 기록한다.

### 4. 데이터 요구사항
#### 4.1. 입력 데이터
- 정산 대상 계약 ID, 임차인 ID, 호실 ID
- 이사일(정산 기준일)
- (입주 시) 초기 계량기 검침값 (항목별)
- (퇴실 시) 최종 계량기 검침값 (항목별)
- (퇴실 시) 기타 정산 항목(손망실, 청소비 등) 및 금액, 환급 항목 및 금액
- (퇴실 시, 정산 완료 시) 실제 정산금 지급/수령 정보

#### 4.2. 출력 데이터
- 입주/퇴실 정산 항목별 상세 내역 및 금액
- 최종 정산액 (반환/추가 징수)
- 이사 정산 내역서 (PDF 또는 인쇄 가능 형태)

#### 4.3. 이사 정산 (MoveOutSettlement) 엔티티 속성 (예시 - 퇴실 중심)
(이전 "이사 정산 기능 명세서"의 4.3절 엔티티 정의 내용을 여기에 상세히 기술)
| 속성명 (Attribute)           | 데이터 타입 (Type)  | 필수 | 설명                                                         |
| :--------------------------- | :------------------ | :--- | :----------------------------------------------------------- |
| `settlementId`               | UUID / Long (PK)    | Y    | 이사 정산 고유 ID                                            |
| `contractId`                 | UUID / Long (FK)    | Y    | 관련 임대 계약 ID                                            |
| `tenantId`                   | UUID / Long (FK)    | Y    | 대상 임차인 ID                                               |
| `unitId`                     | UUID / Long (FK)    | Y    | 대상 호실 ID                                                 |
| `moveOutDate`                | Date                | Y    | 실제 이사일 (정산 기준일)                                    |
| `depositAmountHeld`          | BigDecimal / Double | Y    | 계약 시 납입된 보증금                                        |
| `finalRentProrated`          | BigDecimal / Double | Y    | 최종 정산 임대료 (일할 계산분)                               |
| `finalFixedMaintFeeProrated` | BigDecimal / Double | Y    | 최종 정산 고정 관리비 (일할 계산분)                          |
| `finalUtilityBillsDetails`   | JSON / Text         | Y    | 최종 정산 공과금 상세 (`{"ELEC": {"reading":12345, "amount":15000}}`) |
| `totalPriorUnpaidDues`       | BigDecimal / Double | Y    | 정산 시점까지의 총 미납액 (임대료,관리비,연체료)             |
| `damageRepairCosts`          | BigDecimal / Double | N    | 손해 배상금                                                  |
| `otherDeductionItems`        | JSON / Text         | N    | 기타 공제 항목 및 금액 목록 (`[{"item": "청소비", "amount": 50000}]`) |
| `otherRefundItems`           | JSON / Text         | N    | 기타 환급 항목 및 금액 목록 (예: 선수관리비, 장기수선충당금) |
| `totalDeductionsCalculated`  | BigDecimal / Double | Y    | 총 공제액 (시스템 자동 계산)                                 |
| `netSettlementAmount`        | BigDecimal / Double | Y    | 최종 정산액 (시스템 자동 계산)                               |
| `status`                     | Enum / String       | Y    | 정산 상태 (예: `PENDING_CALC`, `CALCULATED`, `SETTLED`)      |
| `settlementProcessedDate`    | Date                | N    | 실제 정산금 지급/수령 완료일                                 |
| ... (생성/수정일시 등)       |                     |      |                                                              |

#### 4.4. 입주 시 검침 기록 (MoveInMeterReading) 엔티티 (예시)
| 속성명 (Attribute)  | 데이터 타입 (Type)  | 필수 | 설명                   |
| :------------------ | :------------------ | :--- | :--------------------- |
| `moveInReadingId`   | UUID / Long (PK)    | Y    | 입주 검침 기록 고유 ID |
| `contractId`        | UUID / Long (FK)    | Y    | 관련 임대 계약 ID      |
| `utilityTypeCode`   | String (FK)         | Y    | 공과금 항목 코드       |
| `meterReadingValue` | BigDecimal / Double | Y    | 입주 시 계량기 지침 값 |
| `readingDate`       | Date                | Y    | 검침일 (입주일)        |

### 5. 처리 로직 및 비즈니스 규칙

#### 5.1. 입주(이사올 때) 관련 정산 로직 (초기 청구분 생성 시 반영)
- **R-MVIN-RENT-001 (첫 달 임대료):**
    - 계약 시작일이 월초(1일)인 경우: 해당 월 임대료 전액을 첫 청구 대상으로 산정.
    - 계약 시작일이 월중인 경우: 일할 계산 `(월 임대료 / 해당 계약 시작월 총 일수) * 해당 월 계약 잔여일수` (계약 시작일 포함)를 첫 청구 대상으로 산정. (시스템 설정으로 일수계산 기준(예:30일 고정) 변경 옵션 제공 가능)
- **R-MVIN-FEE-001 (첫 달 고정 관리비):**
    - 첫 달 임대료 계산 방식(R-MVIN-RENT-001)과 동일한 기준으로 일할 계산하여 첫 청구 대상으로 산정.
- **R-MVIN-UTIL-001 (첫 달 변동 관리비 - 세대 사용 공과금):**
    - 입주 시점의 각 공과금(전기, 수도, 가스 등) 계량기 값을 `MoveInMeterReading`으로 정확히 기록.
    - 이 기록된 값은 다음 첫 정기 검침 시 '전월 검침값'으로 사용되어 첫 사용 기간의 공과금을 산정하고, 해당 월의 관리비에 포함하여 청구한다. (즉, 입주 당월에는 사용량 기반 공과금은 '0' 또는 이전 세입자 최종 사용분 정산 후의 금액으로 처리).

#### 5.2. 퇴실(이사나갈 때) 관련 정산 로직 (최종 청구분)
- **R-MVOUT-RENT-001 (마지막 달 임대료):**
    - 퇴실일(정산 기준일)이 월말인 경우: 해당 월 임대료 전액을 정산 대상 금액으로 함 (선납 가정).
    - 퇴실일이 월중인 경우: 일할 계산 `(월 임대료 / 해당 퇴실월 총 일수) * 해당 월 실제 거주일수` (퇴실일 포함)를 정산 대상 금액으로 함. 선납된 월 임대료가 있다면 차액을 계산 (환불 또는 추가 징수).
    - 계약서에 명시된 중도해지 위약금 또는 월단위 정산 특약이 있다면, 해당 조건 우선 적용 (관련 정보 입력 필드 및 로직 반영).
- **R-MVOUT-FEE-001 (마지막 달 고정 관리비):**
    - 마지막 달 임대료 계산 방식(R-MVOUT-RENT-001)과 동일한 기준으로 일할 계산하여 정산 대상 금액으로 함.
- **R-MVOUT-UTIL-001 (마지막 달 변동 관리비 - 세대 사용 공과금):**
    - 퇴실 시점의 최종 계량기 값을 입력받는다.
    - 사용량 계산: `(퇴실 시 최종 검침값 - 해당 월의 시작(전월 최종) 검침값)`. (해당 월의 시작 검침값은 직전 청구 주기의 마감 검침값을 의미).
    - 요금 계산: `(계산된 사용량 * 해당 공과금의 유효 단가)`. 단가는 "관리비 항목 설정" 또는 별도 "공과금 단가 관리"에서 가져온다.
    - 계산된 최종 공과금액을 정산 대상 금액에 포함한다.
- **R-MVOUT-UNPD-001 (기타 미납액):**
    - 정산 기준일까지 발생한 모든 미납 임대료, 미납 관리비, 확정된 연체료를 시스템에서 자동 집계하여 정산 대상 금액에 포함한다.
- **R-MVOUT-ETC-001 (기타 비용/환급):**
    - 관리자가 입력한 손해 배상금, 청소비 등 기타 공제 항목과 장기수선충당금 반환 등 기타 환급 항목을 정산 금액에 가감한다.
- **R-MVOUT-CALC-001 (최종 정산액 계산):**
    - `최종 정산액 = 납입 보증금 + 총 기타 환급액 - (최종 임대료 + 최종 고정 관리비 + 최종 변동 관리비 + 기타 미납액 + 총 기타 공제액)`
    - 결과가 양수이면 임차인에게 반환할 금액, 음수이면 임차인에게 추가 징수할 금액이다.
- **R-MVOUT-POST-001 (정산 완료 후 처리):**
    - '정산 완료' 처리 시, 연결된 임대 계약 상태를 '종료(정산완료)'로, 임차인 상태를 '퇴거 완료'로, 호실 상태를 '공실(정산 대기 중)' 또는 '공실(청소/수리 후 입주가능)' 등으로 업데이트한다.
    - 정산 결과는 회계 모듈로 전달되어 관련 분개 생성을 지원할 수 있다.

### 6. 오류 처리 및 예외 관리
| 오류 코드 (선택) | 발생 조건                                                  | 오류 메시지 (User-facing)                                    |
| :--------------- | :--------------------------------------------------------- | :----------------------------------------------------------- |
| E-MVOUT-01       | 필수 입력 항목(이사일, 최종 검침값 등) 누락                | "[필드명]은(는) 필수 입력 항목입니다."                       |
| E-MVOUT-02       | 금액/검침값 입력 필드 형식 오류                            | "금액(또는 검침값)은 숫자로 입력해야 합니다."                |
| E-MVOUT-03       | 유효하지 않은 계약 또는 임차인 선택                        | "정산 대상 계약 또는 임차인 정보가 유효하지 않습니다."       |
| E-MVOUT-04       | 최종 검침값이 이전 검침값보다 작은 경우 (오류 가능성 높음) | "최종 검침값이 이전 검침값보다 작습니다. 확인 후 다시 입력해주세요." (단, 계량기 교체 등 예외 상황 인지 후 강제 저장 옵션 제공 가능) |

### 7. (기능별) 성능 요구사항
- P-MVOUT-01: 이사 정산 화면 로드 및 관련 데이터(계약정보, 이전 미납액, 최종 검침 필요 항목 등) 조회 시 3초 이내 응답.
- P-MVOUT-02: 정산 내역 저장 및 최종 정산액 자동 계산 시 2초 이내 완료.
- P-MVOUT-03: 이사 정산 내역서 생성(PDF 등) 시 5초 이내 완료.

### 8. (기능별) 보안 요구사항
- S-MVOUT-01: 이사 정산 기능은 '관리소장', '경리담당자' 등 인가된 역할만 접근 가능하다.
- S-MVOUT-02: 보증금, 정산액 등 민감한 금융 정보는 안전하게 처리되며, 접근 및 변경 이력은 감사 로그로 기록된다.
- S-MVOUT-03: 생성된 이사 정산 내역서는 임차인 본인 또는 인가된 관리자만 조회 가능하도록 접근을 통제한다 (필요시 암호화 또는 보안 전송).

### 9. 다른 기능/모듈과의 연관성
- **임대 계약 관리:** 정산 대상이 되는 임대 계약의 모든 조건(보증금, 임대료, 계약 기간 등)을 참조한다. 정산 완료 시 계약 상태를 업데이트한다.
- **임차인 관리:** 정산 대상 임차인 정보를 참조하고, 정산 완료 시 임차인 상태(퇴거 완료)를 업데이트한다.
- **호실 정보 관리:** 정산 완료 시 해당 호실의 상태('공실' 등)를 업데이트한다.
- **관리비 관리 / 공과금 입력 / 수납 처리 / 미납 관리:** 최종 관리비 및 공과금 정산, 이전 미납 내역 정산을 위해 관련 데이터를 참조하거나 입력받는다.
- **회계 관리:** 보증금 반환, 최종 비용 정산 등의 결과는 회계 처리와 연동되어야 한다 (예: 관련 전표 자동 생성 제안).

### 10. (선택 사항) 테스트 고려 사항
- 입주 시나리오: 월초 입주, 월중 입주 시 첫 달 임대료/고정관리비 일할 계산 정확성 테스트. 초기 검침값 정상 기록 여부.
- 퇴실 시나리오: 월말 퇴실, 월중 퇴실 시 마지막 달 임대료/고정관리비 일할 계산 정확성 테스트.
- 다양한 공과금 항목(전기, 수도, 가스 등)에 대한 최종 사용량 및 요금 계산 정확성 테스트.
- 모든 정산 항목(미납액, 손해배상금, 기타 공제/환급) 포함 및 누락 시나리오 테스트.
- 보증금이 총 공제액보다 많거나 적은 경우(반환/추가징수)의 최종 정산액 계산 정확성 테스트.
- 정산 완료 후 관련 데이터(계약 상태, 임차인 상태, 호실 상태) 정상 업데이트 여부 확인.
- 이사 정산 내역서 출력 내용 및 모든 항목 포함 여부 검증.
- 계약서 상 특약(예: 중도 퇴실 위약금) 적용 시나리오 테스트.

### 11. 용어 정의 (선택 사항)
- **이사 정산 (Move-in/Move-out Settlement):** 임차인의 입주 또는 퇴실 시, 임대차 계약 기간 동안 발생한 모든 재정적 채권/채무 관계를 최종적으로 정리하는 절차.
- **일할 계산 (Pro-rata Calculation):** 특정 기간 전체에 대한 금액을 실제 사용일 또는 계약 잔여일수에 비례하여 계산하는 방식.
- **최종 검침값 (Final Meter Reading):** 임차인 퇴실 시점에 측정한 공과금 계량기의 최종 지침 값.
- **선수 관리비 (Maintenance Fee Deposit / Advance Payment):** 임차인이 입주 시 예치하고 퇴실 시 미납 관리비 등을 정산 후 반환받는 금액 (해당 시).
- **장기수선충당금 (Long-term Repair Allowance):** 공동주택의 주요 시설 교체 및 보수를 위해 소유주가 적립하는 금액으로, 임차인이 대신 납부한 경우 퇴실 시 소유주로부터 반환받음 (주로 아파트 해당).

### 12. 문서 이력
| 버전 | 날짜             | 작성자      | 주요 변경 내용                                      |
| :--- | :--------------- | :---------- | :-------------------------------------------------- |
| 1.0  | 2025년 06월 02일 | QIRO 기획팀 | 초기 명세서 안 작성                                 |
| 1.1  | 2025년 06월 02일 | QIRO 기획팀 | 입주/퇴실 시 임대료 및 관리비 정산 로직 상세화 반영 |

---
# **임대차 계약 만료 처리 방안**

### **1. 문서 개요**

본 문서는 건물 관리 시스템에서 임대차 계약의 종료일(`end_date`)이 도래했을 때, 해당 계약과 연결된 호실의 상태를 **자동으로 업데이트**하는 시스템의 처리 방안을 정의합니다.

### **2. 핵심 원칙: "스케줄러를 통한 자동화된 상태 관리"**

데이터베이스는 스스로 날짜를 인식하여 데이터를 변경하지 않습니다. 따라서, 시스템(백엔드 애플리케이션)이 **매일 정해진 시간에 자동으로 만료된 계약을 확인하고 상태를 변경**하는 기능을 구현해야 합니다. 이 자동화된 작업을 **'스케줄러(Scheduled Job)'** 또는 **'배치(Batch) 작업'**이라고 합니다.

### **3. 시스템의 자동 처리 흐름 (매일 자정에 실행)**

시스템은 매일 자정이 되면, 다음과 같은 절차를 순차적으로 수행합니다.

#### **1단계: 만료 계약 검색**

- **목적:** 계약 기간이 어제 날짜로 종료된 모든 계약을 찾아냅니다.

- **시스템 동작:** `bms.lease_contracts` 테이블에서 다음 두 가지 조건을 모두 만족하는 모든 계약 레코드를 검색합니다.

  1. `status`가 **'ACTIVE' (계약중)** 이고,
  2. `end_date`가 **어제 날짜**인 계약

  ```
  -- 만료 계약 검색을 위한 SQL 예시
  SELECT *
  FROM bms.lease_contracts
  WHERE status = 'ACTIVE' AND end_date = CURRENT_DATE - INTERVAL '1 day';
  ```

#### **2단계: 계약 상태 변경**

- **목적:** 검색된 계약들의 상태를 '만료됨'으로 변경하여, 더 이상 유효한 계약이 아님을 명시합니다.

- **시스템 동작:** 1단계에서 검색된 모든 계약 레코드에 대해, `status` 컬럼의 값을 'ACTIVE'에서 **'EXPIRED' (만료됨)**로 **`UPDATE`** 합니다.

  ```
  -- 계약 상태 변경을 위한 SQL 예시
  UPDATE bms.lease_contracts
  SET status = 'EXPIRED'
  WHERE lease_contract_id IN (...1단계에서 검색된 ID 목록...);
  ```

#### **3단계: 호실 상태 변경**

- **목적:** 계약이 만료된 호실을 새로운 임차인을 받을 수 있는 **'공실'** 상태로 전환합니다.

- **시스템 동작:** 1단계에서 검색된 각 계약의 `unit_id`를 사용하여, `bms.units` 테이블에서 해당 호실을 찾습니다. 그리고 `current_lease_contract_id` 컬럼의 값을 **`NULL`**로 **`UPDATE`** 합니다.

  ```
  -- 호실 상태 변경을 위한 SQL 예시
  UPDATE bms.units
  SET current_lease_contract_id = NULL
  WHERE unit_id IN (...1단계에서 검색된 호실 ID 목록...);
  ```

### **4. 이 방식의 장점**

- **업무 자동화:** 관리자가 매일 계약 만료 건을 수동으로 확인하고 처리하는 번거로움을 완전히 제거하여 업무 효율성을 극대화합니다.
- **데이터 정확성:** 사람의 실수나 누락 없이, 모든 만료 계약이 시스템에 정확하게 반영되어 항상 최신 상태의 데이터를 유지할 수 있습니다.
- **시스템 안정성:** 호실 상태가 자동으로 '공실'로 변경되므로, 만료된 호실에 새로운 계약을 즉시 등록할 수 있어 데이터 충돌이나 중복 계약의 위험을 방지합니다.
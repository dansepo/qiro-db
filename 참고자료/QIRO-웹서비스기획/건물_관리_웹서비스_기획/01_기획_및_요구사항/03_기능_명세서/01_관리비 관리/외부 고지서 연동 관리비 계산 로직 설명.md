# 🧾 QIRO 외부 고지서 연동 관리비 계산 로직 설명

## 개요
본 문서는 QIRO 시스템에서 건물 단위로 청구된 단일 외부 고지서(예: 전기료) 금액을, 건물의 '공용 사용료'와 각 '세대별 사용료'로 합리적으로 나누어 계산하고 배분하는 전체 처리 순서와 계산 방식을 정의한다.

## 1단계: 사전 준비 단계 (초기 1회 설정)

관리비 계산을 시작하기 전에, QIRO 시스템에 다음과 같은 정보들이 미리 설정되어 있어야 한다.

1.  **관리비 항목 설정 (`FeeItem`):** 최소 2개의 관련 항목이 필요하다.
    * **항목 1:**
        * **항목명:** `공용 전기료`
        * **유형:** `공용관리비`
        * **배분 방식:** `총액 면적 비례 배분 (TOTAL_COMMON_PER_AREA)` 또는 `총액 세대별 균등 배분 (TOTAL_COMMON_PER_UNIT_EQUAL)`
    * **항목 2:**
        * **항목명:** `세대 전기료`
        * **유형:** `개별사용료`
        * **배분 방식:** `세대별 사용량 비례 배분 (INDIVIDUAL_USAGE_PROPORTIONAL)`
2.  **외부 고지서 고객번호 설정 (`ExternalBillAccount`):**
    * **고객번호:** 한국전력 고객번호 (예: `1234567890`)
    * **종류:** `전기`
    * **관리비 청구 용도:** **`[v] 개별 사용료`** 와 **`[v] 공용 사용료`** 두 항목 모두 체크한다. 이 설정을 통해 시스템은 해당 고객번호로 청구된 금액이 두 가지 용도로 나뉘어야 함을 인지한다.
3.  **계량기 정보 등록 (`Facility`):**
    * **공용 계량기:** 건물 전체 또는 공용부의 전기 사용량을 측정하는 주 계량기를 '시설물'로 등록한다.
    * **개별 계량기:** 각 세대(호실)의 전기 계량기 정보가 '호실 정보' 등에 연결되어 있어야 한다.

## 2단계: 월별 데이터 입력 단계 (매월 수행)

특정 청구월(예: 2025년 6월)의 관리비를 계산하기 위해, 관리자는 다음 데이터를 입력한다.

1.  **공용 시설 검침 데이터 입력:** `2025년 6월` 청구월에 대해, `본관 공용 전기 계량기`의 당월 지침을 입력한다.
    * → 시스템은 **`이번 달 공용부 총 사용량(kWh)`**을 자동으로 계산한다.
2.  **개별 호실 검침 데이터 입력:** `2025년 6월` 청구월에 대해, **모든 세대**의 전기 계량기 당월 지침을 입력한다.
    * → 시스템은 **`각 세대별 사용량(kWh)`**과 **`전체 세대 사용량의 합계(kWh)`**를 자동으로 계산한다.
3.  **월별 외부 고지서 금액 입력:** `2025년 6월` 청구월에 대해, `한국전력 고객번호(1234567890)`로 실제 청구된 **'총 청구 금액'**을 입력한다. (예: `1,000,000원`)

## 3단계: 관리비 자동 계산 실행 시 시스템 내부 처리 로직

관리자가 `[관리비 산정 실행]` 버튼을 클릭했을 때, QIRO 시스템은 다음과 같은 계산을 수행한다.

### 방법 A: 사용량 기반 자동 안분 계산 방식 (권장)

이 방식은 관리자가 총액만 입력하면, 시스템이 검침된 사용량을 기준으로 공용분과 개별분을 자동으로 나누어 가장 합리적인 금액을 배분한다.

1.  **총 사용량 집계:**
    * `총 사용량 (kWh) = (공용부 총 사용량) + (전체 세대 사용량의 합계)`

2.  **실효 단가(Effective Rate) 계산:**
    * 누진세, 기본요금, 각종 기금 등이 모두 포함된 실제 고지서 금액을 총 사용량으로 나누어 해당 월의 **1kWh당 평균 실효 단가를 계산**한다.
    * `1kWh당 실효 단가 = (이번 달 총 청구 금액) / (총 사용량)`
    * 예: `1,000,000원 / 5,000 kWh = 200원/kWh`

3.  **공용/개별 요금 총액 분배:**
    * **`공용 전기료 총액`** = `(공용부 총 사용량) × (1kWh당 실효 단가)`
        * 예: `800 kWh × 200원/kWh = 160,000원`
    * **`세대 전기료 배분 대상 총액`** = `(전체 세대 사용량의 합계) × (1kWh당 실효 단가)`
        * (또는 `총 청구 금액 - 공용 전기료 총액`으로 계산하여 오차를 없앨 수 있음)
        * 예: `4,200 kWh × 200원/kWh = 840,000원`

4.  **최종 세대별 금액 배분:**
    * **"공용 전기료" 부과:** 위에서 계산된 `공용 전기료 총액`(160,000원)을 "공용 전기료" 항목에 설정된 배분 방식(예: 면적 비례)에 따라 각 세대에 배분한다.
    * **"세대 전기료" 부과:** 위에서 계산된 `세대 전기료 배분 대상 총액`(840,000원)을 "세대 전기료" 항목에 설정된 배분 방식(사용량 비례)에 따라 각 세대의 전기 사용량 비율로 안분하여 배분한다.
        * 예 (101호): `(101호 사용량 / 전체 세대 사용량 합계) × 840,000원`

### 방법 B: 관리자 수동 분배 방식 (간편 옵션)

"월별 외부 고지서 금액 입력" 화면의 UI 구성에 따라, 관리자가 직접 분배 기준 금액을 입력하는 방식이다.

1.  관리자는 해당 월의 `총 청구 금액`을 입력한다. (예: `1,000,000원`)
2.  시스템은 이 고객번호가 '개별+공용' 용도임을 인지하고, 추가 입력 필드를 보여준다.
3.  관리자는 고지서 내역 등을 참고하여 `공용 사용료 분담액` 필드에 직접 금액을 입력한다. (예: `160,000원`)
4.  시스템은 `세대 전기료 배분 대상 총액`을 자동으로 계산한다. (`1,000,000원 - 160,000원 = 840,000원`)
5.  이후 **방법 A의 4번(최종 세대별 금액 배분)** 로직을 동일하게 수행한다.

## 4. 요약 및 흐름도

```mermaid
graph TD
    subgraph 1. 월별 데이터 입력
        A["외부 고지서 총액 입력<br/>(예: 100만원)"]
        B["공용부 검침값 입력<br/>(→ 공용부 사용량 계산)"]
        C["세대별 검침값 입력<br/>(→ 각 세대 및 전체 세대 사용량 계산)"]
    end

    subgraph "2. 시스템 계산 실행 (자동 안분 방식 예시)"
        D["총 사용량 집계<br/>(공용 사용량 + 전체 세대 사용량 합)"]
        E["1kWh당 실효 단가 계산<br/>(총 청구액 / 총 사용량)"]
        F["공용부 요금 총액 확정<br/>(공용 사용량 * 실효 단가)"]
        G["세대분 요금 총액 확정<br/>(세대 사용량 합 * 실효 단가)"]
    end

    subgraph 3. 최종 세대별 배분
        H["확정된 공용부 요금 총액을<br/>'면적 비례' 등으로 각 세대에 배분"]
        I["확정된 세대분 요금 총액을<br/>'세대별 사용량 비례'로 각 세대에 배분"]
    end

    subgraph 4. 관리비 산정 완료
        J["각 세대의 관리비 고지서에<br/>'공용 전기료'와 '세대 전기료'가<br/>각각 계산되어 합산됨"]
    end

    A & B & C --> D --> E --> F & G;
    F --> H;
    G --> I;
    H & I --> J;
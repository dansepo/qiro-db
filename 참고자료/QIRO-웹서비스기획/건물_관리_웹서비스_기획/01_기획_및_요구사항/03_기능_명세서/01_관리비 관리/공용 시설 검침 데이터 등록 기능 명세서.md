#  M QIRO - 공용 시설 검침 데이터 등록 기능 명세서

## 1. 문서 정보
- **문서명:** QIRO - 공용 시설 검침 데이터 등록 기능 명세서
- **기능 ID (선택 사항):** F-COMMMTR-001 (Common Area Meter Reading)
- **관련 요구사항 ID:** (예: QIRO-FR-FE-005, QIRO-FR-FM-003)
- **관련 사용자 스토리 ID:** (예: US-BM-XXX, US-AS-XXX)
- **작성일:** 2025년 06월 02일
- **최종 수정일:** 2025년 06월 02일
- **작성자:** QIRO 기획팀
- **검토자/승인자 (선택 사항):** (이름 또는 팀)
- **문서 버전:** 1.0

## 2. 기능 개요
### 2.1. 목적
특정 청구월에 대해 건물의 공용 부분(예: 공용 복도, 주차장, 기계실 등)에서 사용된 전기, 수도, 가스 등의 사용량을 산정하기 위해, 해당 공용 시설에 설치된 계량기의 검침 데이터를 체계적으로 등록, 조회, 수정 및 관리한다. 이를 통해 투명하고 정확한 공용 관리비 부과의 기초를 마련한다.

### 2.2. 설명
본 기능은 관리자가 작업 대상 청구월과 사전에 시스템에 '시설물'로 등록된 공용 계량기(예: 건물 대표 전기 계량기, 공용 수도 계량기)를 선택하고, 해당 계량기의 검침일 및 당월 지침 값을 입력할 수 있도록 한다. 시스템은 입력된 당월 지침과 기록된 전월 지침을 바탕으로 해당 월의 공용 사용량을 자동으로 계산하여 표시한다. 이렇게 등록된 공용 시설 사용량 데이터는 "관리비 항목 설정"에 정의된 단가와 결합되어 "월별 공용 관리비"의 일부로 산정되고, 최종적으로 "관리비 산정" 기능을 통해 각 세대에 배분된다.

### 2.3. 범위
- **In-Scope (포함 범위):**
    - 작업 대상 청구월 선택 기능.
    - 등록된 공용 시설 계량기 목록 조회 및 선택 기능.
    - 공용 계량기별 검침일 및 당월 검침 지침 값 입력, 수정, 삭제(제한적) 기능.
    - 전월 검침 지침 자동 표시 (이력 기반).
    - 당월 사용량 자동 계산 및 표시.
    - (선택) 계량기 사진 등 증빙자료 첨부 기능.
    - 특정 청구월에 대한 공용 시설 검침 기록 목록 조회.
- **Out-of-Scope (제외 범위):**
    - 공용 시설 계량기 자체의 등록 및 상세 정보 관리 (이는 "시설 점검 및 유지보수 관리" 기능에서 '시설물'로 등록).
    - 검침된 사용량을 바탕으로 한 실제 공용 요금 계산 상세 로직 (단가 적용 및 금액 산출은 "월별 공용 관리비 입력" 또는 "관리비 산정" 기능에서 처리).
    - 개별 세대 사용량 검침 데이터 입력 (이는 별도의 "공과금 입력 (개별사용료 입력)" 기능).
    - 원격 검침(AMI) 시스템과의 자동 연동.

## 3. 사용자 인터페이스 (UI) 및 상호작용
### 3.1. 관련 화면
- `관리자 포털 > 관리비 > 공용 관리비 기초자료 > 공용 시설 검침값 등록` (가칭)
- 또는, `관리자 포털 > 시설 관리 > [특정 공용 계량기 선택] > 검침 기록 탭` 에서도 접근 가능하도록 연계 고려.

### 3.2. UI 요소별 상세 설명 (예시)
- **화면 1: 공용 시설 검침 데이터 등록 및 조회 화면**
    | UI 요소 ID (선택) | 요소명 (Label)           | 유형 (Type)     | 기본값/표시 데이터 | 동작 설명                                                    | 유효성 규칙/제약조건 | 비고                                               |
    | :---------------- | :----------------------- | :-------------- | :----------------- | :----------------------------------------------------------- | :------------------- | :------------------------------------------------- |
    | CMTR-LST-01       | [대상 청구월] 표시/선택  | 텍스트/드롭다운 | 현재 작업 청구월   | 검침 데이터를 입력/조회할 대상 청구월 선택                   | 청구월 상태 '준비중' | 변경 시 하단 목록/입력폼 새로고침                  |
    | CMTR-LST-02       | [건물/구역] 필터 (선택)  | 드롭다운        | 전체               | 특정 건물 또는 공용 구역의 계량기만 필터링 (공용 계량기가 여러 건물/구역에 분산 시) |                      |                                                    |
    | CMTR-LST-03       | [+ 신규 검침 등록] 버튼  | 버튼            | -                  | '공용 시설 검침 등록' 폼(또는 팝업) 호출                     |                      |                                                    |
    | CMTR-LST-04       | 공용 시설 검침 기록 목록 | 표              | -                  | 시설물명(계량기), 종류(전기/수도), 검침일, 전월지침, 당월지침, 사용량, 관리(수정/삭제) 등을 표시 | 정렬 기능            |                                                    |
    | (표 컬럼 내)      | [수정] 아이콘 버튼       | 아이콘 버튼     | (연필 모양)        | 해당 검침 기록 수정 폼 호출                                  |                      | 청구월 상태 '준비중'일 때만 활성화                 |
    | (표 컬럼 내)      | [삭제] 아이콘 버튼       | 아이콘 버튼     | (휴지통 모양)      | 해당 검침 기록 삭제 (확인 절차 후)                           |                      | 청구월 상태 '준비중'일 때만 활성화, 삭제 이력 기록 |

- **화면 2 (팝업 또는 화면 내 섹션): 공용 시설 검침 등록/수정 폼**
    | UI 요소 ID (선택) | 요소명 (Label)         | 유형 (Type)       | 기본값/표시 데이터 | 동작 설명                                                    | 유효성 규칙/제약조건                           |
    | :---------------- | :--------------------- | :---------------- | :----------------- | :----------------------------------------------------------- | :--------------------------------------------- |
    | CMTR-FRM-01       | 공용 시설(계량기) 선택 | 드롭다운/검색     | -                  | 시스템에 등록된 공용 계량기 시설물 목록에서 선택 (시설물명, 위치, 종류 등 표시) | 필수 선택                                      |
    | CMTR-FRM-02       | 종류                   | 텍스트 (읽기전용) | (자동표시)         | 선택된 계량기의 공과금 종류 (전기, 수도, 가스 등)            |                                                |
    | CMTR-FRM-03       | 검침일                 | 날짜 선택         | 오늘 날짜          | 실제 검침을 수행한 날짜 입력                                 | 필수, 청구월 기간 내 또는 정책에 따른 유효일자 |
    | CMTR-FRM-04       | 전월 지침              | 숫자 (읽기전용)   | (자동로드)         | 선택된 계량기의 직전 청구월 '당월 지침' 값 또는 초기값       |                                                |
    | CMTR-FRM-05       | 당월 지침              | 숫자 입력         | -                  | 현재 검침한 계량기 지침 값 입력                              | 필수, 숫자, 전월 지침 값 이상 입력 권장        |
    | CMTR-FRM-06       | 사용량                 | 숫자 (읽기전용)   | (자동계산)         | (당월 지침 - 전월 지침) 결과 표시                            |                                                |
    | CMTR-FRM-07       | 사진 첨부 (선택)       | 파일 업로드       | -                  | 계량기 사진 등 증빙자료 첨부 (다중 파일 가능)                | 파일 형식/크기 제한                            |
    | CMTR-FRM-08       | 비고 (선택)            | 텍스트 영역       | -                  | 검침 관련 특이사항 기록 (예: 계량기 교체, 추정 검침 등)      | 최대 500자                                     |
    | CMTR-FRM-09       | [저장], [취소] 버튼    | 버튼              | -                  |                                                              |                                                |

#### 3.3. 주요 사용자 시나리오 (흐름)
- **시나리오 1: 특정 청구월의 공용 전기 계량기 검침값 신규 등록**
    1. 관리자가 '공용 시설 검침 데이터 등록 화면'에 접속하여 대상 청구월(예: 2025년 6월)을 선택한다.
    2. 관리자가 [+ 신규 검침 등록] 버튼을 클릭한다.
    3. '공용 시설 검침 등록 폼'에서 [공용 시설(계량기) 선택] 드롭다운을 통해 "본관 공용 전기 계량기"를 선택한다.
    4. 시스템은 선택된 계량기의 '종류'(전기)와 '전월 지침'(2025년 5월의 당월 지침값)을 자동으로 표시한다.
    5. 관리자가 '검침일'(예: 2025-06-25)과 '당월 지침' 값을 입력한다.
    6. 시스템은 '사용량'을 자동으로 계산하여 표시한다. (만약 당월 지침 < 전월 지침이면 경고 UI 표시)
    7. (선택) 관리자가 계량기 사진을 첨부하고 비고를 입력한다.
    8. 관리자가 [저장] 버튼을 클릭한다.
    9. 시스템은 유효성 검사 후 검침 데이터를 저장하고, "검침 데이터가 성공적으로 등록되었습니다." 메시지를 표시한다. 목록이 갱신된다.
- **시나리오 2: 기 등록된 공용 수도 계량기 검침값 수정**
    1. 관리자가 '공용 시설 검침 데이터 등록 화면'에서 대상 청구월과 해당 검침 기록을 찾아 [수정] 아이콘을 클릭한다.
    2. '공용 시설 검침 수정 폼'에 기존 데이터가 채워져 표시된다.
    3. 관리자가 '당월 지침' 값을 수정 입력한다. (또는 검침일, 사진, 비고 등 수정)
    4. 시스템은 '사용량'을 자동으로 재계산하여 표시한다.
    5. 관리자가 [저장] 버튼을 클릭하여 변경사항을 저장한다.

### 4. 데이터 요구사항
#### 4.1. 입력 데이터
- 대상 청구월 ID (`billingMonthId`)
- 공용 시설(계량기) ID (`facilityId`)
- 검침일 (`readingDate`)
- 당월 검침 지침 값 (`currentMeterReading`)
- (선택) 첨부 파일, 비고

#### 4.2. 출력 데이터 (화면 표시 및 내부 처리용)
- 등록된 공용 시설 검침 기록 (계량기 정보, 검침일, 전월/당월 지침, 사용량 등)
- 계산된 공용 사용량 (`usageCalculated`)

#### 4.3. 공용 시설 월별 검침 (CommonFacilityMonthlyReading) 엔티티 속성 (예시)
| 속성명 (Attribute)     | 데이터 타입 (Type)  | 필수 (PK/FK) | 설명                                                         | 예시/비고                                     |
| :--------------------- | :------------------ | :----------- | :----------------------------------------------------------- | :-------------------------------------------- |
| `commonReadingId`      | UUID / Long         | PK           | 공용 시설 월별 검침 고유 ID                                  |                                               |
| `billingMonthId`       | UUID / Long         | FK           | 청구월 ID (BillingMonth 참조)                                |                                               |
| `facilityId`           | UUID / Long         | FK           | 공용 시설(계량기) ID (Facility 참조, facilityTypeCode='METER_ELEC_COMMON' 등) |                                               |
| `utilityType`          | Enum / String(20)   | Y            | 공과금 종류 (Facility 엔티티에서 가져오거나 중복 저장 가능)  | `ELECTRICITY`, `WATER`, `GAS`                 |
| `readingDate`          | Date                | Y            | 검침일                                                       |                                               |
| `previousMeterReading` | BigDecimal / Double | Y            | 전월(이전) 검침 지침 값 (해당월의 사용량 계산 기준)          |                                               |
| `currentMeterReading`  | BigDecimal / Double | Y            | 당월 검침 지침 값                                            |                                               |
| `usageCalculated`      | BigDecimal / Double | Y            | 계산된 사용량 (`currentMeterReading - previousMeterReading`) |                                               |
| `attachments`          | JSON / Array        | N            | 첨부 파일 정보 (파일명, S3 경로 등)                          |                                               |
| `remarks`              | Text                | N            | 검침 관련 비고                                               | "계량기 교체로 인한 초기값 변경", "추정 검침" |
| ... (생성/수정일시 등) |                     |              |                                                              |                                               |

### 5. 처리 로직 및 비즈니스 규칙
- **R-COMMMTR-001:** 검침 데이터는 대상 청구월의 상태가 `준비중`일 때만 등록/수정/삭제 가능하다. (정책에 따라 `진행중` 초기에도 가능할 수 있으나, 재산정 필요)
- **R-COMMMTR-002:** 특정 청구월에 대해 특정 공용 시설(계량기)의 검침 데이터는 하나만 존재해야 한다. (중복 등록 방지)
- **R-COMMMTR-003 (`전월 지침` 자동 설정):** 신규 검침 등록 시, 해당 공용 시설(계량기)의 직전 청구월 `당월 지침(currentMeterReading)` 값을 현재 청구월의 `전월 지침(previousMeterReading)`으로 자동 설정한다. 만약 직전 청구월 데이터가 없거나 첫 검침인 경우, 관리자가 직접 '전월 지침(기초값)'을 입력하거나 시스템이 0으로 초기화한다.
- **R-COMMMTR-004 (`사용량` 자동 계산):** `사용량 = 당월 지침 - 전월 지침`.
- **R-COMMMTR-005 (`당월 지침` 유효성):** `당월 지침`은 `전월 지침`보다 크거나 같아야 한다. 만약 작을 경우, 사용자에게 경고를 표시하고 사유(예: 계량기 교체, 오류 입력)를 확인하거나 입력하도록 유도한다. (강제 저장 옵션 제공 가능)
- **R-COMMMTR-006:** 이미 '관리비 산정'이 완료된 청구월의 검침 데이터를 수정/삭제할 경우, "이미 관리비 산정이 완료된 데이터입니다. 변경 시 관리비 재산정이 필요합니다."와 같은 경고 메시지를 표시하고, 관련 데이터의 재산정 필요 상태를 시스템적으로 관리해야 한다.

### 6. 오류 처리 및 예외 관리
| 오류 코드 (선택) | 발생 조건                                          | 오류 메시지 (User-facing)                                    | 시스템 처리 방안                                     |
| :--------------- | :------------------------------------------------- | :----------------------------------------------------------- | :--------------------------------------------------- |
| E-COMMMTR-01     | 필수 입력 항목(계량기 선택, 검침일, 당월지침) 누락 | "[필드명]은(는) 필수 입력 항목입니다."                       | 저장 차단, 해당 필드에 오류 표시                     |
| E-COMMMTR-02     | 숫자 필드(지침값) 형식 오류                        | "검침 지침 값은 숫자로 입력해야 합니다."                     | 저장 차단, 해당 필드에 오류 표시                     |
| E-COMMMTR-03     | 당월 지침 < 전월 지침 (경고 무시 불가 시)          | "당월 지침 값은 전월 지침 값보다 크거나 같아야 합니다. 확인해주세요." | 저장 차단 (또는 경고 후 저장 옵션 제공 시 관련 로직) |
| E-COMMMTR-04     | 이미 마감된 청구월 데이터 수정/삭제 시도           | "이미 마감 처리된 청구월의 검침 데이터는 변경할 수 없습니다." | 수정/삭제 차단, 안내 메시지 표시                     |

### 7. (기능별) 성능 요구사항
- P-COMMMTR-01: 특정 청구월의 공용 시설 검침 기록 목록 조회 시 (계량기 50개 기준) 1초 이내 응답.
- P-COMMMTR-02: 검침 데이터 저장(생성/수정) 시 0.5초 이내 처리 완료.

### 8. (기능별) 보안 요구사항
- S-COMMMTR-01: 공용 시설 검침 데이터 등록/수정/삭제 기능은 '관리소장', '경리담당자', '시설 담당자' 등 인가된 역할만 접근 가능하다.
- S-COMMMTR-02: 검침 데이터의 변경 이력(수정/삭제 시)은 감사 로그로 기록되어야 한다.

### 9. 다른 기능/모듈과의 연관성
- **시설 점검 및 유지보수 관리 (`Facility` 엔티티):** 본 기능에서 검침 대상으로 선택하는 '공용 시설(계량기)'은 해당 기능에서 '시설물'로 사전에 등록되고 관리되어야 한다 (예: `facilityTypeCode`가 `METER_ELECTRICITY_COMMON`, `METER_WATER_COMMON` 등으로 구분).
- **청구월 관리 (`BillingMonth` 엔티티):** 본 기능의 모든 검침 데이터는 특정 '청구월' 컨텍스트 하에서 관리된다. 청구월의 상태에 따라 본 기능의 데이터 입력/수정 가능 여부가 결정된다.
- **관리비 항목 설정 (`FeeItem` 엔티티):** 본 기능에서 등록된 사용량 데이터를 기반으로 요금을 계산할 때 필요한 단가 및 부과 방식 정보는 '관리비 항목 설정'에서 정의된 관련 공용 관리비 항목(예: 공용 전기료, 공용 수도료)을 참조한다.
- **월별 공용 관리비 입력 (F-COMMFEE-INPUT-001):**
    - 본 기능에서 입력된 검침 데이터(사용량)와 '관리비 항목 설정'의 단가를 곱하여 계산된 '공용 시설 사용 요금'이 "월별 공용 관리비 입력" 기능의 특정 항목(예: 공용 전기료 발생액)의 금액으로 자동 반영되거나, 관리자가 해당 금액을 입력할 때 참조 데이터로 활용된다. (두 기능 간의 통합 수준 정책 결정 필요)
- **관리비 산정 (F-FEE-CALC-001):** 본 기능 및 연관 기능을 통해 최종 확정된 '월별 공용 관리비 총액'(공용 시설 사용 요금 포함)은 '관리비 산정' 기능을 통해 각 세대에 설정된 배분 기준(면적별, 세대별 N등분 등)에 따라 배분된다.

### 10. (선택 사항) 테스트 고려 사항
- 신규/수정/삭제 등 기본 CRUD 기능 테스트.
- 전월 지침 자동 로드 및 사용량 자동 계산 정확성 테스트.
- 당월 지침 < 전월 지침 시 경고 및 처리 로직 테스트 (정상 저장/오류 후 저장 등).
- 청구월 상태 변경에 따른 입력/수정 제한 기능 테스트.
- 첨부 파일 기능 테스트 (다양한 형식, 크기).
- 등록된 검침 데이터가 '월별 공용 관리비 입력' 또는 '관리비 산정' 기능에 정확하게 반영되는지 연계 테스트.

### 11. 용어 정의 (선택 사항)
- **공용 시설 계량기 (Common Area Meter):** 건물의 공용 부분(복도, 엘리베이터, 주차장, 공용 화장실 등)에서 사용되는 전기, 수도, 가스 등의 사용량을 측정하는 주 계량기 또는 구역별 계량기.
- **검침 지침 (Meter Reading Value):** 계량기에 표시된 누적 사용량 수치.

### 12. 문서 이력
| 버전 | 날짜             | 작성자      | 주요 변경 내용                                               |
| :--- | :--------------- | :---------- | :----------------------------------------------------------- |
| 1.0  | 2025년 06월 02일 | QIRO 기획팀 | 공용 시설 검침 데이터 등록 기능 명세서 초안 작성 (이미지 및 사용자 요청 기반) |

---
# ⚙️ QIRO - 관리비 항목 관리 기능 명세서_02(편집중)

# 외부 고지서 고객번호 및 연결 관리 기능 명세서

## 1. 문서 정보
- **문서명:** QIRO - 외부 고지서 고객번호 및 연결 관리 기능 명세서
- **기능 ID (선택 사항):** F-EXTBILL-MGMT-001
- **관련 요구사항 ID:** (예: QIRO-FR-MF-050)
- **관련 사용자 스토리 ID:** (예: US-BM-XXX, US-AS-XXX)
- **작성일:** 2025년 05월 28일
- **최종 수정일:** 2025년 05월 28일
- **작성자:** QIRO 기획팀
- **검토자/승인자 (선택 사항):** (이름 또는 팀)
- **문서 버전:** 1.0

## 2. 기능 개요
### 2.1. 목적
건물 단위로 청구되는 주요 외부 공과금(예: 전기, 수도, 가스)의 고지서 식별 정보(고객번호/납부자번호, 공급자 등)를 건물별로 등록하고 관리한다. 등록된 고객번호는 특정 관리비 항목 유형(예: 공용 전기료, 세대별 수도료)과 자동 연결되어, 향후 해당 고객번호로 청구된 월별 총액을 입력하고, 그 금액을 각 세대에 설정된 배분 기준에 따라 부과하기 위한 기초 정보를 제공한다.

### 2.2. 설명
본 기능은 관리자가 해당 건물에 외부 공급자(예: 한국전력공사, 지역 도시가스사)로부터 받는 공과금 고지서의 고객번호, 공급자명, 관련 계량기 번호(선택) 등을 등록, 수정, 삭제할 수 있도록 한다. 또한, 각 고객번호가 어떤 종류의 공과금인지를 명시한다. "고객번호 연결 현황" 섹션은 이 등록된 고객번호가 어떤 관리비 항목과 연계되어 세대 배분에 사용될 수 있는지를 보여준다.

### 2.3. 범위
- **In-Scope (포함 범위):**
    - 외부 고지서 고객번호 정보 CRUD (고객번호, 종류, 공급자, 계량기 번호, 사용 유형 등).
    - 각 외부 고지서 고객번호에 대한 **금액 배분 규칙 설정 CRUD** (`BillToFeeItemLink` 관리): 
      - 연결 대상 관리비 항목(`FeeItem`) 선택.        
      - 배분 방식 유형(총액 전체, 총액 중 일부) 및 세부 규칙(고정액, 비율, 나머지, 처리 순서) 설정.
    - "고객번호 연결 현황" 조회.
- **Out-of-Scope (제외 범위):**
    - 등록된 고객번호에 대한 월별 실제 고지 금액 입력 (이는 별도의 "월별 공용 관리비 입력" 또는 "월별 외부 고지서 금액 입력" 기능에서 처리).
    - 입력된 고지 금액을 세대별로 배분하는 상세 계산 로직 (이는 "관리비 산정" 기능에서 처리).
    - 외부 공급자 시스템과의 실시간 연동.

## 3. 사용자 인터페이스 (UI) 및 상호작용
### 3.1. 관련 화면
- `관리자 포털 > 관리비 설정 > 외부 고지서 관리` 
    - **화면 탭 구성:** 관리비 항목, **외부 고지서 관리**, 납부 정보 설정

### 3.2. UI 요소별 상세 설명
- **화면 1: 외부 고지서 고객번호 관리 화면**
    
    ![image-20250528163940526](image-20250528163940526.png)
    
    - **섹션 1: 외부 고지서 고객번호 관리**
        
        - **섹션 제목:** 외부 고지서 고객번호 관리
        - **섹션 부제목:** 외부 고지서 고객번호 및 연결 규칙을 관리합니다
        | UI 요소 ID (선택) | 요소명 (Label)             | 유형 (Type)      | 기본값/표시 데이터 | 동작 설명                                                    | 유효성 규칙/제약조건 | 비고                                       |
        | :---------------- | :------------------------- | :--------------- | :----------------- | :----------------------------------------------------------- | :------------------- | :----------------------------------------- |
        | EB-LST-01         | **[+ 고객번호 추가]** 버튼 | 버튼             | -                  | 클릭 시 '고객번호 추가/수정 폼'(팝업 또는 새 섹션) 표시      |                      | 화면 우측 상단 위치 (이미지 참조)          |
        | EB-LST-02         | 고객번호 목록              | 표               | -                  | 등록된 외부 고지서 고객번호 정보를 표 형태로 표시            | 정렬 기능 제공 권장  |                                            |
        | (표 컬럼)         | **고객번호**               | 텍스트           | (예: 1234567890)   | 공급자가 부여한 고유 고객 식별 번호                          |                      |                                            |
        | (표 컬럼)         | **종류**                   | 텍스트           | (예: 전기)         | 공과금의 종류 (전기, 수도, 가스)                             |                      |                                            |
        | (표 컬럼)         | **공급자**                 | 텍스트           | (예: 한국전력공사) | 공과금 공급 업체명                                           |                      |                                            |
        | (표 컬럼)         | **별명**                   | 텍스트           | (예: 공용 계량기)  | 해당 고객번호의 별명(알기 쉬운명칭)                          |                      |                                            |
        | (표 컬럼)         | **계량기 번호**            | 텍스트           | (예: 1234567890)   | 관련 계량기 번호 (선택 입력 사항)                            |                      |                                            |
        | (표 컬럼)         | **관리**                   | 아이콘 버튼 그룹 | -                  | 각 항목에 대한 관리 기능 제공                                |                      |                                            |
        | (표 컬럼 내)      | [편집] 아이콘 버튼         | 아이콘 버튼      | (연필 모양)        | 클릭 시 해당 고객번호 정보를 수정할 수 있는 폼으로 이동/표시 |                      |                                            |
        | (표 컬럼 내)      | [삭제] 아이콘 버튼         | 아이콘 버튼      | (휴지통 모양)      | 클릭 시 해당 고객번호 삭제 확인 팝업 표시 후, 확인 시 삭제 처리 | 삭제 조건 충족 시    | 연결된 데이터가 없을 때만 삭제 가능 (정책) |
        
    - **섹션 2: 고객번호 연결 현황**
        - **섹션 제목:** 고객번호 연결 현황
        - **섹션 부제목:** 고객번호와 관리비 항목 간의 연결 현황을 확인합니다
        | UI 요소 ID (선택) | 요소명 (Label) | 유형 (Type) | 기본값/표시 데이터 | 동작 설명                                                    | 유효성 규칙/제약조건 | 비고                                                         |
        | :---------------- | :------------- | :---------- | :----------------- | :----------------------------------------------------------- | :------------------- | :----------------------------------------------------------- |
        | EB-CON-01         | 안내 메시지    | 텍스트      | (이미지 참조)      | "연결된 고객번호가 없습니다. 고객번호 추가 시 사용 유형을 선택하면 자동으로 연결됩니다." |                      | 연결된 고객번호가 있을 경우 해당 목록 표시 (별도 UI 정의 필요) |
    
- **화면 2 (팝업 또는 새 섹션): 고객번호 추가/수정 폼**
    
    <img src="image-20250528162442071.png" alt="image-20250528162442071" style="zoom: 50%;" /> <img src="image-20250528162559926.png" alt="image-20250528162559926" style="zoom:50%;" />
    
    | UI 요소 ID (선택) | 요소명 (Label)       | 유형 (Type) | 기본값/표시 데이터 | 동작 설명                                         | 유효성 규칙/제약조건                                         | 비고                                        |
    | :---------------- | :------------------- | :---------- | :----------------- | :------------------------------------------------ | :----------------------------------------------------------- | :------------------------------------------ |
    | EB-FRM-01         | 고객번호             | 입력 필드   | -                  | 공급자로부터 부여받은 고객번호 입력               | 필수 입력, 최대 50자, (종류+공급자+빌딩 내 중복 불가 - 정책) |                                             |
    | EB-FRM-02         | 종류                 | 드롭다운    | (선택)             | 전기, 수도, 가스, (기타 추가 가능) 선택           | 필수 선택                                                    |                                             |
    | EB-FRM-03         | 공급자               | 입력 필드   | -                  | 공과금 공급 업체명 입력 (자동완성 기능 제공 고려) | 필수 입력, 최대 100자                                        |                                             |
    | EB-FRM-04         | 별명                 | 입력 필드   | -                  | 입력한 별명                                       | 필수 선택(최대 20자)                                         |                                             |
    | EB-FRM-05         | 계량기 번호 (선택)   | 입력 필드   | -                  | 해당 고객번호와 연관된 주 계량기 번호             | 최대 50자                                                    | 개별 세대 계량기가 아닌 건물 대표 계량기 등 |
    | EB-FRM-06         | **사용 유형 (중요)** | 체크        | -                  | 이 고객번호로 청구되는 요금의 사용처 유형 선택    | 필수 선택                                                    | 예: '전기 공용 사용료', '전기 개별 사용료'  |
    | EB-FRM-07         | 메모 (선택)          | 텍스트 영역 | -                  | 해당 고객번호에 대한 추가 설명                    | 최대 200자                                                   |                                             |
    | EB-FRM-08         | [저장] 버튼          | 버튼        | -                  | 입력된 정보 저장                                  | 모든 필수 항목 유효성 통과 시 활성화                         |                                             |
    | EB-FRM-09         | [취소] 버튼          | 버튼        | -                  | 입력 취소 및 폼 닫기                              |                                                              |                                             |

### 3.3. 주요 사용자 시나리오 (흐름)
- **시나리오 1: 신규 외부 고지서 고객번호 등록**
    1. 관리자가 '외부 고지서 고객번호 관리' 화면에서 [+ 고객번호 추가] 버튼을 클릭한다.
    2. 시스템은 '고객번호 추가 폼'을 표시한다.
    3. 관리자가 고객번호, 종류(예: 전기), 공급자(예: 한국전력공사), 연결 빌딩, 사용 유형(예: 공용부 전기) 등 필수 정보를 입력한다.
    4. 관리자가 [저장] 버튼을 클릭한다.
    5. 시스템은 입력값 유효성(예: 중복 여부)을 검사한다.
        - 성공 시: "고객번호 정보가 성공적으로 등록되었습니다." 메시지를 표시하고, 고객번호 목록에 새 항목을 추가한다. '고객번호 연결 현황'에도 관련 정보가 반영될 수 있다.
        - 실패 시: 오류 메시지를 해당 필드 또는 상단에 표시하고, 수정을 요청한다.
- **시나리오 2: '고객번호 연결 현황' 확인**
    1. 관리자가 '외부 고지서 고객번호 관리' 화면에 접속한다.
    2. '고객번호 연결 현황' 섹션에서 시스템은 등록된 고객번호들이 어떤 관리비 항목 유형(예: 공용전기료 항목)과 연결되어 배분에 사용될 것인지를 보여준다. (상세 UI는 추가 정의 필요)
    3. (이미지 내용 기반) 만약 연결된 정보가 없다면, "연결된 고객번호가 없습니다..." 메시지가 표시된다.

## 4. 데이터 요구사항
### 4.1. 외부 고지서 계정 (ExternalBillAccount) 엔티티 속성
| 속성명 (Attribute)   | 데이터 타입 (Type) | 필수 (PK/FK) | 설명                                                         | 예시/비고                                                    |
| :------------------- | :----------------- | :----------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| `extBillAccountId`   | UUID / Long        | PK           | 외부 고지서 계정 고유 ID (시스템 자동 생성)                  |                                                              |
| `customerNumber`     | String(50)         | Y            | 공급자가 부여한 고객번호/납부자번호                          |                                                              |
| `utilityType`        | Enum / String(30)  | Y            | 공과금 종류                                                  | `ELECTRICITY`, `WATER`, `GAS`                                |
| `supplierName`       | String(100)        | Y            | 공급자 명칭                                                  | "한국전력공사", "서울도시가스"                               |
| `friendlyName`       | String(40)         | Y            | 알기쉬운 명칭                                                | 대표 계량기, 외부 수도 계량기                                |
| `meterNumber`        | String(50)         | N            | 관련 계량기 번호 (주 계량기 등)                              |                                                              |
| `usageType`          | Enum / String(50)  | Y            | 사용 유형 (배분 방식과 연관)                                 | `SHARED_FEE` , `INDIVIDUAL_FEE` 등                           |
| `memo`               | String(500)        | N            | 메모                                                         |                                                              |
| `feeItemCategoryId`  | UUID / Long        | FK (N)       | (자동 또는 수동 연결) 관리비 항목 분류 ID (FeeItemCategory 참조) | 이 고객번호로 청구된 금액이 어떤 관리비 항목으로 처리될지 연결 |
| `isActive`           | Boolean            | Y            | 사용 여부                                                    | `true` (사용), `false` (미사용) - 기본값 `true`              |
| ... (생성/수정 정보) |                    |              |                                                              |                                                              |

## 5. 처리 로직 및 비즈니스 규칙
- **R-EXTBILL-001:** (건물 ID + 고객번호 + 종류) 또는 (고객번호 + 종류) 조합은 시스템 내에서 고유해야 한다 (중복 등록 방지 - 정책 결정).
- **R-EXTBILL-002:** '사용 유형' 선택에 따라, 시스템은 해당 고객번호로 청구될 금액이 어떤 관리비 항목(예: '관리비 항목 설정'에서 정의된 '공용 전기료', '세대별 수도료' 등)과 연계되어 배분될 것인지 내부적으로 연결하거나, 관리자에게 연결 설정을 안내한다. (이미지의 "자동으로 연결됩니다" 문구 관련)
- **R-EXTBILL-003:** 연결된 고객번호 정보는 '월별 공용 관리비 입력' 기능 또는 '월별 외부 고지서 금액 입력' 기능에서 해당 청구월의 건물 단위 총액을 입력받는 기준으로 사용된다.
- **R-EXTBILL-004:** '고객번호 연결 현황'은 `ExternalBillAccount`와 `FeeItem`(또는 `FeeItemCategory`) 간의 매핑 관계를 보여준다. 이 매핑은 '관리비 산정' 시 해당 고객번호로 입력된 총액을 어떤 배분 기준(FeeItem에 설정된)으로 세대에 부과할지 결정하는 데 사용된다.
- **R-EXTBILL-005:** "공과금의 경우 건물에 청구되고 청구된 금액을 사용량등에 따라 각 호실에 설정한 배분 방식에 따라 부과된다" 규칙:
    - 본 기능은 "건물에 청구되는" 공과금의 고객번호를 등록한다.
    - '사용 유형' 필드를 통해 이 금액이 ①전체 공용비로 처리되어 배분될지, ②개별 세대 사용량 합계로 간주되어 각 세대 검침값에 따라 안분될지 등을 구분할 수 있다.
    - 실제 금액 입력은 다른 기능에서, 배분 계산은 '관리비 산정' 기능에서 이 정보를 활용한다.

## 6. 오류 처리 및 예외 관리
| 오류 코드 (선택) | 발생 조건                                     | 오류 메시지 (User-facing)                                    | 시스템 처리 방안                       |
| :--------------- | :-------------------------------------------- | :----------------------------------------------------------- | :------------------------------------- |
| E-EXTBILL-01     | 필수 입력 항목 누락                           | "[필드명]은(는) 필수 입력 항목입니다."                       | 저장 차단, 해당 필드에 오류 표시       |
| E-EXTBILL-02     | 고객번호 중복 (정책에 따라)                   | "이미 등록된 고객번호입니다 ([빌딩명] - [종류])."            | 저장 차단, 고객번호 필드에 오류 표시   |
| E-EXTBILL-03     | 유효하지 않은 빌딩 ID 선택                    | "존재하지 않는 빌딩 정보입니다."                             | 저장 차단, 안내 메시지 표시            |
| E-EXTBILL-04     | 고객번호와 관리비 항목 유형 자동 연결 실패 시 | "고객번호를 등록했으나, 적합한 관리비 항목 유형과 자동 연결되지 않았습니다. 수동 연결 또는 설정을 확인해주세요." | 등록은 성공시키되, 연결 상태 알림/경고 |

## 7. (기능별) 성능 요구사항
- P-EXTBILL-01: 고객번호 목록 조회 시 (최대 1000개 기준) 2초 이내 응답.
- P-EXTBILL-02: 고객번호 정보 저장(생성/수정) 시 1초 이내 처리 완료.

## 8. (기능별) 보안 요구사항
- S-EXTBILL-01: 외부 고지서 고객번호 관리 기능은 '총괄관리자', '관리소장', '경리담당자' 등 인가된 역할만 접근 가능하다.
- S-EXTBILL-02: 고객번호 정보 변경 이력은 감사 로그에 기록되어야 한다.

## 9. 다른 기능/모듈과의 연관성
- **건물정보 관리:** '연결 빌딩' 선택 시 건물 목록을 참조한다.
- **관리비 항목 설정:** '사용 유형' 선택 시, 이 고객번호가 어떤 종류의 관리비 항목(예: 공용 전기료, 세대 수도료 등)과 연관되는지 참조하거나 내부적으로 연결된다. "고객번호 연결 현황"에 이 정보가 반영된다.
- **월별 공용 관리비 입력 (또는 월별 외부 고지서 금액 입력):** 본 기능에서 등록된 고객번호를 기준으로 해당 청구월의 건물 단위 총 청구액을 입력받는다.
- **관리비 산정:** 본 기능에서 설정된 고객번호 및 '사용 유형'을 기반으로, 입력된 총액을 '관리비 항목 설정'에 정의된 배분 기준에 따라 각 세대에 배분 계산한다.

## 10. (선택 사항) 테스트 고려 사항
- 다양한 종류(전기, 수도, 가스 등) 및 공급자 정보로 고객번호 등록/수정/삭제 테스트.
- 고객번호 중복 등록 시도 시 예외 처리 테스트.
- '사용 유형' 선택에 따른 관리비 항목과의 자동 연결 로직 검증 (만약 구현된다면).
- '고객번호 연결 현황' 섹션에 정보가 올바르게 표시되는지 확인.
- 등록된 고객번호 정보가 후속 기능(월별 금액 입력, 관리비 산정)에서 정상적으로 사용되는지 연계 테스트.

## 11. 용어 정의 (선택 사항)
- **외부 고지서 고객번호 (External Bill Customer Number):** 한국전력, 도시가스 회사 등 외부 공급자가 각 건물 또는 주 계약자에게 부여하는 고유한 서비스 이용 식별 번호 (납부자번호 등).
- **사용 유형 (Usage Type):** 해당 고객번호로 청구되는 공과금의 성격 또는 최종 사용처를 구분하는 유형 (예: 건물 전체 공용, 특정 동 공용, 개별 세대 사용분 일괄 청구 등). 이 유형은 관리비 산정 시 배분 방식 결정에 영향을 미친다.

## 12. 문서 이력
| 버전 | 날짜       | 작성자      | 주요 변경 내용   |
| :--- | :--------- | :---------- | :--------------- |
| 1.0  | 2025-05-28 | QIRO 기획팀 | 초기 명세서 작성 |
# ⚙️ QIRO - 관리비 항목 관리 기능 명세서

## 1. 문서 정보
- **문서명:** QIRO - 관리비 항목 관리 기능 명세서
- **기능 ID (선택 사항):** F-FEE-SETUP-001
- **관련 요구사항 ID:** (예: QIRO-FR-MF-001, QIRO-FR-MF-005)
- **관련 사용자 스토리 ID:** (예: US-BM-XXX, US-SA-XXX)
- **작성일:** 2025년 06월 09일
- **최종 수정일:** 2025년 06월 09일
- **작성자:** QIRO 기획팀
- **검토자/승인자 (선택 사항):** (이름 또는 팀)
- **문서 버전:** 1.5 (적용 기간 삭제 및 부과 대상 호실 지정 기능 추가)

## 2. 기능 개요
### 2.1. 목적
건물에서 부과할 관리비 항목(예: 일반관리비, 청소비 등)을 정의하고, 각 항목의 부과 방식(고정액, 면적 비례 등), 기준 금액/단가, 과세 여부, 그리고 **부과 대상 호실의 범위(전체, 계약중, 공실, 특정 호실 선택 등)**를 설정 및 관리한다. 이를 통해 유연하고 정확한 관리비 부과 체계의 기초를 마련하며, 모든 관리비 산정의 기준 정보를 제공한다.

### 2.2. 설명
본 기능은 관리비 항목에 대한 CRUD(생성, 조회, 수정, 삭제/비활성화) 기능을 제공한다. 관리자는 시스템에서 사용할 관리비 항목들을 사전에 정의하고, 각 항목의 특성에 맞는 부과 로직과 계산 기준, 그리고 어떤 호실들에게 부과할 것인지에 대한 규칙을 설정할 수 있다. 항목의 유효성은 `상태(사용/사용 중지)` 값으로 관리하며, 신규 등록되거나 '사용 중지'에서 '사용' 상태로 변경된 항목은 **익월 청구분부터 적용**되는 것을 원칙으로 한다.

### 2.3. 범위
- **In-Scope (포함 범위):**
    - 신규 관리비 항목 생성 (항목명, 유형, 과세 여부, 배분 기준, 기준 금액/단가, 단위, 부가세 적용 여부, 상태 등 설정).
    - **부과 대상 호실 범위 지정 기능:** `전체호실`, `계약중인 호실`, `공실`, `선택한 호실`.
    - 기존 관리비 항목 목록 조회 (검색 및 필터링 기능 포함).
    - 기존 관리비 항목 정보 수정 (상태 변경: 사용/사용 중지 포함).
    - 관리비 항목 삭제 (단, 기 사용된 항목은 삭제 제한 또는 비활성화 처리).
- **Out-of-Scope (제외 범위):**
    - **적용 시작일/종료일에 의한 기간별 항목 관리 기능 (삭제됨).**
    - 계량기 사용량에 직접 연동되는 유틸리티 요금 항목의 단가 설정 및 계산 로직 (별도 기능에서 관리).
    - 관리비 항목별 회계 계정 연동 (별도 회계 설정 기능에서 정의 가능).

## 3. 사용자 인터페이스 (UI) 및 상호작용
### 3.1. 관련 화면
- `관리자 포털 > 설정 > 관리비 설정 > 관리비 항목 정의` (또는 유사 경로)

### 3.2. UI 요소별 상세 설명
- **화면 1: 관리비 항목 목록 조회 화면**
    | UI 요소 ID (선택) | 요소명 (Label)         | 유형 (Type)      | 기본값/표시 데이터  | 동작 설명                                                    | 비고           |
    | :---------------- | :--------------------- | :--------------- | :------------------ | :----------------------------------------------------------- | :------------- |
    | FI-LST-03         | **[+ 항목 추가]** 버튼 | 버튼             | -                   | 클릭 시 '관리비 항목 등록 폼 화면'으로 이동/표시             |                |
    | FI-LST-04         | 관리비 항목 목록       | 표               | -                   | 등록된 관리비 항목들을 표 형태로 표시                        | 정렬 기능 제공 |
    | (표 컬럼)         | 항목명                 | 텍스트           | (예: 일반관리비)    |                                                              |                |
    | (표 컬럼)         | 유형                   | 텍스트           | (예: 공용 관리비)   |                                                              |                |
    | (표 컬럼)         | **부과 대상**          | 텍스트           | (예: 전체호실)      | 이 항목이 부과되는 호실 범위 (전체호실, 계약중인 호실, 공실, 선택된 호실(X개)) |                |
    | (표 컬럼)         | 배분 기준              | 텍스트           | (예: 전용면적 비율) |                                                              |                |
    | (표 컬럼)         | 단가/금액              | 숫자/통화        | (예: 1,200)         |                                                              |                |
    | (표 컬럼)         | 상태                   | 텍스트(배지)     | (예: 사용)          |                                                              |                |
    | (표 컬럼)         | 관리                   | 아이콘 버튼 그룹 | -                   | 수정, 삭제 기능 제공                                         |                |

- **화면 2: 관리비 항목 등록/수정 폼 화면**
    * **섹션 구성:** 기본 정보, 부과 방식 설정, **부과 대상 설정**
    | UI 요소 ID (선택) | 요소명 (Label)          | 유형 (Type)          | 예시/설명                                                    | 유효성 규칙/제약조건                                      |
    | :---------------- | :---------------------- | :------------------- | :----------------------------------------------------------- | :-------------------------------------------------------- |
    | FI-FRM-02         | 항목명                  | 입력 필드            | (예: 특별 대청소비)                                          | 필수, 중복 불가                                           |
    | FI-FRM-03         | 유형                    | 드롭다운             | 공용 관리비, 기타 부과금 등                                  | 필수                                                      |
    | FI-FRM-03b        | 배분 기준               | 드롭다운             | 전용면적 비율, 호실 균등 등                                  | 필수                                                      |
    | FI-FRM-04         | 단가/금액               | 숫자 입력 필드       | (배분 기준에 따른 단가 또는 총액)                            | (배분 기준별 유효성)                                      |
    | FI-FRM-06a        | 상태                    | 드롭다운/라디오      | 사용, 사용 중지 (기본값: '사용')                             |                                                           |
    | **FI-FRM-APPLY**  | **부과 대상 호실 설정** | 라디오 버튼 그룹     | `(●) 전체호실` `( ) 계약중인 호실` `( ) 공실` `( ) 선택한 호실` | 필수 선택, '선택한 호실' 선택 시 아래 호실 선택 UI 활성화 |
    | FI-FRM-APPLY-SEL  | [호실 선택] 버튼        | 버튼 (조건부 활성화) | 클릭 시 호실 선택 모달 팝업 표시                             | 위 라디오 버튼에서 '선택한 호실' 선택 시 활성화           |
    | FI-FRM-APPLY-LIST | 선택된 호실 목록        | 텍스트/태그 리스트   | (예: 101호, 102호, 201호)                                    | (읽기 전용, 호실 선택 모달에서 관리)                      |
    | FI-FRM-10         | [저장] 버튼             | 버튼                 |                                                              |                                                           |

### 3.3. 주요 사용자 시나리오 (흐름)
- **시나리오 1: '계약중인 호실'에만 부과되는 신규 관리비 항목 등록**
    1. 관리자가 [+ 항목 추가] 버튼을 클릭한다.
    2. '관리비 항목 등록 폼'에서 항목명(예: "입주민 커뮤니티 회비"), 부과 방식(예: "세대별 고정액 부과"), 금액(예: "5,000") 등 기본 정보를 입력한다.
    3. "부과 대상 호실 설정" 섹션에서 `(●) 계약중인 호실` 라디오 버튼을 선택한다.
    4. [저장] 버튼을 클릭한다.
    5. 시스템은 유효성 검사 후 항목을 저장한다. 이 항목은 익월 관리비 산정 시 '계약중' 상태인 호실들에게만 5,000원씩 부과된다.
- **시나리오 2: 특정 '선택한 호실'에만 일회성 비용 부과 항목 등록**
    1. 관리자가 [+ 항목 추가] 버튼을 클릭한다.
    2. 항목명(예: "1층 로비 유리 교체 비용 배분"), 부과 방식(예: "총액 세대별 균등 배분") 등을 입력한다.
    3. "부과 대상 호실 설정" 섹션에서 `(●) 선택한 호실` 라디오 버튼을 선택한다.
    4. [호실 선택] 버튼이 활성화되고, 클릭하여 모달 팝업을 연다.
    5. 모달 내에서 해당 비용을 배분할 1층 상가 호실들만 체크하여 선택하고 [확인] 버튼을 클릭한다.
    6. '선택된 호실 목록'에 선택한 호실들이 표시되는 것을 확인하고 [저장] 버튼을 클릭한다.
    7. 이 항목은 익월 관리비 산정 시, 선택된 1층 상가 호실들에게만 관련 비용(별도 입력된 총액)이 배분되어 부과된다.

## 4. 데이터 요구사항
### 4.1. 관리비 항목 (FeeItem) 엔티티 속성 (수정됨)
| 속성명 (Attribute)              | 데이터 타입                                  | 필수       | 설명                                                         | 예시/비고                                   |
| :------------------------------ | :------------------------------------------- | :--------- | :----------------------------------------------------------- | :------------------------------------------ |
| `fee_item_id`                   | `UUID`                                       | Y          | 관리비 항목 고유 ID                                          |                                             |
| `item_name`                     | `VARCHAR(100)`                               | Y          | 항목명                                                       | "일반관리비", "특별 대청소비"               |
| `imposition_method`             | `VARCHAR(30)`                                | Y          | 부과(배분) 방식 코드                                         | `FIXED_AMOUNT_PER_UNIT`, `PER_AREA_RATE` 등 |
| `unit_price`                    | `NUMERIC(15, 2)`                             | (조건부 Y) | 단가 (또는 고정액/총액)                                      |                                             |
| `unit`                          | `VARCHAR(20)`                                | (조건부 Y) | 단위                                                         | "원/세대", "원/㎡"                          |
| `is_vat_applicable`             | `BOOLEAN`                                    | Y          | 부가세 적용 여부                                             |                                             |
| **`application_scope_type`**    | `VARCHAR(30)`                                | Y          | **부과 대상 호실 범위 유형** (`ALL_UNITS`, `LEASED_UNITS`, `VACANT_UNITS`, `SELECTED_UNITS`) |                                             |
| **`application_scope_details`** | `JSONB`                                      | (조건부 Y) | **선택된 호실 ID 목록** (`application_scope_type`이 `SELECTED_UNITS`일 경우) | `["unit-uuid-101", "unit-uuid-102"]`        |
| `is_active`                     | `BOOLEAN`                                    | Y          | 사용 여부 (이전 'status' 필드 역할)                          | `true` / `false`                            |
| `description`                   | `TEXT`                                       | N          | 항목 설명                                                    |                                             |
| ... (감사 필드)                 |                                              |            |                                                              |                                             |
| **(삭제된 필드)**               | `effective_start_date`, `effective_end_date` |            |                                                              |                                             |

## 5. 처리 로직 및 비즈니스 규칙
- **(수정) R-FEE-SETUP-004:** 이미 관리비 산정에 사용된 항목은 삭제할 수 없으며, 대신 `is_active` 상태를 `false`('사용 중지')로 변경하여 더 이상 사용되지 않도록 한다.
- **(수정) R-FEE-SETUP-006:** 신규로 등록된 관리비 항목은 등록 시점의 '현재 청구월'(관리비 작업이 진행 중인 가장 최근의 청구월)에는 적용되지 않는다. 해당 항목은 **익월 청구분부터** 관리비 산정에 사용 가능하다.
- **(수정) R-FEE-SETUP-007:** `is_active`가 `false`('사용 중지')인 항목을 `true`('사용')로 변경할 경우, 해당 항목은 신규 등록 규칙(R-FEE-SETUP-006)과 동일하게 처리되어, **변경 시점의 현재 청구월이 아닌 익월 청구분부터** 적용된다.
- **R-FEE-SETUP-008 (신규): 부과 대상 호실 결정 로직:**
    - "관리비 산정" 기능은 특정 `FeeItem`을 각 세대에 부과하기 전에, 해당 `FeeItem`의 `application_scope_type`을 먼저 확인한다.
    - `ALL_UNITS`: 해당 건물의 모든 활성 호실에 부과.
    - `LEASED_UNITS`: 산정 시점의 '계약중' 상태인 호실에만 부과.
    - `VACANT_UNITS`: 산정 시점의 '공실' 상태인 호실에만 부과.
    - `SELECTED_UNITS`: `application_scope_details`에 저장된 호실 ID 목록에 해당하는 호실에만 부과.
- **R-FEE-SETUP-009 (신규):** `application_scope_type`이 `SELECTED_UNITS`일 경우, `application_scope_details`에 최소 하나 이상의 호실 ID가 포함되어야 한다.

## 6. 오류 처리 및 예외 관리
| 오류 코드 (선택)          | 발생 조건                                   | 오류 메시지 (User-facing)                                    |
| :------------------------ | :------------------------------------------ | :----------------------------------------------------------- |
| (기존 오류 유지)          | ...                                         | ...                                                          |
| **E-FEE-SETUP-07 (신규)** | '선택한 호실' 부과 방식 선택 후 호실 미지정 | "부과 대상을 '선택한 호실'로 지정한 경우, 하나 이상의 호실을 선택해야 합니다." |

## 7. (기능별) 성능 요구사항
(이전 버전과 동일)

## 8. (기능별) 보안 요구사항
(이전 버전과 동일)

## 9. 다른 기능/모듈과의 연관성
- **관리비 산정:** 본 기능에서 설정된 `부과 방식`과 **`부과 대상 호실 범위`**는 '관리비 산정' 기능에서 어떤 호실에 얼마를 부과할지 결정하는 핵심 규칙으로 사용된다.
- **호실 정보 관리:** '선택한 호실' 지정 시 호실 목록을 참조한다. 또한, '계약중인 호실', '공실' 등의 상태는 '호실 정보'의 최신 상태를 기준으로 판단한다.

## 10. (선택 사항) 테스트 고려 사항
- **(신규)** 부과 대상 호실 범위(`전체`, `계약중`, `공실`, `선택`)별로 항목을 설정하고, 관리비 산정 시 해당 조건에 맞는 호실에만 정확히 부과되는지 연계 테스트.
- (삭제) 적용 시작일/종료일에 따른 적용 여부 테스트.
- **(수정)** 신규 등록 또는 상태 변경('사용 중지'->'사용') 후, 바로 다음 청구월부터 해당 항목이 산정에 포함되는지 테스트.
- (기존 테스트 유지)

## 11. 용어 정의 (선택 사항)
(이전 버전과 동일)

## 12. 문서 이력
| 버전    | 날짜                 | 작성자          | 주요 변경 내용                                               |
| :------ | :------------------- | :-------------- | :----------------------------------------------------------- |
| 1.3     | ...                  | ...             | (이전 내용)                                                  |
| **1.4** | **2025년 06월 09일** | **QIRO 기획팀** | **적용 시작일/종료일 필드 삭제 및 상태 기반 관리로 변경. 부과 대상 호실 지정 기능 추가.** |

---

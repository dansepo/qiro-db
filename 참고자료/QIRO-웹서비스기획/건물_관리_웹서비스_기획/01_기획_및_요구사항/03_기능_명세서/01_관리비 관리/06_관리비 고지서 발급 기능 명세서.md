# ⚙️ QIRO - 관리비 고지서 발급 기능 명세서

## 1. 문서 정보
- **문서명:** QIRO - 관리비 고지서 발급 기능 명세서
- **기능 ID (선택 사항):** F-INV-ISSUE-001
- **관련 요구사항 ID:** (예: QIRO-FR-MF-030)
- **관련 사용자 스토리 ID:** (예: US-AS-001)
- **작성일:** 2025년 05월 28일
- **최종 수정일:** 2025년 05월 28일
- **작성자:** QIRO 기획팀
- **검토자/승인자 (선택 사항):** (이름 또는 팀)
- **문서 버전:** 1.0

## 2. 기능 개요
### 2.1. 목적
'청구월 관리'에서 선택된 특정 청구월에 대해, '관리비 산정' 기능을 통해 계산되고 최종 확정된 세대별 관리비 내역을 바탕으로 표준화된 고지서를 생성한다. 생성된 고지서는 관리자가 검토(미리보기)하고, 필요시 출력하거나 입주민/임차인에게 전달(예: 이메일, SMS 알림)할 준비를 완료하는 것을 목표로 한다.

### 2.2. 설명
본 기능은 관리자가 특정 청구월의 확정된 관리비 데이터를 기반으로 개별 세대 또는 전체 세대에 대한 관리비 고지서를 시스템 내에서 생성하고 관리할 수 있도록 지원한다. 고지서에는 부과 항목별 상세 내역, 총 납부 금액, 납부 기한, 납부 방법 안내 등 필수 정보가 포함된다.

### 2.3. 범위
- **In-Scope (포함 범위):**
    - 작업 대상 청구월 선택 또는 확인.
    - 선택된 청구월의 확정된 관리비 내역 조회.
    - 고지서 생성 대상 세대 선택 (전체 세대, 특정 동/라인, 개별 세대).
    - 표준 고지서 양식에 따른 고지서 데이터 자동 생성.
    - 생성된 고지서 미리보기 기능 (PDF 또는 웹 화면).
    - 고지서 (데이터) 발급 처리 및 발급 상태 관리.
    - (선택) 고지서 일괄 PDF 다운로드 기능.
    - (선택) 고지서 발급 이력 조회.
- **Out-of-Scope (제외 범위):**
    - 고지서 양식(템플릿) 커스터마이징 기능 (초기 버전은 표준 양식 제공).
    - 실제 이메일 발송, SMS/알림톡 발송, 우편 인쇄 및 발송 연동 (이는 별도의 '알림/통지 서비스' 또는 외부 연동 기능으로 분리하여 명시. 본 기능은 발송 준비 데이터 생성까지).
    - 관리비 산정 자체 (이는 '관리비 산정' 기능).

## 3. 사용자 인터페이스 (UI) 및 상호작용
### 3.1. 관련 화면
- `관리자 포털 > 관리비 > 고지서 발급 및 관리`

### 3.2. UI 요소별 상세 설명
- **화면 1: 고지서 발급 관리 화면**
    | UI 요소 ID (선택) | 요소명 (Label)                  | 유형 (Type)     | 기본값/표시 데이터 | 동작 설명                                                    | 유효성 규칙/제약조건        | 비고                                              |
    | :---------------- | :------------------------------ | :-------------- | :----------------- | :----------------------------------------------------------- | :-------------------------- | :------------------------------------------------ |
    | INV-LST-01        | [대상 청구월] 표시/선택         | 텍스트/드롭다운 | (이전 선택 값)     | 현재 작업 대상 청구월을 표시하거나, 변경 (상태 `NOTIFIED` 또는 `CALC_DONE`의 확정된 월) | 청구월 상태 `NOTIFIED` 권장 | 청구월 변경 시 하단 내용 새로고침                 |
    | INV-LST-02        | [세대 선택] 옵션                | 라디오/드롭다운 | 전체 세대          | 고지서 생성 대상(전체, 특정 동, 특정 라인, 개별 검색) 선택   |                             | 선택에 따라 하단 목록 필터링                      |
    | INV-LST-03        | 세대 목록 (고지 대상)           | 표              | -                  | 동/호수, 세대주명, 관리비 총액, (고지서) 발급 상태, [미리보기] 버튼 등을 표시 | 페이지네이션, 검색          |                                                   |
    | INV-LST-04        | (표 내부) [미리보기] 버튼       | 버튼            | -                  | 해당 세대의 생성된 고지서 내용을 팝업 또는 새 탭에서 미리보기 (PDF/HTML) |                             |                                                   |
    | INV-LST-05        | [일괄 고지서 생성] 버튼         | 버튼            | -                  | 선택된 세대(또는 전체)에 대한 고지서 데이터 일괄 생성 실행   | 대상 세대 선택 필요         | 생성 후 발급 상태 '생성됨'으로 변경               |
    | INV-LST-06        | [일괄 발급 처리] 버튼 (선택)    | 버튼            | -                  | 생성된 고지서에 대해 '발급 완료' 상태로 변경 (실제 발송은 별개) | 고지서 생성 완료 후         | (시스템 정책에 따라 이메일/알림 발송 트리거 가능) |
    | INV-LST-07        | [일괄 PDF 다운로드] 버튼 (선택) | 버튼            | -                  | 선택된 세대의 고지서를 하나의 PDF 또는 개별 PDF 묶음으로 다운로드 | 고지서 생성 완료 후         |                                                   |

### 3.3. 주요 사용자 시나리오 (흐름)
- **시나리오 1: 특정 청구월 전체 세대 고지서 생성 및 미리보기**
    1. 관리자가 '고지서 발급 관리 화면'에 접속한다.
    2. 관리자가 [대상 청구월]을 선택한다 (해당 청구월의 관리비 산정은 확정된 상태여야 함 - `CALC_DONE` 또는 `NOTIFIED`).
    3. 관리자가 [세대 선택] 옵션에서 '전체 세대'를 선택(기본값)하고, [일괄 고지서 생성] 버튼을 클릭한다.
    4. 시스템은 해당 청구월의 모든 세대에 대해 확정된 관리비 내역을 바탕으로 표준 양식에 맞춰 고지서 데이터를 생성한다.
    5. '세대 목록'의 각 세대별 '발급 상태'가 '생성됨(Generated)'으로 변경되고, [미리보기] 버튼이 활성화된다.
    6. 관리자가 특정 세대의 [미리보기] 버튼을 클릭한다.
    7. 시스템은 해당 세대의 고지서 내용을 PDF 또는 HTML 형태로 팝업 또는 새 탭에 표시한다.
- **시나리오 2: 생성된 고지서 (데이터) 발급 처리**
    1. (시나리오 1 이후) 관리자가 고지서 내용 검토를 완료한다.
    2. 관리자가 [일괄 발급 처리] 버튼을 클릭한다. (또는 개별 세대 선택 후 [발급 처리])
    3. 시스템은 "선택된 세대의 고지서에 대해 발급 처리를 진행하시겠습니까?" 확인 팝업을 표시한다.
    4. 관리자가 [확인]을 클릭하면, 해당 고지서들의 '발급 상태'가 '발급 완료(Issued)'로 변경된다.
    5. (시스템 설정에 따라) 이 시점에 연동된 알림 서비스(이메일, SMS 등)를 통해 실제 고지 안내가 발송될 수 있다. 또는 관리자가 [일괄 PDF 다운로드] 기능을 통해 직접 출력/전달할 수 있다.

## 4. 데이터 요구사항
### 4.1. 입력 데이터 (고지서 생성을 위해 시스템 내부에서 참조하는 데이터)
- **선택된 청구월 ID (`billingMonthId`)**
- **해당 청구월의 확정된 세대별 관리비 총액 (UnitMonthlyFee):** `finalAmountDue`
- **해당 청구월의 확정된 세대별/항목별 관리비 상세 내역 (UnitFeeDetail):** `feeItemId`, `calculatedAmount`, `vatAmount`
- **세대 정보 (Unit):** `unitNumber`(동호수), `ownerName`/`tenantName`, `area` 등 고지서 표기 정보
- **건물 정보 (Building):** `buildingName`, `address` 등 고지서 표기 정보
- **관리 주체 정보 (ManagementOffice):** 관리사무소명, 연락처, 사업자번호, 계좌 정보 등 고지서 표기 정보
- **고지서 표준 양식/템플릿 정보**

### 4.2. 출력 데이터 (생성되는 데이터)
- **고지서 (Invoice) 엔티티:** `invoiceId`, `billingMonthId`, `unitId`, `issueDate` (발급일), `dueDate` (납부기한), `totalAmountDue`, `status` (생성됨, 발급완료, 확인됨 등), `invoiceContent` (JSON, XML, 또는 PDF 파일 참조 키)
- **생성된 고지서 파일 (PDF 등 - 선택적 저장):** S3 등에 저장하고 경로 참조.
- **고지서 발급 이력 로그.**

### 4.3. 관리비 고지서 (Invoice) 엔티티 속성 (예시)
| 속성명 (Attribute)   | 데이터 타입 (Type)  | 필수 (PK/FK) | 설명                                                 | 예시/비고                                                    |
| :------------------- | :------------------ | :----------- | :--------------------------------------------------- | :----------------------------------------------------------- |
| `invoiceId`          | UUID / Long         | PK           | 고지서 고유 ID                                       |                                                              |
| `billingMonthId`     | UUID / Long         | FK           | 청구월 ID (BillingMonth 참조)                        |                                                              |
| `unitId`             | UUID / Long         | FK           | 세대 ID (Unit 참조)                                  |                                                              |
| `unitMonthlyFeeId`   | UUID / Long         | FK           | 월별 세대 관리비 ID (UnitMonthlyFee 참조)            |                                                              |
| `issueDate`          | Date                | Y            | 고지서 발급(생성)일                                  | YYYY-MM-DD                                                   |
| `dueDate`            | Date                | Y            | 납부 기한일                                          | YYYY-MM-DD (예: 청구월 익월 10일)                            |
| `totalAmountBilled`  | BigDecimal / Double | Y            | 해당 고지서의 총 청구 금액 (관리비 산정 결과와 동일) |                                                              |
| `status`             | Enum / String(20)   | Y            | 고지서 상태                                          | `GENERATED`, `ISSUED`, `VIEWED_BY_TENANT`, `PAID_PARTIAL`, `PAID_FULL` |
| `invoiceContentRef`  | String              | N            | 생성된 고지서 파일 참조 (S3 Key 등) 또는 데이터 자체 | PDF 파일 경로 또는 고지서 내용 JSON                          |
| `notifiedAt`         | DateTime            | N            | (외부 연동 시) 실제 입주민에게 통지된 일시           |                                                              |
| ... (생성/수정 정보) |                     |              |                                                      |                                                              |

## 5. 처리 로직 및 비즈니스 규칙
- **R-INV-ISSUE-001:** 고지서 발급은 대상 청구월의 관리비 산정이 '확정'된 상태 (`CALC_DONE` 또는 `NOTIFIED`)에서만 가능하다.
- **R-INV-ISSUE-002:** 고지서에는 반드시 다음 정보가 포함되어야 한다 (표준 양식 기준):
    - 관리 주체 정보 (관리사무소명, 연락처, 사업자번호 등)
    - 납부자 정보 (동호수, 세대주명 등)
    - 청구월, 작성일, 납부 기한
    - 항목별 부과 금액, 공급가액, 부가세액, 총 합계 금액
    - 납부 방법 안내 (계좌 정보 등)
    - (선택) 전월 미납액, 연체료, 당월 조정액, 최종 납부할 금액
- **R-INV-ISSUE-003:** 고지서 생성 시, 각 세대별로 고유한 고지서 번호(또는 ID)를 부여할 수 있다.
- **R-INV-ISSUE-004:** '발급 처리'는 시스템 내에서 해당 고지서가 공식적으로 발행되었음을 의미하는 상태 변경이다. 실제 물리적 발송(이메일, SMS 등)은 이 상태 변경을 트리거로 동작하거나, 별도의 수동 작업으로 진행될 수 있다.
- **R-INV-ISSUE-005:** 한번 '발급 완료'된 고지서는 원칙적으로 수정하거나 재계산할 수 없다. 수정이 필요할 경우, '정정 고지서' 발급 절차를 따른다 (별도 기능).

## 6. 오류 처리 및 예외 관리
| 오류 코드 (선택) | 발생 조건                                       | 오류 메시지 (User-facing)                                    | 시스템 처리 방안                                     |
| :--------------- | :---------------------------------------------- | :----------------------------------------------------------- | :--------------------------------------------------- |
| E-INV-ISSUE-01   | 관리비 산정이 확정되지 않은 청구월 선택         | "선택된 청구월의 관리비 산정이 확정되지 않았습니다. 먼저 산정 결과를 확정해주세요." | 고지서 생성 차단, 안내 메시지 표시                   |
| E-INV-ISSUE-02   | 고지서 생성에 필요한 필수 정보 누락 (예: 계좌)  | "고지서 생성에 필요한 관리 주체 정보(예: 납부 계좌)가 설정되지 않았습니다." | 생성 차단, 관련 설정 화면으로 안내                   |
| E-INV-ISSUE-03   | (PDF 생성 시) 템플릿 오류 또는 데이터 변환 오류 | "고지서 파일 생성 중 오류가 발생했습니다. (오류코드: XXXXX)" | 생성 실패 처리, 오류 로깅, 관리자에게 기술 지원 안내 |

## 7. (기능별) 성능 요구사항
- P-INV-ISSUE-01: 500세대 기준, 전체 세대 고지서 데이터 일괄 생성 시 1분 이내 완료.
- P-INV-ISSUE-02: 개별 고지서 미리보기(PDF/HTML) 로딩 시간 3초 이내.
- P-INV-ISSUE-03: (선택) 500세대 고지서 일괄 PDF 다운로드 준비 시간 2분 이내.

## 8. (기능별) 보안 요구사항
- S-INV-ISSUE-01: 고지서 발급 관련 기능은 '관리소장', '경리담당자' 등 인가된 역할만 접근 가능하다.
- S-INV-ISSUE-02: 고지서에는 개인정보가 포함되므로, 접근 및 전송 시 암호화 등 보호 조치를 적용한다. (예: PDF 암호 설정 옵션)
- S-INV-ISSUE-03: 고지서 발급 및 주요 상태 변경 이력은 감사 로그로 기록한다.

## 9. 다른 기능/모듈과의 연관성
- **청구월 관리:** 본 기능은 '청구월 관리'에서 선택된 특정 청구월 및 해당 청구월의 상태에 의존한다.
- **관리비 산정:** 본 기능은 '관리비 산정'에서 계산되고 확정된 세대별 관리비 내역을 입력 데이터로 사용한다.
- **수납 처리:** 본 기능에서 발급된 고지서 정보(고지 금액 등)는 '수납 처리' 기능에서 납부 내역을 기록하고 미납을 관리하는 기준이 된다.
- **(선택) 알림 서비스:** 고지서 발급 완료 시, 이메일/SMS 발송 등 외부 알림 서비스와 연동될 수 있다.
- **(선택) 파일 스토리지 (S3):** 생성된 고지서 PDF 파일 등을 S3에 저장하고 관리할 수 있다.

## 10. (선택 사항) 테스트 고려 사항
- 다양한 세대 구성 및 관리비 항목에 대한 고지서 생성 정확성 테스트.
- 고지서 표준 양식의 모든 필수 정보 포함 여부 검증.
- 미리보기 기능과 실제 생성된 고지서(PDF 등) 내용 일치 여부 확인.
- 대량 세대 고지서 일괄 생성 및 발급 처리 시 성능 테스트.
- 청구월 상태에 따른 기능 제한(예: 미확정 시 생성 불가) 테스트.

## 11. 용어 정의 (선택 사항)
- **고지서 (Invoice/Bill):** 납부해야 할 관리비의 상세 내역과 금액, 납부 기한 등을 명시하여 통지하는 문서.

## 12. 문서 이력
| 버전 | 날짜       | 작성자      | 주요 변경 내용   |
| :--- | :--------- | :---------- | :--------------- |
| 1.0  | 2025-05-28 | QIRO 기획팀 | 초기 명세서 작성 |
새로운 청구월을 생성할 때, 관리비 산정에 영향을 주는 다양한 정보들을 **"스냅샷(Snapshot)"으로 복사해서 보관할지, 아니면 항상 최신 마스터 정보를 "참조(Reference)"할지** 결정하는 것은 데이터의 정합성과 이력 관리의 핵심입니다.

먼저 **"관리비 산정에 영향을 주는 모든 항목"**을 나열하고, 각 항목별로 스냅샷 복사 여부에 대한 제안을 드리겠습니다.

------

## Ⅰ. 관리비 산정에 영향을 주는 모든 항목 목록

관리비 산정은 크게 4가지 유형의 데이터를 종합하여 이루어집니다.

#### 1. 정책 및 항목 설정 데이터 (계산의 '방법과 기준')

- 관리비 항목별 설정 (`FeeItem` 마스터 기반):
  - `부과 방식`: 면적 비례, 세대별 균등 배분, 고정액 등 계산의 핵심 로직.
  - `단가/금액`: 면적당 단가, 세대별 고정액, 기본 월별 총액 등.
  - `과세/부가세 여부`: 세금 계산 기준.
  - `부과 대상 호실 범위`: 전체, 계약중, 공실, 특정 호실 등 부과 대상을 정하는 규칙.
- 납부 정책 (`PaymentPolicy` 설정):
  - `연체료율`: 미납 시 연체료 계산의 기준.
  - `납부 마감일`: 미납 및 연체 판단의 기준.
- 외부 고지서 연결 및 배분 규칙 (`ExternalBillAccount`, `BillToFeeItemLink`):
  - 하나의 외부 고지서 금액을 어떤 관리비 항목(공용, 개별)으로, 어떤 규칙(비율, 고정액)으로 나눌지에 대한 설정.

#### 2. 월별 변동 데이터 (해당 청구월의 '실측값')

- 개별 호실 검침 데이터 (`UnitMonthlyMeterReading`):
  - 각 세대의 전기, 수도, 가스 등의 실제 **사용량**.
- 공용 시설 검침 데이터 (`CommonFacilityMonthlyReading`):
  - 공용부의 전기, 수도 등의 실제 **사용량**.
- 월별 외부 고지서 청구 금액 (`MonthlyExternalBillAmount`):
  - 한전, 수도사업소 등에서 해당 월에 건물 단위로 청구한 **총 금액**.
- 월별 공용 관리비 (`MonthlyCommonFee`):
  - 검침 기반이 아닌 공용 비용의 해당 월 **발생 총액** (예: 청소 용역비, 승강기 유지보수 계약금).

#### 3. 대상 기초 데이터 (계산 대상의 '속성')

- 호실 정보 (`Unit`):
  - `전용 면적`, `계약 면적`: 면적 비례 배분 시 기준값.
  - `현재 상태`: '계약중', '공실' 여부에 따라 부과 대상(임차인/임대인) 및 특정 항목의 부과 여부 결정.
  - `지분 정보`, `등록 차량 대수`, `등록 인원수` 등 (관련 부과 방식 사용 시).
- 임대 계약 정보 (`LeaseContract`):
  - `관리비 조건`: 임대료에 관리비가 포함되는지, 고정 관리비가 있는지 등 특수 조건 확인.

#### 4. 이월 및 조정 데이터 (과거 및 현재의 '변수')

- **전월 미납액 (`UnitMonthlyUnpaidAmount`):** 직전 청구월에서 이월된 미납 총액.
- **발생 연체료 (`LateFeeTransaction`):** 미납액에 대해 발생한 연체료.
- **기타 조정액:** 특정 세대에 대해 관리자가 직접 입력하는 일회성 감면액 또는 추가 부과액.

------

## Ⅱ. 청구월 생성 시 데이터 연동 방식 판단 (스냅샷 vs. 참조)

**핵심 원칙:** **과거의 관리비 내역은 미래의 설정 변경에 영향을 받지 않아야 합니다.** 즉, 6개월 전 고지서를 다시 조회했을 때, 그 당시의 단가와 규칙으로 계산된 결과가 그대로 보여야 합니다. 이를 위해 **'스냅샷'** 개념이 매우 중요합니다.

#### 1. 정책 및 항목 설정 데이터 (예: 단가, 부과방식 등)

- **판단:** **반드시 '스냅샷'으로 복사해야 합니다.**
- 이유 (매우 중요):
  - **역사적 데이터 보존:** 만약 관리자가 오늘 "일반관리비"의 면적당 단가를 1,000원에서 1,200원으로 변경했을 때, 스냅샷 방식이 아니라면 작년 관리비 내역을 다시 조회할 때 현재의 1,200원으로 재계산되어 과거 고지서와 금액이 달라지는 심각한 문제가 발생합니다.
  - **감사 및 재현성:** 과거 특정 시점의 관리비가 어떤 기준과 단가로 계산되었는지 정확히 추적하고 재현할 수 있어야 합니다.
- QIRO 시스템 적용 방안:
  - 새로운 청구월을 생성하면, 그 시점에 유효한 모든 "관리비 항목 설정"의 주요 값들(부과 방식, 단가, 부가세 여부, 부과 대상 범위 등)을 해당 청구월에 종속된 별도의 테이블(예: 이전에 논의한 `BillingMonthFeeItemSetting`)에 **복사하여 스냅샷을 생성**합니다.
  - 실제 해당 청구월의 관리비 산정은 이 **복사된 스냅샷 데이터를 기준**으로 이루어집니다. 마스터 설정이 이후에 변경되어도 이미 생성된 청구월의 계산 기준에는 영향을 주지 않습니다.

#### 2. 월별 변동 데이터 (예: 검침값, 외부 고지서 총액)

- **판단:** 이 데이터들은 그 자체로 **특정 청구월에 대한 '거래 데이터'이므로, 자연스럽게 해당 청구월의 스냅샷**이 됩니다.
- QIRO 시스템 적용 방안:
  - "개별 호실 검침 데이터 등록" 등의 기능은 항상 특정 `billingMonthId`와 함께 해당 월의 데이터를 기록합니다. 이 데이터는 다른 월과 독립적입니다.

#### 3. 대상 기초 데이터 (예: 호실 면적, 계약 상태)

- **판단:** 대부분의 경우 계산 시점의 최신 데이터를 **'참조(Reference)'**하되, 특정 기준일의 상태가 중요할 경우 그 상태를 스냅샷으로 기록할 수 있습니다.
- QIRO 시스템 적용 방안:
  - **호실 면적:** 면적은 거의 변하지 않으므로, 계산 시점의 호실 마스터(`Unit`) 테이블에서 직접 참조해도 무방합니다. (만약 면적 변경이 잦고, 과거 특정 시점의 면적으로 계산해야 하는 엄격한 요건이 있다면 면적 변경 이력을 관리하고, 계산 시점의 유효한 면적을 사용해야 합니다.)
  - **호실 상태('계약중'/'공실'):** 관리비 산정 시, 해당 청구월의 특정 기준일(예: 청구월 말일)을 기준으로 `LeaseContract` 정보를 참조하여 '계약중'/'공실' 상태를 판단하고, 이 판단 결과를 계산 로직에 적용합니다.

#### 4. 이월 데이터 (예: 전월 미납액)

- **판단:** 이 데이터는 **직전 청구월의 '완료' 시점의 최종 결과값에 대한 '스냅샷'**입니다.
- QIRO 시스템 적용 방안:
  - "신규 청구월 생성 및 초기값 설정" 기능에서, 직전 청구월이 '완료' 상태일 때만 확정된 미납액 스냅샷을 가져와 새로운 청구월의 "전월 미납액"(`UnitMonthlyUnpaidAmount`)으로 기록합니다.

**결론 요약:**

새로운 청구월을 생성할 때, 관리비 산정에 영향을 주는 항목들의 처리 방식은 다음과 같습니다.

| **데이터 유형**                      | **처리 방식**                                                | **이유**                                       |
| ------------------------------------ | ------------------------------------------------------------ | ---------------------------------------------- |
| **항목 설정값** (단가, 부과 방식 등) | **스냅샷으로 복사** (`BillingMonthFeeItemSetting`에 저장)    | **역사적 데이터 불변성 보장, 감사 추적**       |
| **월별 변동값** (검침량, 총액 등)    | 해당 월의 **거래 데이터로 직접 기록** (자체가 스냅샷)        | 매월 발생하는 고유한 값                        |
| **기초 데이터** (호실 면적, 상태 등) | 계산 시점의 **최신 데이터 참조** (단, 상태는 청구월 기준 판단) | 데이터 변경 빈도가 낮고, 현재 상태 반영이 중요 |
| **이월 데이터** (전월 미납액)        | 직전월의 **최종 결과값(스냅샷)을 복사**                      | 데이터의 순차적 정확성 보장                    |

이러한 원칙에 따라 데이터베이스와 시스템 로직을 설계하면, QIRO 서비스는 정확하고 신뢰할 수 있으며, 이력 추적이 용이한 관리비 산정 기능을 제공할 수 있을 것입니다. 😊
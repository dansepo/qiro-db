# ⚙️ QIRO - 월별 공용 관리비 입력 기능 명세서

## 1. 문서 정보
- **문서명:** QIRO - 월별 공용 관리비 입력 기능 명세서
- **기능 ID (선택 사항):** F-COMMFEE-INPUT-001
- **관련 요구사항 ID:** (예: QIRO-FR-MF-020)
- **관련 사용자 스토리 ID:** (예: US-AS-XXX, US-BM-XXX)
- **작성일:** 2025년 05월 28일
- **최종 수정일:** 2025년 05월 28일
- **작성자:** QIRO 기획팀
- **검토자/승인자 (선택 사항):** (이름 또는 팀)
- **문서 버전:** 1.0

## 2. 기능 개요
### 2.1. 목적
'청구월 관리'에서 선택된 특정 청구월에 대해, 해당 월에 발생한 공용 관리비 중 각 세대에 배분해야 할 항목들의 총 발생 금액을 입력하고 관리한다. 예를 들어, 해당 월의 공용 전기료 총액, 공용 수도료 총액, 건물 전체 청소 용역비 등을 입력하여, 이후 '관리비 산정' 단계에서 세대별로 배분할 기초 데이터를 마련한다.
*(만약 모든 공용 관리비 항목이 '관리비 항목 설정'에서 세대별 고정 단가, 고정 비율 등으로 이미 정의되어 자동 계산될 수 있다면, 이 기능의 필요성 및 범위는 축소되거나 간소화될 수 있다.)*

### 2.2. 설명
본 기능은 관리자가 특정 청구월에 발생한 공용 관리비 항목별 총 금액을 입력, 수정, 조회할 수 있도록 지원한다. 예를 들어, '관리비 항목 설정'에서 '공용 전기료' 항목이 'COMMON_TOTAL_PER_AREA'(월별 공용 발생 총액을 면적 비례 배분) 방식으로 정의된 경우, 관리자는 이 기능을 통해 해당 청구월의 '공용 전기료 총 발생액'을 입력해야 한다.

### 2.3. 범위
- **In-Scope (포함 범위):**
    - 작업 대상 청구월 선택 또는 확인 기능.
    - 선택된 청구월에 대해, 배분이 필요한 공용 관리비 항목 목록 조회.
    - 각 공용 관리비 항목별 해당 월 총 발생 금액 입력 및 수정.
    - (선택) 관련 증빙 자료(영수증 스캔 등) 첨부 기능.
- **Out-of-Scope (제외 범위):**
    - 공용 관리비 항목 자체의 설정 (이는 '관리비 항목 설정'에서 정의).
    - 입력된 총액을 세대별로 배분하는 계산 로직 (이는 '관리비 산정' 기능에서 처리).
    - 고정적으로 매월 동일 금액이 발생하는 공용 관리비 항목의 자동 입력 (향후 고려 가능).

## 3. 사용자 인터페이스 (UI) 및 상호작용
### 3.1. 관련 화면
- `관리자 포털 > 관리비 > 공용 관리비 입력`

### 3.2. UI 요소별 상세 설명
- **화면 1: 월별 공용 관리비 입력 화면**
    | UI 요소 ID (선택) | 요소명 (Label)                    | 유형 (Type)     | 기본값/표시 데이터 | 동작 설명                                                    | 유효성 규칙/제약조건                      | 비고                              |
    | :---------------- | :-------------------------------- | :-------------- | :----------------- | :----------------------------------------------------------- | :---------------------------------------- | :-------------------------------- |
    | CFI-LST-01        | [대상 청구월] 표시/선택           | 텍스트/드롭다운 | (이전 선택 값)     | 현재 작업 대상 청구월을 표시하거나, 변경할 수 있도록 함      | 청구월 상태 `INPUTTING` 또는 `CALC_READY` | 청구월 변경 시 하단 목록 새로고침 |
    | CFI-LST-02        | 공용 관리비 입력 목록             | 표              | -                  | 공용 관리비 항목명, (해당월) 발생 총액 입력 필드, (선택) 증빙 첨부 버튼 등을 표시 |                                           |                                   |
    | CFI-LST-03        | (표 내부) 발생 총액               | 숫자 입력 필드  | (기존값 또는 0)    | 해당 항목의 해당 청구월 총 발생 금액 입력                    | 숫자만 입력, 양수                         |                                   |
    | CFI-LST-04        | (표 내부) [증빙 첨부] 버튼 (선택) | 버튼            | -                  | 해당 항목 금액에 대한 증빙 파일(영수증 등) 업로드 팝업 호출  |                                           | 파일 다중 첨부 가능               |
    | CFI-LST-05        | [저장] 버튼                       | 버튼            | -                  | 화면에 입력/수정된 모든 공용 관리비 정보를 일괄 저장         |                                           |                                   |

### 3.3. 주요 사용자 시나리오 (흐름)
- **시나리오 1: 특정 청구월의 공용 관리비 항목별 총액 입력**
    1. 관리자가 '월별 공용 관리비 입력 화면'에 접속한다.
    2. 시스템은 기본 청구월을 표시하거나 관리자가 [대상 청구월]을 선택한다.
    3. 시스템은 '관리비 항목 설정'에서 '공용 관리비 배분' 방식(예: `COMMON_TOTAL_PER_AREA`)으로 설정된 항목들의 목록을 표시한다.
    4. 관리자는 각 항목별 '발생 총액' 필드에 해당 청구월에 실제로 발생한 금액을 입력한다. (예: 공용 전기료 총액 500,000원)
    5. (선택) 필요한 경우, 각 항목 옆 [증빙 첨부] 버튼을 클릭하여 관련 영수증 등의 파일을 업로드한다.
    6. 관리자가 [저장] 버튼을 클릭한다.
    7. 시스템은 입력된 금액들의 유효성을 검사 후 저장하고, "공용 관리비 정보가 성공적으로 저장되었습니다." 메시지를 표시한다.

## 4. 데이터 요구사항
### 4.1. 입력 데이터
- **선택된 청구월 ID (`billingMonthId`):** (FK, 필수)
- **공용 관리비 항목 ID (`feeItemId`):** (FK, 필수, '관리비 항목 설정'에서 정의된 항목)
- **해당 월 발생 총액 (`totalAmountForMonth`):** (숫자, 필수)
- **(선택) 증빙 파일 정보 (`attachedFiles`):** (파일 경로, 파일명 등)

### 4.2. 출력 데이터 (화면 표시 및 내부 처리용)
- 입력된 공용 관리비 항목별 총액.

### 4.3. 월별 공용 관리비 (MonthlyCommonFee) 엔티티 속성 (예시)
| 속성명 (Attribute)       | 데이터 타입 (Type)  | 필수 (PK/FK) | 설명                                              | 예시/비고                                       |
| :----------------------- | :------------------ | :----------- | :------------------------------------------------ | :---------------------------------------------- |
| `monthlyCommonFeeId`     | UUID / Long         | PK           | 월별 공용 관리비 고유 ID                          |                                                 |
| `billingMonthId`         | UUID / Long         | FK           | 청구월 ID (BillingMonth 참조)                     |                                                 |
| `feeItemId`              | UUID / Long         | FK           | 관리비 항목 ID (FeeItem 참조, 공용 관리비 항목만) |                                                 |
| `totalAmountForMonth`    | BigDecimal / Double | Y            | 해당 청구월에 발생한 해당 항목의 총 금액          |                                                 |
| `description`            | String(500)         | N            | 해당 금액에 대한 추가 설명 또는 메모              | "본사 전기 요금 고지서 기준"                    |
| `attachedFileReferences` | JSON / String       | N            | 첨부된 증빙 파일들의 참조 정보 (S3 경로 등)       | `[{"fileName": "receipt.pdf", "s3Key": "..."}]` |
| `createdBy`              | String              | Y            | 생성자 ID                                         |                                                 |
| `createdAt`              | DateTime            | Y            | 생성 일시                                         |                                                 |
| `lastModifiedBy`         | String              | Y            | 최종 수정자 ID                                    |                                                 |
| `lastModifiedAt`         | DateTime            | Y            | 최종 수정 일시                                    |                                                 |

## 5. 처리 로직 및 비즈니스 규칙
- **R-COMMFEE-INPUT-001:** 작업 대상 청구월은 상태가 `INPUTTING` 또는 `CALC_READY` 여야 한다. 다른 상태에서는 원칙적으로 입력/수정이 제한된다.
- **R-COMMFEE-INPUT-002:** '관리비 항목 설정'에서 공용 관리비 배분 방식(예: `COMMON_TOTAL_PER_AREA`, `COMMON_TOTAL_PER_SHARE`)으로 지정된 항목들만 이 화면의 입력 대상으로 표시되어야 한다.
- **R-COMMFEE-INPUT-003:** '발생 총액'은 양수 또는 0 값만 입력 가능하다.
- **R-COMMFEE-INPUT-004:** 이미 '관리비 산정'이 완료된 청구월의 공용 관리비 총액을 수정할 경우, "이미 관리비 산정이 완료된 데이터입니다. 수정 시 관리비 재산정이 필요합니다." 와 같은 경고 메시지를 표시하고, 재산정 필요 상태로 변경하거나 관련 담당자에게 알림을 줄 수 있다.

## 6. 오류 처리 및 예외 관리
| 오류 코드 (선택)   | 발생 조건                                     | 오류 메시지 (User-facing)                                    | 시스템 처리 방안                   |
| :----------------- | :-------------------------------------------- | :----------------------------------------------------------- | :--------------------------------- |
| E-COMMFEE-INPUT-01 | 숫자 필드(발생 총액)에 문자 입력 등 형식 오류 | "금액은 숫자로 입력해야 합니다."                             | 저장 차단, 해당 필드에 오류 표시   |
| E-COMMFEE-INPUT-02 | 마감된 청구월 데이터 수정 시도                | "마감된 청구월의 공용 관리비는 수정할 수 없습니다."          | 수정 차단, 안내 메시지 표시        |
| E-COMMFEE-INPUT-03 | (파일 첨부 시) 허용되지 않은 파일 형식/크기   | "허용되지 않는 파일 형식 또는 크기입니다. ([허용 목록/크기])" | 파일 업로드 차단, 안내 메시지 표시 |

## 7. (기능별) 성능 요구사항
- P-COMMFEE-INPUT-01: 공용 관리비 입력 화면 로드 시 (항목 수 50개 미만 기준) 1초 이내 응답.
- P-COMMFEE-INPUT-02: 입력된 공용 관리비 정보 저장 시 1초 이내 처리 완료.

## 8. (기능별) 보안 요구사항
- S-COMMFEE-INPUT-01: 공용 관리비 입력 기능은 '관리소장', '경리담당자' 등 인가된 역할만 접근 가능하다.
- S-COMMFEE-INPUT-02: 공용 관리비 금액 입력/수정 시 작업자, 시간, 변경 전/후 값 등의 이력을 감사 로그로 기록한다.

## 9. 다른 기능/모듈과의 연관성
- **청구월 관리:** 본 기능은 '청구월 관리'에서 선택된 특정 청구월을 컨텍스트로 하여 수행된다.
- **관리비 항목 설정:** 본 기능에서 입력 대상으로 표시되는 공용 관리비 항목들은 '관리비 항목 설정'에서 정의된 정보(특히 배분 방식이 지정된 항목)를 기반으로 한다.
- **관리비 산정:** 본 기능에서 입력된 각 공용 관리비 항목의 '해당 월 발생 총액'은 '관리비 산정' 기능에서 해당 항목을 각 세대에 배분 계산하는 데 사용되는 핵심 입력 데이터가 된다.

## 10. (선택 사항) 테스트 고려 사항
- 다양한 공용 관리비 항목에 대한 금액 입력 및 저장 테스트.
- 청구월 상태 변경에 따른 입력/수정 제한 기능 테스트.
- (파일 첨부 기능 구현 시) 다양한 형식 및 크기의 파일 첨부 테스트.

## 11. 용어 정의 (선택 사항)
- **공용 관리비 (Common Area Maintenance Fee):** 건물의 공용 부분 유지관리를 위해 발생하는 비용으로, 전체 발생액을 일정한 기준(면적, 세대수 등)에 따라 각 세대에 배분하여 부과하는 관리비 항목. (예: 공용 전기료, 공용 수도료, 청소비, 경비비 등)

## 12. 문서 이력
| 버전 | 날짜       | 작성자      | 주요 변경 내용   |
| :--- | :--------- | :---------- | :--------------- |
| 1.0  | 2025-05-28 | QIRO 기획팀 | 초기 명세서 작성 |
# ⚙️ QIRO - 관리비 항목 관리 기능 명세서

## 1. 문서 정보
- **문서명:** QIRO - 관리비 항목 관리 기능 명세서
- **기능 ID (선택 사항):** F-FEE-SETUP-001
- **관련 요구사항 ID:** (예: QIRO-FR-MF-001, QIRO-FR-MF-005)
- **관련 사용자 스토리 ID:** (예: US-BM-XXX, US-SA-XXX)
- **작성일:** 2025년 06월 11일
- **최종 수정일:** 2025년 06월 11일
- **작성자:** QIRO 기획팀
- **검토자/승인자 (선택 사항):** (이름 또는 팀)
- **문서 버전:** 2.0 (주요 정책 변경 사항 종합 반영 최종본)

## 2. 기능 개요
### 2.1. 목적
QIRO 서비스 내에서 **정기적이고 반복적으로 사용될 표준 관리비 항목의 마스터 정보를 생성하고 관리**한다. 각 항목의 부과 방식(고정액, 면적 비례 등), 기준 금액/단가, 과세 여부, 그리고 어떤 호실 그룹에 부과할지에 대한 기본 규칙을 사전에 정의하여, 매월 관리비 산정 업무의 일관성과 자동화 수준을 높이는 것을 목표로 한다.

### 2.2. 설명
본 기능은 관리비 항목 마스터 데이터에 대한 CRUD(생성, 조회, 수정, 삭제/비활성화) 기능을 제공한다. 여기서 등록된 항목은 시스템 전반에서 재사용 가능한 '부과 규칙 템플릿' 역할을 한다. 항목의 유효성은 `상태(사용/사용 중지)` 값으로 관리하며, 신규 등록되거나 '사용 중지'에서 '사용' 상태로 변경된 항목은 **익월 청구분부터 적용**된다. **비정기적이거나 특정 세대에만 일회성으로 부과되는 비용은 본 기능이 아닌, "월별 관리비 입력" 화면에서 직접 추가**하는 방식으로 처리한다.

### 2.3. 범위
- **In-Scope (포함 범위):**
    - 표준(마스터) 관리비 항목 생성, 조회, 수정, 상태 변경(사용/사용 중지).
    - 항목별 주요 속성 정의: 항목명, 유형, 과세 여부, 배분 기준, 기준 금액/단가, 단위.
    - **부과 대상 호실 범위 기본 규칙 지정:** `전체호실`, `계약중인 호실`, `공실`, `선택한 호실`.
    - 항목 삭제(논리적 삭제 또는 비활성화).
- **Out-of-Scope (제외 범위):**
    - **적용 시작일/종료일에 의한 기간별 항목 관리 기능 (삭제됨).**
    - **일회성 비용의 직접 부과 기능 (이는 "월별 관리비 입력" 기능에서 처리).**
    - 계량기 사용량에 직접 연동되는 전기, 수도, 가스 등 공과금 항목의 상세 요금 정책 관리 (별도 기능).
    - 관리비 항목별 회계 계정 연동 (별도 회계 설정 기능).

## 3. 사용자 인터페이스 (UI) 및 상호작용
### 3.1. 관련 화면
- `관리자 포털 > 설정 > 관리비 설정 > 관리비 항목 정의`

### 3.2. UI 요소별 상세 설명
- **화면 1: 관리비 항목 목록 조회 화면**
    | UI 요소 ID (선택) | 요소명 (Label)         | 유형 (Type)      | 기본값/표시 데이터  | 동작 설명                                                    | 비고               |
    | :---------------- | :--------------------- | :--------------- | :------------------ | :----------------------------------------------------------- | :----------------- |
    | FI-LST-03         | **[+ 항목 추가]** 버튼 | 버튼             | -                   | '관리비 항목 등록 폼 화면'(팝업) 표시                        |                    |
    | FI-LST-04         | 관리비 항목 목록       | 표               | -                   | 등록된 관리비 항목 마스터를 표 형태로 표시                   | 정렬 기능 제공     |
    | (표 컬럼)         | 항목명                 | 텍스트           | (예: 일반관리비)    |                                                              |                    |
    | (표 컬럼)         | 유형                   | 텍스트           | (예: 공용 관리비)   |                                                              |                    |
    | (표 컬럼)         | **부과 대상**          | 텍스트           | (예: 전체호실)      | 이 항목이 부과되는 호실 범위 (전체, 계약중, 공실, 선택(X개)) |                    |
    | (표 컬럼)         | 배분 기준              | 텍스트           | (예: 전용면적 비율) |                                                              |                    |
    | (표 컬럼)         | 단가/금액              | 숫자/통화        | (예: 1,200)         |                                                              |                    |
    | (표 컬럼)         | 상태                   | 텍스트(배지)     | (예: 사용)          | 항목의 사용 상태 (사용/사용 중지)                            | 상태별 시각적 구분 |
    | (표 컬럼)         | 관리                   | 아이콘 버튼 그룹 | -                   | 수정, 삭제 기능 제공                                         |                    |

- **화면 2: 관리비 항목 등록/수정 폼 (모달)**
    * **모달 제목:** `관리비 항목 등록` / `관리비 항목 수정`
    | UI 요소 ID (선택) | 요소명 (Label)          | 유형 (Type)          | 예시/설명                                                    | 유효성 규칙/제약조건                                      |
    | :---------------- | :---------------------- | :------------------- | :----------------------------------------------------------- | :-------------------------------------------------------- |
    | FI-FRM-02         | 항목명                  | 입력 필드            | (예: 특별 대청소비)                                          | 필수, 중복 불가                                           |
    | FI-FRM-03         | 유형                    | 드롭다운             | 공용 관리비, 기타 부과금 등                                  | 필수                                                      |
    | FI-FRM-03b        | 배분 기준               | 드롭다운             | 전용면적 비율, 호실 균등 등                                  | 필수                                                      |
    | FI-FRM-04         | 단가/금액               | 숫자 입력 필드       | (배분 기준에 따른 단가 또는 총액)                            | (배분 기준별 유효성)                                      |
    | FI-FRM-06a        | 상태                    | 드롭다운/라디오      | 사용, 사용 중지 (기본값: '사용')                             |                                                           |
    | **FI-FRM-APPLY**  | **부과 대상 호실 설정** | 라디오 버튼 그룹     | `(●) 전체호실` `( ) 계약중인 호실` `( ) 공실` `( ) 선택한 호실` | 필수 선택, '선택한 호실' 선택 시 아래 호실 선택 UI 활성화 |
    | FI-FRM-APPLY-SEL  | [호실 선택] 버튼        | 버튼 (조건부 활성화) | 클릭 시 호실 선택 모달 팝업 표시                             | 위 라디오 버튼에서 '선택한 호실' 선택 시 활성화           |
    | FI-FRM-APPLY-LIST | 선택된 호실 목록        | 텍스트/태그 리스트   | (예: 101호, 102호, 201호)                                    | (읽기 전용, 호실 선택 모달에서 관리)                      |
    | FI-FRM-10         | [저장] 버튼             | 버튼                 |                                                              |                                                           |

### 3.3. 주요 사용자 시나리오 (흐름)
- **시나리오 1: '계약중인 호실'에만 부과되는 정기 관리비 항목 등록**
    1. 관리자가 [+ 항목 추가] 버튼을 클릭한다.
    2. '관리비 항목 등록 폼'에서 항목명(예: "입주민 커뮤니티 회비"), 부과 방식(예: "세대별 고정액 부과"), 금액(예: "5,000") 등 기본 정보를 입력한다.
    3. "부과 대상 호실 설정" 섹션에서 `(●) 계약중인 호실` 라디오 버튼을 선택한다.
    4. [저장] 버튼을 클릭한다.
    5. 시스템은 유효성 검사 후 항목을 저장한다. 이 항목은 **익월 관리비 산정 시부터** '계약중' 상태인 호실들에게만 5,000원씩 부과된다.
- **시나리오 2: '사용 중지' 항목을 다시 '사용'으로 변경**
    1. 관리자가 목록에서 '사용 중지' 상태인 항목(예: "춘계 특별 방역비")을 선택하여 수정 모달을 연다.
    2. 관리자가 '상태'를 '사용'으로 변경한다.
    3. [저장] 버튼을 클릭한다.
    4. 시스템은 변경 사항을 저장한다. 이 항목은 **상태를 변경한 시점의 다음 청구월부터** 관리비 산정 대상에 다시 포함된다.

## 4. 데이터 요구사항
### 4.1. 관리비 항목 (FeeItem) 엔티티 속성
| 속성명 (Attribute)              | 데이터 타입      | 필수       | 설명                                                         | 예시/비고                                   |
| :------------------------------ | :--------------- | :--------- | :----------------------------------------------------------- | :------------------------------------------ |
| `fee_item_id`                   | `UUID`           | Y          | 관리비 항목 고유 ID                                          |                                             |
| `item_name`                     | `VARCHAR(100)`   | Y          | 항목명                                                       | "일반관리비", "특별 대청소비"               |
| `imposition_method`             | `VARCHAR(30)`    | Y          | 부과(배분) 방식 코드                                         | `FIXED_AMOUNT_PER_UNIT`, `PER_AREA_RATE` 등 |
| `unit_price`                    | `NUMERIC(15, 2)` | (조건부 Y) | 단가 (또는 고정액/총액)                                      |                                             |
| `unit`                          | `VARCHAR(20)`    | (조건부 Y) | 단위                                                         | "원/세대", "원/㎡"                          |
| `is_vat_applicable`             | `BOOLEAN`        | Y          | 부가세 적용 여부                                             |                                             |
| **`application_scope_type`**    | `VARCHAR(30)`    | Y          | **부과 대상 호실 범위 유형** (`ALL_UNITS`, `LEASED_UNITS`, `VACANT_UNITS`, `SELECTED_UNITS`) |                                             |
| **`application_scope_details`** | `JSONB`          | (조건부 Y) | **선택된 호실 ID 목록** (`application_scope_type`이 `SELECTED_UNITS`일 경우) | `["unit-uuid-101", "unit-uuid-102"]`        |
| `is_active`                     | `BOOLEAN`        | Y          | 사용 여부 (이전 'status' 필드 역할)                          | `true` / `false`                            |
| `description`                   | `TEXT`           | N          | 항목 설명                                                    |                                             |
| ... (감사 필드)                 |                  |            |                                                              |                                             |

## 5. 처리 로직 및 비즈니스 규칙
- **R-FEE-SETUP-001 (수정):** `item_name`은 시스템 내에서 고유해야 한다.
- **R-FEE-SETUP-004 (수정):** 이미 관리비 산정에 사용된 항목은 삭제할 수 없으며, 대신 `is_active` 상태를 `false`('사용 중지')로 변경하여 더 이상 사용되지 않도록 한다.
- **R-FEE-SETUP-006 (수정):** 신규로 등록된 관리비 항목은 등록(생성) 시점(`created_at`)이 속한 청구월의 **다음 청구월부터** 관리비 산정 시 사용 가능하다.
- **R-FEE-SETUP-007 (수정):** `is_active`가 `false`인 항목을 `true`로 변경할 경우, 해당 항목은 **상태 변경 시점(`last_modified_at`)**이 속한 청구월의 **다음 청구월부터** 적용된다.
- **R-FEE-SETUP-008 (신규): 부과 대상 호실 결정 로직:**
    - "관리비 산정" 기능은 특정 `FeeItem`을 각 세대에 부과하기 전에, 해당 `FeeItem`의 `application_scope_type`을 먼저 확인한다.
    - `ALL_UNITS`: 해당 건물의 모든 활성 호실에 부과.
    - `LEASED_UNITS`: 산정 시점의 '계약중' 상태인 호실에만 부과.
    - `VACANT_UNITS`: 산정 시점의 '공실' 상태인 호실에만 부과.
    - `SELECTED_UNITS`: `application_scope_details`에 저장된 호실 ID 목록에 해당하는 호실에만 부과.
- **R-FEE-SETUP-009 (신규):** `application_scope_type`이 `SELECTED_UNITS`일 경우, `application_scope_details`에 최소 하나 이상의 호실 ID가 포함되어야 한다.

## 6. 오류 처리 및 예외 관리
| 오류 코드 (선택)          | 발생 조건                                   | 오류 메시지 (User-facing)                                    |
| :------------------------ | :------------------------------------------ | :----------------------------------------------------------- |
| (기존 오류 유지)          | ...                                         | ...                                                          |
| **E-FEE-SETUP-07 (신규)** | '선택한 호실' 부과 방식 선택 후 호실 미지정 | "부과 대상을 '선택한 호실'로 지정한 경우, 하나 이상의 호실을 선택해야 합니다." |

*(이하 7~12절은 이전 버전의 관련 명세서들과 유사한 내용으로 구성됩니다.)*

### 7. (기능별) 성능 요구사항
- P-FEE-SETUP-01: 관리비 항목 목록 조회 시 (100개 항목 기준) 1초 이내 응답.
- P-FEE-SETUP-02: 관리비 항목 저장(생성/수정) 시 1초 이내 처리 완료.

### 8. (기능별) 보안 요구사항
- S-FEE-SETUP-01: 관리비 항목 설정 기능은 '총괄관리자' 또는 '관리소장' 역할(또는 이에 준하는 권한을 가진 역할)만 접근 가능하다.
- S-FEE-SETUP-02: 관리비 항목의 변경(생성, 수정, 삭제, 상태 변경) 이력은 감사 로그에 기록되어야 한다.

### 9. 다른 기능/모듈과의 연관성
- **관리비 산정:** 본 기능에서 설정된 `부과 방식`과 **`부과 대상 호실 범위`**는 '관리비 산정' 기능에서 어떤 호실에 얼마를 부과할지 결정하는 핵심 규칙으로 사용된다.
- **호실 정보 관리:** '선택한 호실' 지정 시 호실 목록을 참조한다. 또한, '계약중인 호실', '공실' 등의 상태는 '호실 정보'의 최신 상태를 기준으로 판단한다.

### 10. (선택 사항) 테스트 고려 사항
- **(신규)** 부과 대상 호실 범위(`전체`, `계약중`, `공실`, `선택`)별로 항목을 설정하고, 관리비 산정 시 해당 조건에 맞는 호실에만 정확히 부과되는지 연계 테스트.
- (삭제) 적용 시작일/종료일에 따른 적용 여부 테스트.
- **(수정)** 신규 등록 또는 상태 변경('사용 중지'->'사용') 후, 바로 다음 청구월부터 해당 항목이 산정에 포함되는지 테스트.

### 11. 용어 정의 (선택 사항)
- **부과 대상 호실 범위 (Application Scope):** 특정 관리비 항목이 부과될 호실들을 지정하는 규칙. (예: 전체, 계약중인 호실 등)

### 12. 문서 이력
| 버전    | 날짜           | 작성자          | 주요 변경 내용                                               |
| :------ | :------------- | :-------------- | :----------------------------------------------------------- |
| 1.3     | 2025-05-28     | QIRO 기획팀     | (이전 내용 요약) 항목 재사용 시 익월 적용 규칙 반영          |
| **1.4** | **2025-06-09** | **QIRO 기획팀** | **적용 시작일/종료일 필드 삭제 및 상태 기반 관리로 변경. 부과 대상 호실 지정 기능 추가.** |
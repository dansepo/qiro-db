# ⚙️ QIRO - 세대별 공과금(검침값) 입력 기능 명세서

## 1. 문서 정보
- **문서명:** QIRO - 세대별 공과금(검침값) 입력 기능 명세서
- **기능 ID (선택 사항):** F-UTIL-INPUT-001
- **관련 요구사항 ID:** (예: QIRO-FR-MF-010)
- **관련 사용자 스토리 ID:** (예: US-BM-XXX, US-AS-XXX)
- **작성일:** 2025년 05월 28일
- **최종 수정일:** 2025년 05월 28일
- **작성자:** QIRO 기획팀
- **검토자/승인자 (선택 사항):** (이름 또는 팀)
- **문서 버전:** 1.0

## 2. 기능 개요
### 2.1. 목적
'청구월 관리'에서 선택된 특정 청구월에 대해, 각 세대의 개별 사용량 기반 공과금(예: 전기료, 수도료, 가스료 등) 부과를 위한 검침값을 입력, 수정 및 조회한다. 정확한 검침값 입력을 통해 세대별 사용량에 따른 공정한 관리비 부과를 지원한다.

### 2.2. 설명
본 기능은 관리자가 특정 '청구월' 컨텍스트 하에서 해당 건물 또는 특정 동의 세대 목록을 조회하고, 각 세대별로 전기, 수도, 가스 등의 당월 검침값을 입력하거나 수정할 수 있게 한다. 입력된 검침값을 바탕으로 시스템은 자동으로 전월 대비 사용량을 계산하여 보여줄 수 있다.

### 2.3. 범위
- **In-Scope (포함 범위):**
    - 작업 대상 청구월 선택 또는 확인 기능.
    - 선택된 청구월에 대한 세대 목록 조회 (건물/동 필터링 기능 포함).
    - 세대별 검침 항목(예: 전기, 수도, 난방 등)에 대한 당월 검침값 입력 및 수정.
    - 전월 검침값 표시 및 당월 사용량 자동 계산 표시.
    - 검침값 일괄 입력 지원 (예: 엑셀 업로드).
- **Out-of-Scope (제외 범위):**
    - 검침 항목 자체의 설정 (이는 '관리비 항목 설정' 또는 별도 '공과금 항목 설정' 기능에서 정의).
    - 원격 검침(AMI) 시스템 연동 (향후 확장 고려).
    - 입력된 검침값을 사용한 관리비 최종 산정 (이는 '관리비 산정' 기능에서 처리).

## 3. 사용자 인터페이스 (UI) 및 상호작용
### 3.1. 관련 화면
- `관리자 포털 > 관리비 > 공과금 입력 (또는 세대 검침값 입력)`

### 3.2. UI 요소별 상세 설명
- **화면 1: 공과금 입력 화면 (세대 목록 및 입력 폼)**
    | UI 요소 ID (선택) | 요소명 (Label)            | 유형 (Type)       | 기본값/표시 데이터 | 동작 설명                                                    | 유효성 규칙/제약조건                      | 비고                              |
    | :---------------- | :------------------------ | :---------------- | :----------------- | :----------------------------------------------------------- | :---------------------------------------- | :-------------------------------- |
    | UI-LST-01         | [대상 청구월] 표시/선택   | 텍스트/드롭다운   | (이전 선택 값)     | 현재 작업 대상 청구월을 표시하거나, 변경할 수 있도록 함      | 청구월 상태 `INPUTTING` 또는 `CALC_READY` | 청구월 변경 시 하단 목록 새로고침 |
    | UI-LST-02         | [건물/동] 필터            | 드롭다운          | 전체               | 특정 건물 또는 동의 세대만 필터링하여 조회                   |                                           |                                   |
    | UI-LST-03         | [엑셀 업로드] 버튼        | 버튼              | -                  | 검침값 일괄 업로드를 위한 엑셀 파일 선택 창 호출             |                                           |                                   |
    | UI-LST-04         | [엑셀 양식 다운로드] 버튼 | 버튼              | -                  | 검침값 일괄 업로드용 엑셀 템플릿 다운로드                    |                                           |                                   |
    | UI-LST-05         | 세대별 검침값 입력 목록   | 표                | -                  | 동/호수, 세대주명, (검침항목1)전월값, (항목1)당월값, (항목1)사용량, (항목2)전월값... 등을 표시/입력 |                                           | 스크롤, 정렬 기능                 |
    | UI-LST-06         | (표 내부) 당월 검침값     | 숫자 입력 필드    | (기존값 또는 공백) | 해당 세대, 해당 항목의 당월 검침값 입력                      | 숫자만 입력, 전월값 이상 권장             | 입력 시 사용량 자동 계산          |
    | UI-LST-07         | (표 내부) 사용량          | 텍스트 (읽기전용) | (자동계산 값)      | 당월 검침값 - 전월 검침값                                    |                                           | 음수일 경우 경고 표시             |
    | UI-LST-08         | [저장] 버튼               | 버튼              | -                  | 화면에 입력/수정된 모든 검침값 정보를 일괄 저장              |                                           |                                   |

### 3.3. 주요 사용자 시나리오 (흐름)
- **시나리오 1: 개별 세대 검침값 입력 및 저장**
    1. 관리자가 '공과금 입력 화면'에 접속한다.
    2. 시스템은 기본적으로 가장 최근의 '입력 중' 상태인 청구월을 표시하거나, 관리자가 [대상 청구월]을 선택한다.
    3. 관리자는 필요시 [건물/동] 필터를 사용하여 특정 세대 목록을 조회한다.
    4. 목록에서 검침값을 입력할 세대의 해당 공과금 항목(예: 전기) '당월 검침값' 필드에 값을 입력한다.
    5. 시스템은 입력과 동시에 '사용량' 필드에 (당월 검침값 - 전월 검침값)을 계산하여 표시한다. (만약 당월값이 전월값보다 작으면 경고 UI 표시)
    6. 관리자가 여러 세대 또는 여러 항목에 대해 입력을 반복한다.
    7. 관리자가 [저장] 버튼을 클릭한다.
    8. 시스템은 입력된 모든 검침값을 유효성 검사 후 저장하고, "검침값이 성공적으로 저장되었습니다." 메시지를 표시한다.
- **시나리오 2: 엑셀 파일로 검침값 일괄 업로드**
    1. 관리자가 '공과금 입력 화면'에서 [엑셀 양식 다운로드] 버튼을 클릭하여 템플릿을 받는다.
    2. 템플릿에 맞춰 세대별/항목별 당월 검침값을 입력 후 파일을 저장한다.
    3. 관리자가 [엑셀 업로드] 버튼을 클릭하여 해당 파일을 선택하고 업로드한다.
    4. 시스템은 업로드된 파일의 데이터를 검증한다.
        - 성공 시: 검증된 데이터를 화면 목록에 반영(표시)하고, 관리자가 확인 후 [저장] 버튼을 누르면 최종 저장된다. (또는, 업로드 즉시 저장 옵션)
        - 실패 시: 오류 내용(예: 형식 오류, 존재하지 않는 세대 등)과 해당 데이터 위치를 사용자에게 안내하고, 수정을 요청한다.

## 4. 데이터 요구사항
### 4.1. 입력 데이터
- **선택된 청구월 ID (`billingMonthId`):** (FK, 필수)
- **세대 ID (`unitId`):** (FK, 필수, 각 행(세대)을 식별)
- **검침 항목 코드 (`utilityTypeCode`):** (FK, 필수, 예: `ELEC` (전기), `WATER` (수도), `GAS` (가스))
- **당월 검침값 (`currentMeterReading`):** (숫자, 필수)
- **(선택) 검침일 (`readingDate`):** (날짜, YYYY-MM-DD)

### 4.2. 출력 데이터 (화면 표시 및 내부 처리용)
- 입력된 당월 검침값
- **계산된 사용량 (`usage`):** (숫자, 당월 검침값 - 전월 검침값)
- **전월 검침값 (`previousMeterReading`):** (숫자, 이전 청구월의 해당 항목 당월 검침값)

### 4.3. 세대별 월별 공과금 (UnitUtilityMonth) 엔티티 속성 (예시)
| 속성명 (Attribute)     | 데이터 타입 (Type)  | 필수 (PK/FK) | 설명                                                | 예시/비고                                  |
| :--------------------- | :------------------ | :----------- | :-------------------------------------------------- | :----------------------------------------- |
| `unitUtilityMonthId`   | UUID / Long         | PK           | 세대별 월별 공과금 고유 ID                          |                                            |
| `billingMonthId`       | UUID / Long         | FK           | 청구월 ID (BillingMonth 참조)                       |                                            |
| `unitId`               | UUID / Long         | FK           | 세대 ID (Unit 참조)                                 |                                            |
| `utilityTypeCode`      | String(20)          | FK           | 공과금 항목 코드 (UtilityType 참조)                 | `ELEC`, `WATER`, `GAS`                     |
| `previousMeterReading` | BigDecimal / Double | Y            | 전월 검침값 (해당월의 기초값)                       |                                            |
| `currentMeterReading`  | BigDecimal / Double | Y            | 당월 검침값                                         |                                            |
| `usage`                | BigDecimal / Double | Y            | 사용량 (currentMeterReading - previousMeterReading) | 자동 계산 또는 직접 입력 가능(정책에 따라) |
| `readingDate`          | Date                | N            | 검침일                                              | YYYY-MM-DD                                 |
| `createdBy`            | String              | Y            | 생성자 ID                                           |                                            |
| `createdAt`            | DateTime            | Y            | 생성 일시                                           |                                            |
| `lastModifiedBy`       | String              | Y            | 최종 수정자 ID                                      |                                            |
| `lastModifiedAt`       | DateTime            | Y            | 최종 수정 일시                                      |                                            |

## 5. 처리 로직 및 비즈니스 규칙
- **R-UTIL-INPUT-001:** 작업 대상 청구월은 상태가 `INPUTTING` 또는 `CALC_READY` 여야 한다. 다른 상태에서는 원칙적으로 입력/수정이 제한된다.
- **R-UTIL-INPUT-002:** 당월 검침값 입력 시, 시스템은 자동으로 해당 세대의 동일 항목에 대한 전월 마감 검침값을 '전월 검침값'으로 화면에 표시해야 한다. (최초 입력월의 경우 전월 검침값은 0 또는 초기 설정값)
- **R-UTIL-INPUT-003:** 사용량은 `당월 검침값 - 전월 검침값`으로 자동 계산된다.
- **R-UTIL-INPUT-004:** 당월 검침값이 전월 검침값보다 작을 경우, 사용자에게 경고 메시지를 표시하고 확인을 요청한다 (예: 계량기 교체 등의 특수 상황일 수 있음). 관리자는 경고를 인지하고 강제 저장할 수 있다.
- **R-UTIL-INPUT-005:** 엑셀 일괄 업로드 시, 템플릿 양식 준수 여부 및 데이터 유효성(숫자 항목, 세대 존재 여부 등)을 검증해야 한다. 오류 발생 시 상세 내용을 사용자에게 피드백한다.
- **R-UTIL-INPUT-006:** 이미 '관리비 산정'이 완료된 청구월의 검침값을 수정할 경우, "이미 관리비 산정이 완료된 데이터입니다. 수정 시 관리비 재산정이 필요합니다." 와 같은 경고 메시지를 표시하고, 재산정 필요 상태로 변경하거나 관련 담당자에게 알림을 줄 수 있다.

## 6. 오류 처리 및 예외 관리
| 오류 코드 (선택) | 발생 조건                             | 오류 메시지 (User-facing)                                 | 시스템 처리 방안                                  |
| :--------------- | :------------------------------------ | :-------------------------------------------------------- | :------------------------------------------------ |
| E-UTIL-INPUT-01  | 숫자 필드에 문자 입력 등 형식 오류    | "검침값은 숫자로 입력해야 합니다."                        | 저장 차단, 해당 필드에 오류 표시                  |
| E-UTIL-INPUT-02  | 존재하지 않는 세대 정보로 업로드 시도 | "존재하지 않는 세대(OO동 OO호) 정보가 포함되어 있습니다." | 해당 데이터 제외 또는 전체 업로드 실패 처리, 안내 |
| E-UTIL-INPUT-03  | 마감된 청구월 데이터 수정 시도        | "마감된 청구월의 검침값은 수정할 수 없습니다."            | 수정 차단, 안내 메시지 표시                       |
| E-UTIL-INPUT-04  | (엑셀 업로드) 필수 항목 누락          | "엑셀 파일에 필수 항목 [항목명]이 누락되었습니다."        | 업로드 실패, 안내 메시지 표시                     |

## 7. (기능별) 성능 요구사항
- P-UTIL-INPUT-01: 세대 목록(최대 500세대) 및 검침 항목 조회 시 2초 이내 응답.
- P-UTIL-INPUT-02: 입력된 검침값 저장 시 (다수 세대 동시 저장) 3초 이내 처리 완료.
- P-UTIL-INPUT-03: 엑셀 파일(500세대 기준) 업로드 및 데이터 검증 시 10초 이내 완료.

## 8. (기능별) 보안 요구사항
- S-UTIL-INPUT-01: 공과금 입력 기능은 '관리소장', '경리담당자' 등 인가된 역할만 접근 가능하다.
- S-UTIL-INPUT-02: 검침값 입력/수정 시 작업자, 시간, 변경 전/후 값 등의 이력을 감사 로그로 기록한다.

## 9. 다른 기능/모듈과의 연관성
- **청구월 관리:** 본 기능은 '청구월 관리'에서 선택된 특정 청구월을 컨텍스트로 하여 수행된다. 청구월의 상태에 따라 본 기능의 사용 가능 여부(입력/수정 제한 등)가 결정된다.
- **관리비 항목 설정:** 본 기능에서 입력받는 공과금 항목(전기, 수도 등)은 '관리비 항목 설정'에서 정의된 항목 정보를 참조하거나 연계될 수 있다. (특히, 사용량 기반 항목)
- **관리비 산정:** 본 기능에서 입력/확정된 세대별 사용량은 '관리비 산정' 기능에서 해당 항목의 관리비를 계산하는 주요 입력 데이터가 된다.

## 10. (선택 사항) 테스트 고려 사항
- 다양한 세대 수에 대한 검침값 입력 및 저장 테스트 (개별/일괄).
- 전월 검침값 대비 당월 검침값 입력 시 경고 및 예외 처리 테스트 (작은 값, 동일한 값 등).
- 엑셀 업로드 시 다양한 오류 케이스(형식 오류, 데이터 누락, 비존재 세대) 테스트.
- 청구월 상태 변경에 따른 입력/수정 제한 기능 테스트.
- 사용량 자동 계산 로직 정확성 검증.

## 11. 용어 정의 (선택 사항)
- **검침값 (Meter Reading):** 전기, 수도, 가스 등 사용량을 측정하는 계량기의 지침 값.
- **사용량 (Usage):** 특정 기간 동안 사용한 양 (당월 검침값 - 전월 검침값).

## 12. 문서 이력
| 버전 | 날짜       | 작성자      | 주요 변경 내용   |
| :--- | :--------- | :---------- | :--------------- |
| 1.0  | 2025-05-28 | QIRO 기획팀 | 초기 명세서 작성 |
#  QIRO - 개별 호실 검침 데이터 등록 기능 명세서

## 1. 문서 정보
- **문서명:** QIRO - 개별 호실 검침 데이터 등록 기능 명세서
- **기능 ID (선택 사항):** F-UNITMTR-001 (Unit Meter Reading)
- **관련 요구사항 ID:** (예: QIRO-FR-FE-006, QIRO-FR-FE-007)
- **관련 사용자 스토리 ID:** (예: US-BM-XXX, US-AS-XXX)
- **작성일:** 2025년 06월 02일
- **최종 수정일:** 2025년 06월 02일
- **작성자:** QIRO 기획팀
- **검토자/승인자 (선택 사항):** (이름 또는 팀)
- **문서 버전:** 1.0

## 2. 기능 개요
### 2.1. 목적
특정 청구월에 대해 관리 대상 건물 내 각 개별 호실(세대)에서 사용한 전기, 수도, 가스, 난방 등 계량 가능한 공과금의 사용량을 정확히 파악하기 위해, 해당 호실별 계량기의 검침 데이터를 체계적으로 등록, 조회, 수정 및 관리한다. 이는 각 세대별 사용량에 기반한 공정하고 투명한 관리비 부과의 핵심 기초 자료를 제공한다.

### 2.2. 설명
본 기능은 관리자가 작업 대상 청구월과 건물을 선택한 후, 해당 건물의 각 호실별로 설치된 개별 계량기(전기, 수도, 가스, 난방 등)의 검침일 및 당월 지침 값을 입력할 수 있도록 지원한다. 시스템은 입력된 당월 지침과 자동으로 조회된 전월 지침을 바탕으로 해당 월의 호실별 사용량을 계산하여 표시한다. 대량의 데이터를 효율적으로 처리하기 위해 엑셀을 통한 일괄 업로드 기능도 제공된다. 이렇게 등록된 데이터는 "관리비 산정" 시 각 호실별 사용량 기반 요금 부과의 직접적인 근거로 활용된다.

### 2.3. 범위
- **In-Scope (포함 범위):**
    - 작업 대상 청구월 선택 기능.
    - 작업 대상 건물 (및 필요시 동/라인) 선택 필터링 기능.
    - 선택된 범위 내 호실 목록 및 각 호실별 개별 공과금 항목(계량기) 표시.
    - 호실별/공과금 항목별 검침일 및 당월 검침 지침 값 입력, 수정, (제한적) 삭제 기능.
    - 전월 검침 지침 자동 표시 (이력 기반).
    - 당월 사용량 자동 계산 및 표시.
    - 엑셀 템플릿을 이용한 검침 데이터 일괄 업로드 및 검증 기능.
    - 특정 청구월/호실의 개별 검침 기록 목록 조회.
- **Out-of-Scope (제외 범위):**
    - 개별 호실 계량기 자체의 등록 및 상세 정보 관리 (이는 "시설 점검 및 유지보수 관리" 기능에서 '시설물'로 등록되거나, 별도의 '호실별 계량기 정보 관리' 기능에서 처리 가능).
    - 검침된 사용량을 바탕으로 한 실제 요금 계산 상세 로직 (단가 적용 및 금액 산출은 "관리비 항목 설정" 및 "관리비 산정" 기능에서 처리).
    - 공용 시설 검침값 입력 (이는 별도의 "공용 시설 검침 데이터 등록" 기능).
    - 스마트미터링(AMI) 시스템과의 자동 검침 데이터 연동 (향후 확장 고려).

## 3. 사용자 인터페이스 (UI) 및 상호작용
### 3.1. 관련 화면
- `관리자 포털 > 관리비 > 세대별 사용료 입력 > 개별 호실 검침값 등록` (가칭)

### 3.2. UI 요소별 상세 설명 (예시)
- **화면 1: 개별 호실 검침 데이터 입력 및 조회 화면**
    | UI 요소 ID (선택) | 요소명 (Label)            | 유형 (Type)        | 기본값/표시 데이터 | 동작 설명                                                    | 유효성 규칙/제약조건     | 비고                                               |
    | :---------------- | :------------------------ | :----------------- | :----------------- | :----------------------------------------------------------- | :----------------------- | :------------------------------------------------- |
    | UMR-LST-01        | [대상 청구월] 표시/선택   | 텍스트/드롭다운    | 현재 작업 청구월   | 검침 데이터를 입력/조회할 대상 청구월 선택                   | 청구월 상태 '준비중'     | 변경 시 하단 목록/입력폼 새로고침                  |
    | UMR-LST-02        | [건물] 선택               | 드롭다운           | (기본 선택 건물)   | 검침 대상 건물을 선택 (다수 건물 관리 시)                    | 필수                     | 변경 시 호실 목록 새로고침                         |
    | UMR-LST-03        | [동/라인] 필터 (선택)     | 드롭다운           | 전체               | 특정 동 또는 라인의 호실만 필터링                            |                          |                                                    |
    | UMR-LST-04        | [호실 검색] (선택)        | 입력 필드          | -                  | 호실 번호 또는 임차인명으로 특정 호실 검색                   |                          |                                                    |
    | UMR-LST-05        | [엑셀 양식 다운로드] 버튼 | 버튼               | -                  | 개별 검침값 일괄 업로드용 엑셀 템플릿 파일 다운로드          |                          |                                                    |
    | UMR-LST-06        | [엑셀로 일괄 업로드] 버튼 | 버튼               | -                  | 편집된 엑셀 파일을 시스템에 업로드하여 검침 데이터 일괄 등록/수정 |                          | 업로드 후 검증 및 미리보기 단계 포함 가능          |
    | UMR-LST-07        | 개별 호실 검침 입력 목록  | 표 (Editable Grid) | -                  | 호실, 임차인명, (항목1)전월지침, (항목1)당월지침(입력), (항목1)사용량, (항목1)검침일(입력)... 등을 표시 | 페이지네이션             | 각 행은 호실, 각 열은 공과금 항목 또는 공통 정보   |
    | (표 내부)         | 호실번호                  | 텍스트 (읽기전용)  | (예: 101동 1001호) |                                                              |                          |                                                    |
    | (표 내부)         | 임차인명 (참고)           | 텍스트 (읽기전용)  | (예: 홍길동)       |                                                              |                          |                                                    |
    | (표 내부)         | [공과금 항목명] 전월 지침 | 숫자 (읽기전용)    | (자동로드)         |                                                              |                          |                                                    |
    | (표 내부)         | [공과금 항목명] 당월 지침 | 숫자 입력 필드     | -                  |                                                              | 숫자, 전월지침 이상 권장 |                                                    |
    | (표 내부)         | [공과금 항목명] 사용량    | 숫자 (읽기전용)    | (자동계산)         |                                                              |                          | 음수일 경우 경고                                   |
    | (표 내부)         | [공과금 항목명] 검침일    | 날짜 선택          | (청구월 말일 권장) |                                                              |                          |                                                    |
    | (표 내부)         | [공과금 항목명] 메모      | 입력 필드 (선택)   | -                  |                                                              |                          |                                                    |
    | UMR-LST-08        | [전체 저장] 버튼          | 버튼               | -                  | 표에 입력/수정된 모든 호실의 검침 데이터를 일괄 저장         |                          | 변경된 행만 저장 또는 전체 행 업데이트 (정책 결정) |

#### 3.3. 주요 사용자 시나리오 (흐름)
- **시나리오 1: 특정 청구월의 개별 호실 검침 데이터 수동 입력**
    1. 관리자가 '개별 호실 검침 데이터 등록 화면'에 접속하여 대상 청구월(예: 2025년 6월)과 대상 건물(예: 행복아파트 A동)을 선택한다.
    2. 시스템은 해당 건물의 호실 목록과 각 호실별 공과금 항목(예: 전기, 수도, 가스)에 대한 입력 필드(전월 지침 자동 표시)를 표 형태로 제공한다.
    3. 관리자는 각 호실을 순회하며 또는 전달받은 검침 내역을 바탕으로, 각 공과금 항목의 '당월 지침' 값을 입력하고 '검침일'을 선택(또는 기본값 사용)한다.
    4. '당월 지침' 입력 시, 시스템은 '사용량'을 자동으로 계산하여 표시한다. (만약 당월 지침 < 전월 지침이면 경고 UI 표시)
    5. 모든 호실 또는 일부 호실의 데이터 입력 후, 관리자가 [전체 저장] 버튼을 클릭한다.
    6. 시스템은 유효성 검사 후 입력된 모든 검침 데이터를 저장하고, "검침 데이터가 성공적으로 저장되었습니다." 메시지를 표시한다.
- **시나리오 2: 엑셀 파일을 이용한 개별 호실 검침 데이터 일괄 업로드**
    1. 관리자가 화면에서 [엑셀 양식 다운로드] 버튼을 클릭하여 검침 데이터 입력용 템플릿 파일을 받는다.
    2. 템플릿 파일에 호실 번호, 각 공과금 항목별 당월 지침, 검침일 등의 정보를 기입하여 저장한다.
    3. 관리자가 [엑셀로 일괄 업로드] 버튼을 클릭하여 작성된 파일을 선택하고 업로드한다.
    4. 시스템은 업로드된 파일의 데이터를 검증한다 (호실번호 유효성, 데이터 형식 등).
        - (선택) 검증 결과 및 미리보기 화면을 제공하여 관리자가 최종 확인 후 저장하도록 한다.
        - 또는, 오류가 없는 데이터는 즉시 저장하고 오류 건만 별도 보고한다.
    5. 성공적으로 업로드 및 저장되면 관련 메시지를 표시한다.

### 4. 데이터 요구사항
#### 4.1. 입력 데이터
- 대상 청구월 ID (`billingMonthId`)
- 대상 건물 ID (`buildingId`), (선택) 동 ID (`dongId`)
- (각 호실별) 호실 ID (`unitId`)
- (각 호실/항목별) 공과금 항목 코드 (`utilityTypeCode` - 예: `ELEC_INDIVIDUAL`, `WATER_INDIVIDUAL`)
- (각 호실/항목별) 검침일 (`readingDate`)
- (각 호실/항목별) 당월 검침 지침 값 (`currentMeterReading`)
- (선택, 각 호실/항목별) 메모, 첨부파일(계량기 사진 등)

#### 4.2. 출력 데이터 (화면 표시 및 내부 처리용)
- 등록된 호실별/항목별 검침 기록 (전월 지침, 당월 지침, 사용량, 검침일 등)
- 계산된 호실별/항목별 사용량 (`usageCalculated`)

#### 4.3. 개별 호실 월별 검침 (UnitMonthlyMeterReading) 엔티티 속성 (예시)
| 속성명 (Attribute)     | 데이터 타입 (Type)  | 필수 (PK/FK) | 설명                                                         | 예시/비고                                         |
| :--------------------- | :------------------ | :----------- | :----------------------------------------------------------- | :------------------------------------------------ |
| `unitReadingId`        | UUID / Long         | PK           | 개별 호실 월별 검침 고유 ID                                  |                                                   |
| `billingMonthId`       | UUID / Long         | FK           | 청구월 ID (BillingMonth 참조)                                |                                                   |
| `unitId`               | UUID / Long         | FK           | 호실 ID (Unit 참조)                                          |                                                   |
| `utilityTypeCode`      | String (FK/Enum)    | Y            | 공과금 항목 코드 (예: `ELEC_I`, `WATER_I`, `GAS_I`, `HEAT_I`) | '_I'는 Individual 의미. FeeItem과 연계될 수 있음. |
| `readingDate`          | Date                | Y            | 검침일                                                       |                                                   |
| `previousMeterReading` | BigDecimal / Double | Y            | 전월(이전) 검침 지침 값 (해당월의 사용량 계산 기준)          |                                                   |
| `currentMeterReading`  | BigDecimal / Double | Y            | 당월 검침 지침 값                                            |                                                   |
| `usageCalculated`      | BigDecimal / Double | Y            | 계산된 사용량 (`currentMeterReading - previousMeterReading`) |                                                   |
| `attachments`          | JSON / Array        | N            | 첨부 파일 정보 (파일명, S3 경로 등)                          |                                                   |
| `remarks`              | Text                | N            | 검침 관련 비고                                               | "추정 검침", "계량기 고장으로 이전 값 유지"       |
| ... (생성/수정일시 등) |                     |              |                                                              |                                                   |

### 5. 처리 로직 및 비즈니스 규칙
- **R-UNITMTR-001:** 검침 데이터는 대상 청구월의 상태가 `준비중`일 때만 등록/수정/삭제 가능하다. (정책에 따라 `진행중` 초기에도 가능할 수 있으나, 재산정 필요)
- **R-UNITMTR-002:** 특정 청구월, 특정 호실, 특정 공과금 항목에 대한 검침 데이터는 하나만 존재해야 한다. (중복 등록 방지)
- **R-UNITMTR-003 (`전월 지침` 자동 설정):** 신규 검침 입력 시(또는 화면 로드 시), 해당 호실/항목의 직전 청구월 `당월 지침(currentMeterReading)` 값을 현재 청구월의 `전월 지침(previousMeterReading)`으로 자동 설정하여 표시한다. 첫 달이거나 이전 기록이 없을 경우, 관리자가 직접 '전월 지침(기초값)'을 입력하거나 시스템이 0으로 초기화한다.
- **R-UNITMTR-004 (`사용량` 자동 계산):** `사용량 = 당월 지침 - 전월 지침`.
- **R-UNITMTR-005 (`당월 지침` 유효성):** `당월 지침`은 `전월 지침`보다 크거나 같아야 한다. 만약 작을 경우, 사용자에게 경고를 표시하고 사유(예: 계량기 교체, 오류 입력)를 확인하거나 입력하도록 유도한다. (강제 저장 옵션 또는 별도 처리 로직 필요)
- **R-UNITMTR-006 (엑셀 일괄 업로드):**
    - 제공된 템플릿 형식 준수 여부 검증.
    - 데이터 유효성 검증 (호실번호 존재 여부, 검침값 숫자 여부, 검침일 형식 등).
    - 오류 발생 시, 오류 내용 및 해당 데이터 위치(행, 열)를 명시하여 사용자에게 피드백. 성공 건만 반영하거나 전체 롤백 (정책 결정).
- **R-UNITMTR-007:** 이미 '관리비 산정'이 완료된 청구월의 검침 데이터를 수정/삭제할 경우, "이미 관리비 산정이 완료된 데이터입니다. 변경 시 관리비 재산정이 필요합니다."와 같은 경고 메시지를 표시하고, 관련 데이터의 재산정 필요 상태를 시스템적으로 관리해야 한다.

### 6. 오류 처리 및 예외 관리
| 오류 코드 (선택) | 발생 조건                                         | 오류 메시지 (User-facing)                                    | 시스템 처리 방안                                     |
| :--------------- | :------------------------------------------------ | :----------------------------------------------------------- | :--------------------------------------------------- |
| E-UNITMTR-01     | 필수 입력 항목(호실, 항목, 검침일, 당월지침) 누락 | "[필드명]은(는) 필수 입력 항목입니다."                       | 저장 차단, 해당 필드에 오류 표시                     |
| E-UNITMTR-02     | 숫자 필드(지침값) 형식 오류                       | "검침 지침 값은 숫자로 입력해야 합니다."                     | 저장 차단, 해당 필드에 오류 표시                     |
| E-UNITMTR-03     | 당월 지침 < 전월 지침 (경고 무시 불가 시)         | "당월 지침 값은 전월 지침 값보다 크거나 같아야 합니다. 확인해주세요." | 저장 차단 (또는 경고 후 저장 옵션 제공 시 관련 로직) |
| E-UNITMTR-04     | (엑셀) 존재하지 않는 호실번호 또는 항목 코드      | "엑셀 파일에 유효하지 않은 호실번호 또는 항목 코드가 포함되어 있습니다: [오류 데이터]" | 해당 행 처리 실패, 사용자에게 오류 목록 제공         |
| E-UNITMTR-05     | 이미 마감된 청구월 데이터 수정/삭제 시도          | "이미 마감 처리된 청구월의 검침 데이터는 변경할 수 없습니다." | 수정/삭제 차단, 안내 메시지 표시                     |

### 7. (기능별) 성능 요구사항
- P-UNITMTR-01: 특정 청구월/건물의 개별 호실 검침 입력 목록(200세대, 세대당 3개 항목 기준) 로드 시 3초 이내 응답.
- P-UNITMTR-02: 입력된 검침 데이터(200세대 * 3개 항목) 일괄 저장 시 5초 이내 처리 완료.
- P-UNITMTR-03: 엑셀 파일(200세대 * 3개 항목) 업로드, 검증 및 데이터 반영(미리보기 단계까지) 시 20초 이내 완료.

### 8. (기능별) 보안 요구사항
- S-UNITMTR-01: 개별 호실 검침 데이터 등록/수정/삭제 기능은 '관리소장', '경리담당자', '검침 담당자' 등 인가된 역할만 접근 가능하다.
- S-UNITMTR-02: 검침 데이터의 변경 이력(수정/삭제 시)은 감사 로그로 기록되어야 한다.
- S-UNITMTR-03: (엑셀 업로드 시) 악의적인 대량 데이터 입력 시도 등에 대한 방어 로직 고려 (예: 업로드 크기 제한, 처리량 제한).

### 9. 다른 기능/모듈과의 연관성
- **시설 점검 및 유지보수 관리 (`Facility` 엔티티):** (만약 개별 세대 계량기를 시설물로 관리한다면) 해당 계량기 정보를 참조할 수 있다. (일반적으로는 Unit에 직접 연결된 계량기 정보 사용)
- **청구월 관리 (`BillingMonth` 엔티티):** 본 기능의 모든 검침 데이터는 특정 '청구월' 컨텍스트 하에서 관리된다. 청구월의 상태에 따라 본 기능의 데이터 입력/수정 가능 여부가 결정된다.
- **관리비 항목 설정 (`FeeItem` 엔티티):** 본 기능에서 입력된 사용량 데이터를 기반으로 요금을 계산할 때 필요한 단가 및 부과 방식 정보는 '관리비 항목 설정'에서 정의된 관련 개별 사용료 항목(예: 세대 전기료, 세대 수도료)을 참조한다.
- **관리비 산정 (F-FEE-CALC-001):** 본 기능에서 입력/확정된 각 호실별 사용량은 '관리비 산정' 기능을 통해 해당 공과금 항목의 관리비를 계산하는 핵심 입력 데이터가 된다.

### 10. (선택 사항) 테스트 고려 사항
- 신규/수정/삭제 등 기본 CRUD 기능 테스트 (개별 입력, 엑셀 일괄 업로드 각각).
- 전월 지침 자동 로드 및 사용량 자동 계산 정확성 테스트.
- 당월 지침 < 전월 지침 시 경고 및 처리 로직 테스트 (정상 저장/오류 후 저장 등).
- 엑셀 업로드 시 다양한 오류 케이스(형식 오류, 데이터 누락, 비존재 호실 등) 및 대량 데이터 처리 성능 테스트.
- 청구월 상태 변경에 따른 입력/수정 제한 기능 테스트.
- 등록된 검침 데이터가 '관리비 산정' 기능에 정확하게 반영되는지 연계 테스트.
- 최초 입주 세대 (전월 지침이 없는 경우) 또는 계량기 교체 세대 처리 시나리오 테스트.

### 11. 용어 정의 (선택 사항)
- **개별 호실 검침값 (Unit Meter Reading):** 각 세대(호실)별로 설치된 전기, 수도, 가스, 난방 등의 계량기에서 읽은 지침 값.
- **세대 사용량 (Unit Usage):** 특정 기간(보통 1개월) 동안 해당 세대에서 사용한 공과금의 양 (`당월 지침 - 전월 지침`).

### 12. 문서 이력
| 버전 | 날짜             | 작성자      | 주요 변경 내용                                   |
| :--- | :--------------- | :---------- | :----------------------------------------------- |
| 1.0  | 2025년 06월 02일 | QIRO 기획팀 | 개별 호실 검침 데이터 등록 기능 명세서 초안 작성 |

---
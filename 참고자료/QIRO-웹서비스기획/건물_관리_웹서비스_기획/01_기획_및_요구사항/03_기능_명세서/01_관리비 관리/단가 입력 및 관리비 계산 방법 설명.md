
## 💶 QIRO 단가 입력 및 관리비 계산 방법 설명

### 1. 단가 입력 방법 (및 관련 항목 설정)

QIRO에서 단가 및 관련 설정은 주로 **"관리비 항목 관리"** 기능 (기능 ID: `F-FEE-SETUP-001`)을 통해 이루어집니다. 여기서 각 관리비 항목의 성격과 부과 기준을 정의하며, 필요한 경우 단가 또는 기준 금액을 입력합니다.

* **입력 위치:** `관리자 포털 > 설정 > 관리비 설정 > 관리비 항목 정의` 화면 내의 "관리비 항목 등록/수정 폼".
* **주요 입력 필드 및 방식:**
    1.  **`항목명`**: 관리비 고지서에 표시될 명칭 (예: 일반관리비, 세대 전기료, 청소비).
    2.  **`유형`**: 항목의 대분류 (예: 공용 관리비, 기타 부과금).
        * *계량기 기반 유틸리티(전기, 수도, 가스 등)는 본 "관리비 항목 관리"에서 단가를 직접 설정하기보다는, 별도의 "검침 데이터 관리" 및 "유틸리티 요금 정책/외부 고지서 금액 입력" 기능과 연동되어 처리됩니다. 즉, 본 기능에서는 해당 유틸리티 요금을 배분하기 위한 항목명과 최종 배분 기준 정도를 정의할 수 있습니다.*
    3.  **`과세 여부`**: 해당 항목이 부가세 과세 대상인지 여부 (예: 과세, 비과세).
    4.  **`배분 기준 (부과 방식)`**: 관리비를 각 세대에 어떻게 부과할지 결정하는 핵심 설정입니다. 이 선택에 따라 `단가/금액` 필드의 의미와 필요성이 달라집니다.
        * **`세대별 고정액 부과 (FIXED_AMOUNT)`**:
            * **단가/금액 입력:** 각 세대에 동일하게 부과될 **고정 금액**을 직접 입력합니다. (예: 10,000)
            * **단위:** "원/세대" 또는 "원/호실" 등으로 자동 설정되거나 명시합니다.
        * **`세대 전용 면적 비례 부과 (PER_AREA)`**:
            * **단가/금액 입력:** 면적(㎡ 또는 평)당 **단가**를 입력합니다. (예: 1,500)
            * **단위:** "원/㎡" 또는 "원/평" 등으로 자동 설정되거나 명시합니다.
        * **`세대 지분 또는 동일 배분 N 비례 부과 (PER_SHARE)`**:
            * **단가/금액 입력:** 세대별로 N등분하여 동일 금액을 부과할 경우, 해당 항목의 **월별 총 발생액**을 "월별 공용 관리비 입력" 기능에서 입력받아, 여기서 설정된 "N등분" 기준에 따라 시스템이 배분합니다. 따라서 이 항목 설정 시에는 직접적인 단가 입력이 없을 수 있습니다. 만약 고정된 지분당 단가가 있다면 입력할 수도 있습니다.
            * **단위:** "원/세대" (N등분 시).
        * **`특정 공용비 총액을 면적 비례 배분 (COMMON_TOTAL_PER_AREA)`**:
            * **단가/금액 입력:** 이 항목 자체에 대한 단가는 여기서 입력하지 않습니다. 해당 공용비의 **월별 총 발생액**을 "월별 공용 관리비 입력" 기능(또는 "공용 시설 검침 데이터" + 단가 적용을 통한 금액 산출 후)에서 입력받습니다. QIRO는 그 총액을 여기서 설정된 "면적 비례 배분" 기준에 따라 각 세대에 나눕니다.
            * **단위:** 이 항목의 배분 기준이 '면적'임을 나타낼 수 있습니다.
        * **`특정 공용비 총액을 세대 지분(또는 N등분) 비례 배분 (COMMON_TOTAL_PER_SHARE)`**:
            * **단가/금액 입력:** 위와 유사하게, 월별 총 발생액은 다른 곳에서 입력받고, 여기서는 "N등분 배분" 기준만 설정합니다.
            * **단위:** 배분 기준이 '세대'임을 나타낼 수 있습니다.
    5.  **`부가세 적용 여부`**: `과세 여부`와 연계되어, 실제 부가세(예: 10%)를 계산할지 결정합니다.
    6.  **`적용 시작일` / `적용 종료일`**: 해당 항목 설정(단가 포함)이 유효한 기간을 지정합니다. 신규 등록 또는 '사용 중지'에서 '사용'으로 변경된 항목은 규칙에 따라 **익월 청구분부터 적용**됩니다.

### 2. 관리비 계산 방법 (세대별 최종 부과액 산출 과정)

관리비 계산은 주로 **"월별 관리비 자동 산정"** 기능 (기능 ID: `F-FEE-CALC-001`)을 통해, 지정된 `청구월`에 대해 다음과 같은 단계로 이루어집니다.

1.  **필요 데이터 준비 (Data Aggregation):**
    * **현재 청구월 정보 (`BillingMonth`):** 작업 대상 연월.
    * **유효한 관리비 항목 설정 (`FeeItem`, `BillingMonthFeeItemSetting`):** 위 "1. 단가 입력 방법"에서 현재 청구월에 `ACTIVE` 상태이고 `적용 시작일/종료일`이 유효한 모든 관리비 항목의 설정값(부과 방식, 단가/금액, 부가세 여부 등)을 가져옵니다.
    * **호실(세대) 정보 (`Unit`):** 각 호실의 전용 면적, 계약 면적, 기타 배분에 필요한 속성값을 가져옵니다.
    * **개별 호실 검침 데이터 (`UnitMonthlyMeterReading`):** 해당 청구월의 각 호실별 전기, 수도, 가스 등의 최종 확정된 **사용량**(`usageCalculated`) 정보를 가져옵니다. (이 사용량에 적용될 단가는 외부 고지서 정보 또는 별도 유틸리티 요금 정책에 따라 결정되어 시스템에 입력된 값을 사용합니다.)
    * **공용 시설 검침 데이터 (`CommonFacilityMonthlyReading`):** 해당 청구월의 공용 전기, 수도 등의 **사용량** 정보를 가져옵니다.
    * **월별 외부 고지서 청구 금액 및 배분 정보:** 건물 단위로 청구된 전기, 수도, 가스 요금 총액과 이 금액이 개별 사용료분과 공용 사용료분으로 어떻게 나뉘었는지 정보를 가져옵니다. (이는 "외부 고지서 고객번호 관리" 및 "월별 외부 고지서 금액 입력" 기능과 연관)
    * **월별 공용 관리비 입력 (`MonthlyCommonFee`):** 검침 기반이 아닌 공용 관리비 항목(예: 청소용역비, 승강기유지보수 계약금)의 해당 월 **발생 총액**을 가져옵니다.
    * **전월 미납액 정보 (`BillingMonthUnitUnpaidAmount`):** 각 세대별 전월 미납액 및 연체료(계산되었다면) 정보를 가져옵니다.

2.  **세대별 각 관리비 항목 금액 계산:**
    시스템은 해당 청구월의 모든 관리 대상 호실에 대해, 준비된 각 관리비 항목별로 다음 로직에 따라 부과 금액을 계산합니다.

    * **`세대별 고정액 부과 (FIXED_AMOUNT)` 항목:**
        * `부과 금액 = 설정된 고정 금액 (FeeItem.unitPrice)`
    * **`세대 전용 면적 비례 부과 (PER_AREA)` 항목:**
        * `부과 금액 = 설정된 면적당 단가 (FeeItem.unitPrice) × 해당 호실의 전용 면적 (Unit.exclusiveArea)`
    * **`세대 지분 또는 동일 배분 N 비례 부과 (PER_SHARE)` 항목:**
        * `부과 금액 = (해당 항목의 월별 총 발생액 (MonthlyCommonFee 또는 FeeItem.unitPrice가 총액 역할 시) ÷ 총 부과 대상 호실 수)`
    * **`개별 사용량 비례 부과 (PER_USAGE)` 항목 (예: 세대 전기료, 수도료 등):**
        * `사용량 = 해당 호실, 해당 항목의 월 사용량 (UnitMonthlyMeterReading.usageCalculated)`
        * `단가 = 해당 유틸리티의 확정된 사용량당 단가` (이 단가는 "관리비 항목 설정"에서 직접 입력하는 것이 아니라, 외부 고지서 총액과 총사용량을 기반으로 역산되거나, 별도의 유틸리티 요금 정책 테이블에서 가져올 수 있습니다. QIRO의 상세 정책에 따름.)
        * `부과 금액 = 사용량 × 단가`
        * *(참고: 누진세, 기본요금 등 복잡한 요금 체계가 있는 유틸리티는 해당 요금표에 따른 별도 계산 로직이 필요하며, 단순 단가 방식보다 복잡할 수 있습니다.)*
    * **`특정 공용비 총액을 면적 비례 배분 (COMMON_TOTAL_PER_AREA)` 항목 (예: 공용 전기료, 공용 수도료 중 면적 배분 방식):**
        * `월별 해당 공용비 총액 =` ("월별 외부 고지서 금액 입력"에서 해당 고객번호의 공용 사용료로 지정된 금액 또는 "공용 시설 검침 데이터"의 사용량 × 관련 단가로 계산된 금액, 또는 "월별 공용 관리비 입력"에서 직접 입력된 금액)
        * `건물 전체 배분 대상 면적 합계 = SUM(Unit.exclusiveArea)` (배분 대상 호실들의)
        * `부과 금액 = (월별 해당 공용비 총액 ÷ 건물 전체 배분 대상 면적 합계) × 해당 호실의 전용 면적 (Unit.exclusiveArea)`
    * **`특정 공용비 총액을 세대 지분(또는 N등분) 비례 배분 (COMMON_TOTAL_PER_SHARE)` 항목 (예: 청소비, 승강기유지비 등):**
        * `월별 해당 공용비 총액 = "월별 공용 관리비 입력"에서 해당 항목에 대해 입력된 금액`
        * `건물 전체 배분 대상 호실 수 = COUNT(Unit)` (배분 대상 호실들의)
        * `부과 금액 = 월별 해당 공용비 총액 ÷ 건물 전체 배분 대상 호실 수`

3.  **항목별 부가세(VAT) 계산:**
    * 각 관리비 항목이 "관리비 항목 설정"에서 `부가세 적용 여부 (vatApplicable)`가 `true`로 설정된 경우, 위 2단계에서 계산된 `부과 금액`에 대해 부가세(예: 10%)를 계산합니다.
    * `부가세액 = 부과 금액 × (설정된 부가세율 ÷ 100)`

4.  **세대별 총 관리비 합산:**
    * 특정 호실에 대해 계산된 모든 관리비 항목의 (`부과 금액` + `부가세액`)을 합산합니다.
    * 여기에 해당 호실의 `전월 미납액`을 더합니다.
    * (필요시) 해당 호실의 확정된 `연체료`를 더합니다.
    * (필요시) 해당 호실에 대한 `기타 조정액`(플러스 또는 마이너스)이 있다면 반영합니다.
    * **`해당 월 최종 청구 금액 = Σ(항목별 부과금액 + 항목별 부가세액) + 전월 미납액 + 연체료 + 기타 조정액`**

5.  **계산 결과 저장:**
    * 산정된 세대별 총 관리비 및 항목별 상세 내역은 시스템 내 관련 테이블(예: `UnitMonthlyFee`, `UnitFeeDetail`)에 저장됩니다.
    * 이 데이터는 "고지서 발급" 및 "수납 처리" 기능의 기초 자료가 됩니다.

---

**중요 고려사항:**

* **데이터의 정확성:** 모든 계산은 입력된 데이터(항목 설정, 단가, 검침값, 면적 등)의 정확성에 크게 의존합니다. 따라서 각 데이터를 입력하고 설정하는 단계에서의 유효성 검증이 매우 중요합니다.
* **계산 규칙의 명확한 정의:** 특히 공용 관리비를 배분하는 방식(면적별, 세대수별 등)과 유틸리티 요금의 단가 적용 방식(고정 단가, 누진제, 외부 고지서 총액 기반 역산 등)은 시스템 정책으로 명확히 정의되고 사용자에게 안내되어야 합니다.
* **예외 처리:** 계량기 교체, 특정 세대 면제/감면 등 예외적인 상황에 대한 처리 규칙도 사전에 정의되어야 합니다.
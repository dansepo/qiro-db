# ⚙️ QIRO - 관리비 수납 처리 기능 명세서

## 1. 문서 정보
- **문서명:** QIRO - 관리비 수납 처리 기능 명세서
- **기능 ID (선택 사항):** F-PAY-PROC-001
- **관련 요구사항 ID:** (예: QIRO-FR-MF-040)
- **관련 사용자 스토리 ID:** (예: US-LKR-001)
- **작성일:** 2025년 05월 28일
- **최종 수정일:** 2025년 05월 28일
- **작성자:** QIRO 기획팀
- **검토자/승인자 (선택 사항):** (이름 또는 팀)
- **문서 버전:** 1.0

## 2. 기능 개요
### 2.1. 목적
'청구월 관리'에서 선택된 특정 청구월에 대해, '고지서 발급' 기능을 통해 입주민/임차인에게 고지된 관리비의 납부 내역을 시스템에 정확하게 기록하고 관리한다. 이를 통해 실시간으로 수납 현황을 파악하고, 미납 관리를 효율적으로 수행하며, 정확한 회계 처리의 기초를 마련한다.

### 2.2. 설명
본 기능은 관리자가 특정 청구월 및 세대에 대해 납부된 관리비 내역(납부일, 납부 금액, 납부 방법 등)을 수동으로 입력하거나, (선택적 확장 기능으로) 은행 입금 내역 파일(엑셀 등)을 업로드하여 대량으로 수납 처리할 수 있도록 지원한다. 처리된 수납 내역은 해당 세대의 미납 정보에 즉시 반영된다.

### 2.3. 범위
- **In-Scope (포함 범위):**
    - 작업 대상 청구월 선택 또는 확인.
    - 특정 세대/고지서에 대한 수납 내역 수동 입력 (납부일, 납부금액, 납부자명, 납부수단 등).
    - (선택) 은행 입금 내역 엑셀 파일 업로드를 통한 대량 수납 처리 (자동/수동 매칭).
    - 수납 처리 시 해당 세대의 미납액 자동 계산 및 업데이트.
    - 수납 내역 조회, 수정(제한적 권한 필요), 삭제(제한적 권한 필요).
    - 세대별/청구월별 수납 현황 및 미납 현황 조회.
- **Out-of-Scope (제외 범위):**
    - 실시간 계좌 이체(펌뱅킹) 또는 PG(Payment Gateway) 연동을 통한 자동 수납 처리 (향후 확장 고려).
    - 연체료 자동 계산 및 부과 (별도 기능 또는 '관리비 산정' 시 포함 가능).
    - 회계 전표 자동 생성 (별도 '회계 관리' 기능에서 처리, 본 기능은 데이터 제공).

## 3. 사용자 인터페이스 (UI) 및 상호작용
### 3.1. 관련 화면
- `관리자 포털 > 관리비 > 수납 처리 및 미납 관리`

### 3.2. UI 요소별 상세 설명
- **화면 1: 수납 처리 및 조회 화면**
    | UI 요소 ID (선택) | 요소명 (Label)                      | 유형 (Type)       | 기본값/표시 데이터 | 동작 설명                                                    | 유효성 규칙/제약조건                 | 비고                              |
    | :---------------- | :---------------------------------- | :---------------- | :----------------- | :----------------------------------------------------------- | :----------------------------------- | :-------------------------------- |
    | PAY-LST-01        | [대상 청구월] 표시/선택             | 텍스트/드롭다운   | (이전 선택 값)     | 현재 작업 대상 청구월을 표시하거나, 변경 (상태 `NOTIFIED` 또는 `CLOSED`) | 청구월 상태 `NOTIFIED` 또는 `CLOSED` | 청구월 변경 시 하단 내용 새로고침 |
    | PAY-LST-02        | [세대 검색] 입력 필드               | 입력 필드         | -                  | 동/호수 또는 세대주명으로 특정 세대 검색                     |                                      |                                   |
    | PAY-LST-03        | [수납 상태] 필터                    | 드롭다운/체크박스 | 전체               | 납부 완료, 부분 납부, 미납 등 상태별 세대 필터링             |                                      |                                   |
    | PAY-LST-04        | 세대별 수납 현황 목록               | 표                | -                  | 동/호수, 세대주명, 고지액, 기납부액, 미납액, 납부 상태, [수납 등록] 버튼 등을 표시 | 페이지네이션, 정렬                   |                                   |
    | PAY-LST-05        | (표 내부) [수납 등록] 버튼          | 버튼              | -                  | 해당 세대의 수납 정보 입력 팝업/화면 호출                    | 미납 또는 부분납 상태                |                                   |
    | PAY-LST-06        | (표 내부) [수납 이력] 버튼          | 버튼              | -                  | 해당 세대의 과거 수납 이력 조회 팝업/화면 호출               |                                      |                                   |
    | PAY-LST-07        | [엑셀로 수납 일괄 등록] 버튼 (선택) | 버튼              | -                  | 은행 입금 내역 등 엑셀 파일 업로드를 통한 대량 수납 처리 화면/팝업 호출 |                                      |                                   |

- **화면 2: 개별 세대 수납 등록/수정 팝업/화면**
    | UI 요소 ID (선택) | 요소명 (Label)  | 유형 (Type)       | 기본값/표시 데이터 | 동작 설명                                               | 유효성 규칙/제약조건                 | 비고                                        |
    | :---------------- | :-------------- | :---------------- | :----------------- | :------------------------------------------------------ | :----------------------------------- | :------------------------------------------ |
    | PAY-FRM-01        | 세대 정보       | 텍스트 (읽기전용) | (선택된 세대)      | 동/호수, 세대주명, 해당월 고지액, 기납부액, 미납액 표시 |                                      |                                             |
    | PAY-FRM-02        | 납부일          | 날짜 선택         | 오늘 날짜          | 실제 납부된 날짜 선택                                   | 필수, YYYY-MM-DD 형식                |                                             |
    | PAY-FRM-03        | 납부 금액       | 숫자 입력 필드    | (미납액)           | 실제 납부된 금액 입력                                   | 필수, 숫자, 0 초과                   | 미납액 초과 시 경고 또는 분할납부 처리 안내 |
    | PAY-FRM-04        | 납부자명 (선택) | 입력 필드         | (세대주명)         | 실제 납부한 사람의 이름 (세대주와 다를 경우)            |                                      |                                             |
    | PAY-FRM-05        | 납부 수단       | 드롭다운          | (예: 계좌이체)     | 계좌이체, 현금, 카드 등 선택                            | 필수                                 |                                             |
    | PAY-FRM-06        | 메모 (선택)     | 텍스트 영역       | -                  | 수납 관련 특이사항 메모                                 | 최대 200자                           |                                             |
    | PAY-FRM-07        | [저장] 버튼     | 버튼              | -                  | 입력된 수납 정보 저장                                   | 모든 필수 항목 유효성 통과 시 활성화 |                                             |
    | PAY-FRM-08        | [취소] 버튼     | 버튼              | -                  | 입력 취소 및 팝업/화면 닫기                             |                                      |                                             |

### 3.3. 주요 사용자 시나리오 (흐름)
- **시나리오 1: 개별 세대 수납 내역 수동 등록**
    1. 경리담당자가 '수납 처리 및 조회 화면'에 접속하여 [대상 청구월]을 선택한다.
    2. 수납 처리할 세대를 검색하거나 목록에서 찾아 해당 세대의 [수납 등록] 버튼을 클릭한다.
    3. 시스템은 '개별 세대 수납 등록 팝업/화면'을 표시하고, 해당 세대의 고지액/미납액 정보를 보여준다.
    4. 경리담당자가 납부일, 납부 금액, 납부 수단 등 실제 납부 정보를 입력한다.
    5. 경리담당자가 [저장] 버튼을 클릭한다.
    6. 시스템은 입력된 정보를 저장하고, 해당 세대의 미납액을 업데이트한다. "수납 처리가 완료되었습니다." 메시지를 표시하고, 목록 화면의 정보도 갱신한다.
- **시나리오 2: (선택) 엑셀 파일로 수납 내역 일괄 등록**
    1. 경리담당자가 은행 등에서 입금 내역 엑셀 파일을 다운로드 받는다. (필요시 QIRO 시스템 제공 템플릿에 맞게 편집)
    2. '수납 처리 및 조회 화면'에서 [엑셀로 수납 일괄 등록] 버튼을 클릭하고 준비된 파일을 업로드한다.
    3. 시스템은 업로드된 파일 데이터를 파싱하고, 각 입금 내역을 고지된 세대 정보와 매칭하려고 시도한다. (매칭 기준: 입금자명, 동호수 정보, 입금액 등)
    4. 시스템은 매칭 결과(성공, 실패, 부분 성공, 확인 필요 건 등)를 사용자에게 보여준다.
    5. 경리담당자가 매칭 결과를 검토하고, 수동으로 수정하거나 확인 처리한다.
    6. 최종 확인 후 [일괄 저장] 버튼을 클릭하면, 모든 유효한 수납 내역이 시스템에 반영되고 각 세대의 미납 정보가 업데이트된다.

## 4. 데이터 요구사항
### 4.1. 입력 데이터
- **선택된 청구월 ID (`billingMonthId`)**
- **고지서 ID (`invoiceId`) 또는 세대 ID (`unitId`):** (FK, 필수)
- **납부일 (`paymentDate`):** (날짜, 필수)
- **납부 금액 (`paidAmount`):** (숫자, 필수)
- **납부자명 (`payerName`):** (문자열, 선택)
- **납부 수단 (`paymentMethod`):** (Enum/코드값, 필수, 예: `BANK_TRANSFER`, `CASH`, `CARD`)
- **(선택) 은행명, 계좌번호(일부 마스킹):** (납부 수단이 계좌이체일 경우)
- **(엑셀 업로드 시) 입금 내역 데이터:** (입금일, 입금액, 입금자명, 입금 계좌(적요) 등)

### 4.2. 출력 데이터 (화면 표시 및 내부 처리용)
- 등록된 수납 이력
- 세대별/청구월별 수납 총액, 미납 총액, 납부 상태
- 미납 세대 목록 및 상세 미납 내역

### 4.3. 수납 이력 (PaymentHistory) 엔티티 속성 (예시)
| 속성명 (Attribute)   | 데이터 타입 (Type)  | 필수 (PK/FK) | 설명                                          | 예시/비고                                          |
| :------------------- | :------------------ | :----------- | :-------------------------------------------- | :------------------------------------------------- |
| `paymentHistoryId`   | UUID / Long         | PK           | 수납 이력 고유 ID                             |                                                    |
| `invoiceId`          | UUID / Long         | FK           | 관련 고지서 ID (Invoice 참조)                 |                                                    |
| `unitId`             | UUID / Long         | FK           | 세대 ID (Unit 참조)                           | 고지서와 중복될 수 있으나 빠른 조회 위해 포함 가능 |
| `billingMonthId`     | UUID / Long         | FK           | 청구월 ID (BillingMonth 참조)                 |                                                    |
| `paymentDate`        | Date                | Y            | 실제 납부일                                   | YYYY-MM-DD                                         |
| `paidAmount`         | BigDecimal / Double | Y            | 납부된 금액                                   |                                                    |
| `paymentMethod`      | Enum / String(20)   | Y            | 납부 수단                                     | `BANK_TRANSFER`, `CASH`, `CARD` 등                 |
| `payerName`          | String(50)          | N            | 실제 납부자명 (세대주와 다를 경우)            |                                                    |
| `transactionDetails` | String(200)         | N            | 거래 관련 추가 정보 (예: 은행, 계좌번호 일부) |                                                    |
| `memo`               | String(500)         | N            | 수납 관련 메모                                | "분할 납부 중 첫번째 입금"                         |
| `processedBy`        | String              | Y            | 처리자 ID (수납 등록한 관리자)                |                                                    |
| `processedAt`        | DateTime            | Y            | 처리(등록) 일시                               |                                                    |
| ... (생성/수정 정보) |                     |              |                                               |                                                    |

## 5. 처리 로직 및 비즈니스 규칙
- **R-PAY-PROC-001:** 수납 처리는 대상 청구월의 상태가 `NOTIFIED` (고지 완료) 또는 `CLOSED` (마감 - 마감 후 추가 수납 처리 시)여야 한다.
- **R-PAY-PROC-002:** 수납 금액 입력 시, 해당 세대의 현재 미납액을 초과하여 입력될 경우 사용자에게 경고 메시지를 표시한다. (과납 처리 정책 필요: 예치금 처리 또는 다음 달 이월)
- **R-PAY-PROC-003:** 수납 처리 완료 시, 해당 고지서(Invoice)의 상태를 업데이트한다 (예: `PAID_PARTIAL` (부분납부), `PAID_FULL` (완납)). 또한, 세대의 총 미납액 정보도 실시간으로 갱신한다.
- **R-PAY-PROC-004:** (엑셀 일괄 등록 시) 시스템은 업로드된 입금 내역과 기존 고지 내역(세대 정보, 고지액 등)을 매칭하는 로직을 가져야 한다. 매칭 정확도를 높이기 위한 규칙(예: 동명이인 처리, 유사 금액 처리)을 정의한다.
- **R-PAY-PROC-005:** 수납 기록 수정 또는 삭제는 원칙적으로 제한되며, 필요한 경우 '수납 정정' 또는 '수납 취소' 기능을 통해 이력을 남기고 처리한다 (엄격한 권한 관리 필요).

## 6. 오류 처리 및 예외 관리
| 오류 코드 (선택) | 발생 조건                                     | 오류 메시지 (User-facing)                                    | 시스템 처리 방안                          |
| :--------------- | :-------------------------------------------- | :----------------------------------------------------------- | :---------------------------------------- |
| E-PAY-PROC-01    | 숫자 필드(납부 금액)에 문자 입력 등 형식 오류 | "납부 금액은 숫자로 입력해야 합니다."                        | 저장 차단, 해당 필드에 오류 표시          |
| E-PAY-PROC-02    | 존재하지 않는 세대/고지서에 대한 수납 시도    | "수납 처리 대상 세대(또는 고지서) 정보를 찾을 수 없습니다."  | 저장 차단, 안내 메시지 표시               |
| E-PAY-PROC-03    | (엑셀 업로드) 매칭되는 세대 정보 없음         | "입금 내역 중 매칭되는 세대 정보를 찾을 수 없는 건이 있습니다. [상세 목록]" | 해당 건 제외 후 처리 또는 전체 실패, 안내 |
| E-PAY-PROC-04    | 이미 완납 처리된 고지서에 추가 수납 시도      | "이미 완납 처리된 고지서입니다. 과납 처리 또는 정정 기능을 이용하세요." | 저장 차단, 안내 메시지 표시               |

## 7. (기능별) 성능 요구사항
- P-PAY-PROC-01: 세대별 수납 현황 목록(최대 500세대) 조회 시 2초 이내 응답.
- P-PAY-PROC-02: 개별 수납 건 등록/수정 시 1초 이내 처리 완료.
- P-PAY-PROC-03: (엑셀 업로드) 500건의 입금 내역 처리 및 매칭 시 30초 이내 완료 (시스템 피드백 포함).

## 8. (기능별) 보안 요구사항
- S-PAY-PROC-01: 수납 처리 관련 기능은 '경리담당자' 또는 그 이상의 권한을 가진 역할만 접근 가능하다.
- S-PAY-PROC-02: 모든 수납 처리(등록, 수정, 삭제) 이력은 작업자, 시간, 금액, 변경 전/후 값 등을 포함하여 감사 로그로 상세히 기록한다.
- S-PAY-PROC-03: (엑셀 업로드 시) 업로드되는 파일은 악성코드 검사를 수행하고, 민감 정보 포함 여부를 확인한다 (정책에 따라).

## 9. 다른 기능/모듈과의 연관성
- **청구월 관리:** 본 기능은 '청구월 관리'에서 선택된 특정 청구월을 컨텍스트로 하여 수행된다.
- **고지서 발급:** 본 기능은 '고지서 발급'을 통해 생성되고 확정된 고지 정보를 기준으로 수납을 처리한다.
- **회계 관리:** 본 기능에서 처리된 수납 내역은 '회계 관리' 모듈에서 수입 관련 회계 전표를 생성하거나 회계 장부에 반영하는 기초 데이터가 된다.
- **미납 관리 (별도 기능 또는 통합):** 본 기능의 결과(미납액)는 미납 세대 독촉, 연체료 계산 등의 '미납 관리' 기능과 직접적으로 연관된다.

## 10. (선택 사항) 테스트 고려 사항
- 정상 수납, 부분 수납, 과납 시나리오 테스트.
- 다양한 납부 수단에 대한 처리 테스트.
- 엑셀 일괄 업로드 시 다양한 데이터 케이스(정상, 오류, 예외) 및 매칭 로직 검증.
- 수납 처리 후 미납액 및 고지서 상태 자동 업데이트 정확성 검증.
- 수납 기록 수정/삭제 시 이력 관리 및 권한 통제 테스트.

## 11. 용어 정의 (선택 사항)
- **수납 (Payment Receipt):** 관리비를 납부 받아 회계상으로 처리하는 행위.
- **미납 (Unpaid/Overdue):** 납부 기한까지 관리비가 납부되지 않은 상태.
- **과납 (Overpayment):** 고지된 금액보다 더 많은 금액이 납부된 상태.

## 12. 문서 이력
| 버전 | 날짜       | 작성자      | 주요 변경 내용   |
| :--- | :--------- | :---------- | :--------------- |
| 1.0  | 2025-05-28 | QIRO 기획팀 | 초기 명세서 작성 |
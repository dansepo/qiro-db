# ❗ QIRO - 미납 관리 및 연체료 처리 기능 명세서

## 1. 문서 정보
- **문서명:** QIRO - 미납 관리 및 연체료 처리 기능 명세서
- **기능 ID (선택 사항):** F-DELINQMGMT-001 (Delinquency Management)
- **관련 요구사항 ID:** (예: QIRO-FR-PAY-010, QIRO-FR-CFG-003)
- **관련 사용자 스토리 ID:** (예: US-AS-XXX, US-BM-XXX)
- **작성일:** 2025년 06월 03일
- **최종 수정일:** 2025년 06월 03일
- **작성자:** QIRO 기획팀
- **검토자/승인자 (선택 사항):** (이름 또는 팀)
- **문서 버전:** 1.0

## 2. 기능 개요
### 2.1. 목적
관리비 및 임대료에 대한 미납 현황을 실시간으로 정확하게 추적하고 관리한다. 시스템에 설정된 납부 정보(납부 마감일, 연체료율)를 기준으로 연체료를 자동으로 계산하여 부과하고, 미납 세대(임차인)에 대한 단계별 알림 및 독촉 절차를 지원하여 미수금을 최소화하고 안정적인 현금 흐름을 확보한다.

### 2.2. 설명
본 기능은 "수납 처리" 기능과 연동하여 납부 마감일이 지난 미납 건들을 자동으로 식별하고, 미납 기간 및 금액에 따라 설정된 연체료율을 적용하여 연체료를 계산한다. 계산된 연체료는 해당 세대의 다음 달 고지서에 합산되거나 별도 청구될 수 있다. 관리자는 미납 현황을 다양한 조건으로 조회하고, 시스템을 통해 미납 안내 및 독촉 알림(SMS, 이메일 등)을 발송할 수 있으며, 모든 관리 활동 이력을 기록한다.

### 2.3. 범위
- **In-Scope (포함 범위):**
    - 미납 건 자동 식별 (납부 마감일 경과 및 미완납 기준).
    - 미납 목록 조회 (건물/호실별, 임차인별, 미납 기간별, 미납 금액별 필터링 및 검색).
    - 미납 상세 내역 조회 (미납 원금, 발생일, 연체 일수, 발생 연체료 등).
    - 설정된 연체료율 및 계산 방식에 따른 연체료 자동 계산.
    - 계산된 연체료의 부과 처리 (다음 달 고지서 합산 또는 별도 청구 데이터 생성).
    - 미납/연체 알림(독촉) 자동 또는 수동 발송 기능 연동 (알림 내용 템플릿 관리 포함).
    - 미납 및 연체료 처리 이력 관리.
    - 미납 현황 관련 보고서 (예: 연령 분석 보고서 - Aging Report).
    - (선택) 특정 미납 건에 대한 납부 계획(분할 납부) 설정 및 관리 지원.
- **Out-of-Scope (제외 범위):**
    - 실제 자금 추심 또는 법적 절차 진행 (본 기능은 관리 및 통지 지원).
    - 연체료율 및 납부 마감일 설정 자체 (이는 "납부 정보 설정" 기능).
    - 관리비/임대료 고지 및 수납 처리 자체 (이는 각 해당 기능).
    - 외부 신용 정보 기관 연동.

## 3. 사용자 인터페이스 (UI) 및 상호작용
### 3.1. 관련 화면
- `관리자 포털 > 수납/미납 관리 > 미납 현황 및 연체 관리` (가칭)
- `관리자 포털 > 수납/미납 관리 > 미납 알림 발송`

### 3.2. UI 요소별 상세 설명 (예시)
- **화면 1: 미납 현황 및 연체 관리 목록 화면**
    | UI 요소 ID (선택) | 요소명 (Label)                      | 유형 (Type)   | 기본값/표시 데이터 | 동작 설명                                                    | 비고                              |
    | :---------------- | :---------------------------------- | :------------ | :----------------- | :----------------------------------------------------------- | :-------------------------------- |
    | DLQ-LST-01        | [조회 기준일]                       | 날짜 선택     | 오늘 날짜          | 특정 날짜를 기준으로 미납 현황을 조회                        |                                   |
    | DLQ-LST-02        | [건물/동/호실] 필터                 | 드롭다운/검색 | 전체               | 특정 범위의 미납 내역만 필터링                               |                                   |
    | DLQ-LST-03        | [미납 기간] 필터                    | 드롭다운      | 전체               | 예: 30일 이하, 31-60일, 61-90일, 91일 이상                   |                                   |
    | DLQ-LST-04        | [검색] 입력 필드                    | 입력 필드     | -                  | 임차인명, 호실 번호 등으로 검색                              |                                   |
    | DLQ-LST-05        | [검색/필터 적용] 버튼               | 버튼          | -                  | 조건 적용하여 목록 조회                                      |                                   |
    | DLQ-LST-06        | [연체료 일괄 계산/부과] 버튼 (선택) | 버튼          | -                  | 선택된 미납 건 또는 전체 미납 건에 대해 연체료를 계산하고 부과 처리 | 특정 권한 필요, 실행 전 확인 절차 |
    | DLQ-LST-07        | 미납 목록                           | 표            | -                  | 호실, 임차인, 미납항목(월분), 미납원금, 납부마감일, 연체일수, 발생연체료, 총미납액, (관리) 등을 표시 | 정렬, 클릭 시 상세 조회           |
    | (표 내부)         | [알림 발송] 버튼                    | 버튼          | -                  | 해당 미납 건에 대한 알림(독촉) 발송 화면/팝업 호출           |                                   |
    | (표 내부)         | [납부 계획 설정] 버튼 (선택)        | 버튼          | -                  | 해당 미납 건에 대한 분할 납부 계획 설정 팝업 호출            |                                   |
    | DLQ-LST-08        | 요약 정보 표시 영역                 | 텍스트/차트   | -                  | 총 미납 건수, 총 미납 원금, 총 발생 연체료 등 요약 표시      |                                   |
    | DLQ-LST-09        | 페이지네이션                        | 페이지네이션  | 1                  | 목록이 많을 경우 페이지 이동                                 |                                   |

- **화면 2: 연체료 계산/부과 확인 팝업 (또는 화면)**
    * 대상 건(들) 정보 요약.
    * 계산된 연체료 (산출 근거 간략 표시: 미납원금, 연체료율, 연체일수).
    * 부과 방식 선택 (예: 다음 달 고지서에 합산, 별도 청구 - 정책에 따름).
    * `[확인 및 부과]` 버튼, `[취소]` 버튼.

- **화면 3: 미납 알림 발송 화면/팝업**
    * 대상 임차인 정보 표시.
    * 알림 단계 선택 (예: 1차 단순 미납 안내, 2차 독촉, 최종 고지 - 템플릿 연동).
    * 발송 채널 선택 (SMS, 이메일 - 임차인 정보에 등록된 연락처 활용).
    * 알림 메시지 미리보기 (템플릿 기반, 변수 자동 치환).
    * `[발송]` 버튼, `[취소]` 버튼.

#### 3.3. 주요 사용자 시나리오 (흐름)
- **시나리오 1: 일일/주간 미납 현황 확인**
    1. 관리자가 '미납 현황 및 연체 관리' 화면에 접속한다.
    2. 시스템은 현재 기준일의 전체 미납 목록과 요약 정보를 기본으로 표시한다.
    3. 관리자는 필터(미납 기간, 건물 등)를 사용하여 특정 조건의 미납 건들을 조회한다.
- **시나리오 2: 특정 미납 건에 대한 연체료 계산 및 부과 (자동 또는 수동 트리거)**
    1. (자동) 시스템은 매일 또는 관리자가 설정한 주기로, 납부 마감일이 지난 미납 건에 대해 연체료를 자동 계산한다.
    2. (수동) 관리자가 목록에서 연체료를 계산/부과할 건들을 선택하고 `[연체료 일괄 계산/부과]` 버튼을 클릭한다.
    3. 시스템은 '연체료 계산/부과 확인' UI를 표시하며 계산된 연체료를 보여준다.
    4. 관리자가 확인 후 `[확인 및 부과]` 버튼을 클릭하면, 해당 연체료가 시스템에 기록되고 다음 달 고지서 등에 반영될 준비가 된다.
- **시나리오 3: 미납 임차인에게 독촉 알림 발송**
    1. 관리자가 미납 목록에서 알림을 발송할 임차인(들)을 선택하고 `[알림 발송]` 버튼을 클릭한다.
    2. '미납 알림 발송' UI에서 알림 단계(템플릿)와 발송 채널을 선택한다.
    3. 메시지 내용을 최종 확인하고 `[발송]` 버튼을 클릭한다.
    4. 시스템은 알림을 발송(외부 연동)하고 발송 이력을 기록한다.

### 4. 데이터 요구사항
#### 4.1. 입력 데이터 (시스템 내부 데이터 및 설정값 참조)
- **`납부 정보 설정`:** 납부 마감일(일자), 연체료율(%).
- **`월별 임대료 원장` 또는 `월별 관리비 고지 내역`:** 각 호실/임차인별 청구월, 청구 항목, 청구 금액, 납부 예정일.
- **`수납 처리` 이력:** 실제 납부된 금액, 납부일.
- **(알림 발송 시)** 알림 단계 선택, 추가 메시지(선택).

#### 4.2. 출력 데이터 (화면 표시 및 보고서용)
- 미납 목록 (상세 정보 포함: 호실, 임차인, 미납 항목, 미납 원금, 납부 마감일, 연체 일수, 계산된 연체료, 총 미납액).
- 미납 현황 요약 (총 미납 건수, 총 미납액, 연령 분석 등).
- 발송된 알림/독촉 이력.

#### 4.3. 주요 엔티티 속성 (예시)
- **`Delinquency` (미납/연체 기록 - 월별 청구분(`MonthlyRentLedger` 또는 `UnitMonthlyFee`)과 연관)**
    | 속성명 (Attribute)     | 데이터 타입 (Type)  | 필수 | 설명                                                         |
    | :--------------------- | :------------------ | :--- | :----------------------------------------------------------- |
    | `delinquencyId`        | UUID / Long (PK)    | Y    | 미납 기록 고유 ID                                            |
    | `targetLedgerId`       | UUID / Long (FK)    | Y    | 미납이 발생한 원장 ID (월별임대료원장 또는 월별세대관리비고지 ID) |
    | `unitId`               | UUID / Long (FK)    | Y    | 해당 호실 ID                                                 |
    | `tenantId`             | UUID / Long (FK)    | Y    | 해당 임차인 ID                                               |
    | `billingYearMonth`     | String (YYYY-MM)    | Y    | 미납 발생 청구 연월                                          |
    | `originalAmountDue`    | BigDecimal / Double | Y    | 최초 미납 원금                                               |
    | `currentUnpaidAmount`  | BigDecimal / Double | Y    | 현재 미납 잔액 (부분 수납 시 변경)                           |
    | `dueDate`              | Date                | Y    | 납부 마감일                                                  |
    | `overdueDays`          | Integer             | Y    | 연체 일수 (조회 시점 기준 자동 계산)                         |
    | `totalLateFeeApplied`  | BigDecimal / Double | Y    | 총 부과된 연체료 (초기값 0)                                  |
    | `status`               | Enum / String       | Y    | 미납 상태 (예: `OVERDUE`, `LATE_FEE_APPLIED`, `REMINDER_SENT`, `PARTIALLY_PAID_OVERDUE`, `RESOLVED`) |
    | `lastReminderSentDate` | Date                | N    | 최종 독촉 알림 발송일                                        |
    | ... (생성/수정일시 등) |                     |      |                                                              |

- **`LateFeeTransaction` (연체료 부과 이력 - Delinquency에 One-to-Many)**
    | 속성명 (Attribute)  | 데이터 타입 (Type)  | 필수 | 설명                                |
    | :------------------ | :------------------ | :--- | :---------------------------------- |
    | `lateFeeTxId`       | UUID / Long (PK)    | Y    | 연체료 거래 고유 ID                 |
    | `delinquencyId`     | UUID / Long (FK)    | Y    | 관련 미납 기록 ID                   |
    | `calculationDate`   | Date                | Y    | 연체료 계산/부과일                  |
    | `lateFeeAmount`     | BigDecimal / Double | Y    | 해당 시점에 계산/부과된 연체료 금액 |
    | `appliedRate`       | BigDecimal / Float  | Y    | 적용된 연체료율 (%)                 |
    | `appliedPeriodDays` | Integer             | Y    | 연체료 계산 대상 기간(일수)         |
    | `remarks`           | String              | N    | 비고                                |

### 5. 처리 로직 및 비즈니스 규칙
- **R-DELINQ-001 (미납 식별):** "납부 정보 설정"의 `납부 마감일`이 경과하고, "수납 처리" 결과 해당 청구월의 `미납 잔액 > 0` 인 경우 '미납(OVERDUE)' 상태로 식별한다.
- **R-DELINQ-002 (연체 일수 계산):** `(조회 기준일 또는 현재일) - 납부 마감일`. (일수 계산 시 초일/말일 산입 정책 정의 필요)
- **R-DELINQ-003 (연체료 계산):**
    - 기본 방식 (예: 단리, 일할 계산): `(미납 원금 × 연체료율 ÷ 100 ÷ 365) × 연체 일수`. (윤년 처리, 연체료율 적용 시점 등 상세 정책 필요)
    - 시스템은 "납부 정보 설정"의 `연체료율`을 사용한다.
    - (선택) 연체료 상한선, 최소 부과 금액 등 정책 적용.
- **R-DELINQ-004 (연체료 부과):** 계산된 연체료는 `LateFeeTransaction`으로 기록되고, 관련 `Delinquency`의 `totalLateFeeApplied` 및 `currentUnpaidAmount`가 업데이트된다. 부과된 연체료는 다음 달 관리비 고지서에 합산 청구되거나 별도 관리된다 (시스템 정책).
- **R-DELINQ-005 (미납 알림/독촉):**
    - 미납 기간(예: 7일, 15일, 30일 경과) 또는 미납액 크기에 따라 단계별 알림(템플릿 사용)을 자동 또는 수동으로 발송할 수 있다.
    - 알림 발송 이력(`NotificationHistory`)은 각 `Delinquency` 기록과 연동되어 관리된다.
- **R-DELINQ-006 (부분 수납 시 처리):** 미납액에 대해 부분 수납이 이루어지면, `currentUnpaidAmount`가 업데이트되고, 연체료는 남은 미납 원금을 기준으로 재계산되거나 기존 발생분은 유지된다 (정책 정의 필요. 일반적으로 연체료는 원금 완납 시점까지 발생).

### 6. 오류 처리 및 예외 관리
| 오류 코드 (선택) | 발생 조건                                            | 오류 메시지 (User-facing)                                    |
| :--------------- | :--------------------------------------------------- | :----------------------------------------------------------- |
| E-DELINQ-01      | 연체료 계산에 필요한 정보 부족 (예: 연체료율 미설정) | "연체료율이 설정되지 않아 연체료를 계산할 수 없습니다. '납부 정보 설정'을 확인해주세요." |
| E-DELINQ-02      | 존재하지 않는 미납 건에 대한 처리 시도               | "선택한 미납 정보를 찾을 수 없습니다."                       |
| E-DELINQ-03      | 알림 발송 실패 (SMS/이메일 연동 오류 등)             | "알림 발송 중 오류가 발생했습니다. (상세 사유)"              |

### 7. (기능별) 성능 요구사항
- P-DELINQ-01: 미납 목록 조회 (1,000건 미납 기준, 필터 적용) 시 3초 이내 응답.
- P-DELINQ-02: 연체료 일괄 계산 (1,000건 미납 기준) 시 백그라운드로 5분 이내 완료, 또는 실시간 계산 시 건당 0.1초 이내.

### 8. (기능별) 보안 요구사항
- S-DELINQ-01: 미납 및 연체료 관리 기능은 '경리담당자', '관리소장' 등 인가된 역할만 접근 가능하다.
- S-DELINQ-02: 임차인의 미납 정보 및 연락처 등 개인정보는 안전하게 보호되어야 한다.
- S-DELINQ-03: 연체료 부과, 미납 상태 변경 등의 주요 작업은 감사 로그로 기록된다.

### 9. 다른 기능/모듈과의 연관성
- **납부 정보 설정:** 미납 판단 기준이 되는 '납부 마감일'과 연체료 계산의 기준이 되는 '연체료율'을 제공받는다.
- **수납 처리:** 실제 수납 내역을 기반으로 미납 여부 및 미납액을 판단한다. 수납 시 미납 상태 및 연체료 정산에 영향을 준다.
- **관리비 산정 / 임대료 관리:** 미납 원금 정보를 제공하며, 계산/부과된 연체료는 다음 달 고지서의 관리비 항목으로 추가될 수 있다.
- **고지서 발급:** 미납액 및 연체료 정보를 다음 달 고지서에 포함하여 표시할 수 있다.
- **알림/공지사항 관리:** 미납 안내 및 독촉 메시지 발송 시 실제 알림 발송 기능을 사용한다.
- **회계 관리:** 발생된 연체료는 '연체료 수익' 등 관련 회계 계정으로 처리될 수 있다. 미수금에 대한 대손 처리와도 연관될 수 있다.

### 10. (선택 사항) 테스트 고려 사항
- 다양한 미납 기간 및 금액에 대한 연체료 계산 정확성 테스트 (일할 계산, 월할 계산 등 정책에 따라).
- 연체료 부과 후 다음 달 고지서에 정상 합산되는지 연계 테스트.
- 부분 수납 시 미납액 및 연체료 재계산 로직 테스트.
- 단계별 미납 알림 발송 조건 및 내용 정확성 테스트.
- 연령 분석 보고서(Aging Report) 등 관련 보고서 데이터 정확성 검증.

### 11. 용어 정의 (선택 사항)
- **미납 (Delinquency/Overdue Payment):** 납부 기한까지 납부되지 않은 채무(관리비, 임대료 등).
- **연체 (Arrears):** 미납 상태가 일정 기간 지속되는 것.
- **연체료 (Late Fee/Interest on Arrears):** 납부 기한을 어긴 것에 대해 원금 외에 추가로 부과되는 금액.
- **연령 분석 보고서 (Aging Report):** 미수채권이 발생한 시점부터 얼마나 오래되었는지를 기간별로 구분하여 보여주는 보고서.

### 12. 문서 이력
| 버전 | 날짜             | 작성자      | 주요 변경 내용      |
| :--- | :--------------- | :---------- | :------------------ |
| 1.0  | 2025년 06월 03일 | QIRO 기획팀 | 초기 명세서 안 작성 |

---
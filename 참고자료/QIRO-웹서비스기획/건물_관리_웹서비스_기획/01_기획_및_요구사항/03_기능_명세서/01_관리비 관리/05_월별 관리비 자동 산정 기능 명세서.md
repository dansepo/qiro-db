# ⚙️ QIRO - 월별 관리비 자동 산정 기능 명세서

## 1. 문서 정보
- **문서명:** QIRO - 월별 관리비 자동 산정 기능 명세서
- **기능 ID (선택 사항):** F-FEE-CALC-001
- **관련 요구사항 ID:** (예: QIRO-FR-MF-002)
- **관련 사용자 스토리 ID:** (예: US-PSJ-001, US-AS-XXX)
- **작성일:** 2025년 05월 28일
- **최종 수정일:** 2025년 05월 28일
- **작성자:** QIRO 기획팀
- **검토자/승인자 (선택 사항):** (이름 또는 팀)
- **문서 버전:** 1.0

## 2. 기능 개요
### 2.1. 목적
'청구월 관리'에서 선택된 특정 청구월에 대해, 사전에 준비된 데이터들 즉, '관리비 항목 설정', '공과금 입력(개별 사용료)', '관리비 입력(공용 관리비)'에서 입력/설정된 정보를 종합하여 각 세대별로 납부해야 할 최종 월별 관리비를 자동으로 계산한다. 이를 통해 수동 계산의 오류를 줄이고 관리비 부과 업무의 효율성을 극대화한다.

### 2.2. 설명
본 기능은 관리자가 특정 청구월에 대한 관리비 산정 작업을 실행하면, 시스템이 정의된 로직에 따라 세대별로 각 관리비 항목의 금액을 계산하고 이를 합산하여 총 부과액을 도출한다. 계산 결과는 관리자가 검토하고 최종 확정할 수 있도록 상세 내역과 함께 제공된다.

### 2.3. 범위
- **In-Scope (포함 범위):**
    - 작업 대상 청구월 선택 또는 확인.
    - 선택된 청구월에 대한 관리비 자동 계산 실행.
    - 개별 사용료(전기, 수도 등) 기반 항목 계산.
    - 공용 관리비 항목의 세대별 배분 계산 (면적별, 세대별 N등분 등).
    - 고정액 항목 적용.
    - 부가세 계산 (항목별 설정에 따라).
    - 세대별 총 관리비 합산.
    - 계산 결과 상세 조회 및 요약 정보 제공.
    - 계산 결과 확정/재계산 기능.
- **Out-of-Scope (제외 범위):**
    - 관리비 항목 자체의 설정 및 단가 입력 (이는 '관리비 항목 설정' 기능).
    - 검침값 및 공용 관리비 총액 입력 (이는 각 '입력' 기능).
    - 고지서 생성 및 발송 (이는 '고지서 발급' 기능).

## 3. 사용자 인터페이스 (UI) 및 상호작용
### 3.1. 관련 화면
- `관리자 포털 > 관리비 > 관리비 산정 및 확정`

### 3.2. UI 요소별 상세 설명
- **화면 1: 관리비 산정 실행 및 결과 조회 화면**
    | UI 요소 ID (선택) | 요소명 (Label)          | 유형 (Type)     | 기본값/표시 데이터 | 동작 설명                                                    | 유효성 규칙/제약조건                      | 비고                                       |
    | :---------------- | :---------------------- | :-------------- | :----------------- | :----------------------------------------------------------- | :---------------------------------------- | :----------------------------------------- |
    | FC-LST-01         | [대상 청구월] 표시/선택 | 텍스트/드롭다운 | (이전 선택 값)     | 현재 작업 대상 청구월을 표시하거나, 변경할 수 있도록 함      | 청구월 상태 `CALC_READY` 또는 `CALC_DONE` | 청구월 변경 시 하단 내용 새로고침          |
    | FC-LST-02         | [관리비 산정 실행] 버튼 | 버튼            | -                  | 선택된 청구월에 대한 관리비 자동 계산 실행                   | 청구월 상태 `CALC_READY` 시 활성화        | 실행 중 진행 상태 표시                     |
    | FC-LST-03         | [재계산] 버튼 (선택)    | 버튼            | -                  | 이미 산정된 내역을 초기화하고 다시 계산 실행 (필요시 경고)   | 청구월 상태 `CALC_DONE` 시 표시           |                                            |
    | FC-LST-04         | 산정 결과 요약          | 텍스트 영역     | -                  | 총 부과 세대 수, 총 부과 금액, 항목별 총액 등 요약 정보 표시 |                                           | 산정 완료 후 표시                          |
    | FC-LST-05         | 세대별 산정 내역        | 표              | -                  | 동/호수, 세대주, (항목1)금액, (항목2)금액 ... 세대별 총 관리비 등을 표시 | 페이지네이션, 정렬, 검색/필터             | 클릭 시 세대별 상세 팝업 또는 확장 가능    |
    | FC-LST-06         | (표 내부) [상세] 버튼   | 버튼            | -                  | 해당 세대의 관리비 산정 상세 내역(계산 과정 포함) 팝업 표시  |                                           |                                            |
    | FC-LST-07         | [산정 결과 확정] 버튼   | 버튼            | -                  | 관리자가 산정 결과를 최종 확인하고 부과 대상으로 확정        | 산정 완료 및 검토 후 활성화               | 확정 시 청구월 상태 `NOTIFIED`로 변경 제안 |

### 3.3. 주요 사용자 시나리오 (흐름)
- **시나리오 1: 특정 청구월 관리비 자동 산정 및 확정**
    1. 관리자가 '관리비 산정 및 확정 화면'에 접속한다.
    2. 관리자가 [대상 청구월]을 선택한다 (해당 청구월의 상태는 `CALC_READY`여야 함).
    3. 관리자가 [관리비 산정 실행] 버튼을 클릭한다.
    4. 시스템은 해당 청구월의 관리비 항목 설정, 세대별 검침값, 공용 관리비 입력값 등을 바탕으로 각 세대별 관리비를 계산한다. (상세 로직은 '5. 처리 로직' 참조)
    5. 계산 완료 후, 시스템은 '산정 결과 요약' 및 '세대별 산정 내역' 표에 결과를 표시한다. 청구월 상태는 `CALC_DONE`으로 변경될 수 있다.
    6. 관리자는 표시된 산정 결과를 검토하고, 필요시 특정 세대의 [상세] 버튼을 눌러 계산 과정을 확인한다.
    7. 모든 검토가 완료되면, 관리자가 [산정 결과 확정] 버튼을 클릭한다.
    8. 시스템은 "해당 청구월의 관리비 산정 내역이 최종 확정되었습니다. 고지서 발급이 가능합니다." 메시지를 표시하고, 청구월 상태를 `NOTIFIED`로 변경할 것을 제안하거나 자동 변경한다.

## 4. 데이터 요구사항
### 4.1. 입력 데이터 (계산을 위해 시스템 내부에서 참조하는 데이터)
- **선택된 청구월 ID (`billingMonthId`)**
- **해당 청구월의 세대별 검침 데이터 (UnitUtilityMonth):** `utilityTypeCode`, `usage` 등
- **해당 청구월의 공용 관리비 입력 데이터 (MonthlyCommonFee):** `feeItemId`, `totalAmountForMonth` 등
- **활성화된 관리비 항목 설정 데이터 (FeeItem):** `feeItemId`, `impositionMethod`, `unitPrice`, `vatApplicable` 등
- **건물/세대 정보 데이터 (Building, Unit):** `area` (면적), `totalUnits` (총 세대수) 등 배분에 필요한 정보

### 4.2. 출력 데이터 (계산 결과)
- **세대별/항목별 산정 금액:** (`unitFeeDetailId`, `billingMonthId`, `unitId`, `feeItemId`, `calculatedAmount`, `vatAmount`, `totalAmountWithVat`)
- **세대별 총 관리비:** (`unitMonthlyFeeId`, `billingMonthId`, `unitId`, `totalCalculatedFee`, `totalVat`, `finalAmountDue`)
- **산정 실행 로그:** (성공/실패, 오류 메시지, 실행 시간 등)

### 4.3. 월별 세대 관리비 (UnitMonthlyFee) 엔티티 속성 (예시)
| 속성명 (Attribute)   | 데이터 타입 (Type)  | 필수 (PK/FK) | 설명                                | 예시/비고                         |
| :------------------- | :------------------ | :----------- | :---------------------------------- | :-------------------------------- |
| `unitMonthlyFeeId`   | UUID / Long         | PK           | 월별 세대 관리비 고유 ID            |                                   |
| `billingMonthId`     | UUID / Long         | FK           | 청구월 ID (BillingMonth 참조)       |                                   |
| `unitId`             | UUID / Long         | FK           | 세대 ID (Unit 참조)                 |                                   |
| `totalCalculatedFee` | BigDecimal / Double | Y            | 세대별 총 관리비 (부가세 제외)      |                                   |
| `totalVat`           | BigDecimal / Double | Y            | 세대별 총 부가세액                  |                                   |
| `finalAmountDue`     | BigDecimal / Double | Y            | 세대별 최종 납부 금액 (부가세 포함) | `totalCalculatedFee` + `totalVat` |
| `calculationStatus`  | Enum / String(10)   | Y            | 산정 상태                           | `SUCCESS`, `ERROR`                |
| `calculationLog`     | Text                | N            | 산정 관련 로그 또는 오류 메시지     |                                   |
| `confirmedBy`        | String              | N            | 확정자 ID (관리자가 확정 시)        |                                   |
| `confirmedAt`        | DateTime            | N            | 확정 일시                           |                                   |
| ... (생성/수정 정보) |                     |              |                                     |                                   |

**(세대별 항목 상세 금액은 별도 테이블 `UnitFeeDetail` 등으로 관리)**

## 5. 처리 로직 및 비즈니스 규칙
### 5.1. 주요 처리 로직 (세대별 각 항목 계산)
1.  **입력 데이터 준비:** 선택된 `billingMonthId`에 해당하는 모든 관련 데이터(세대 목록, 검침값, 공용비 총액, 항목 설정)를 로드한다.
2.  **세대별 반복 계산:** 조회된 각 세대(`unitId`)에 대해 다음을 수행한다.
    a.  **활성화된 관리비 항목 반복:** '관리비 항목 설정(FeeItem)'에서 현재 청구월에 유효한(적용 기간 내, 상태 `ACTIVE`) 모든 항목에 대해 다음을 수행한다.
        i.  **부과 방식(`impositionMethod`)에 따른 금액 계산:**
            1.  `FIXED_AMOUNT`: FeeItem의 `unitPrice`를 해당 항목 금액으로 한다.
            2.  `PER_AREA`: (FeeItem의 `unitPrice` * 해당 Unit의 `area`)로 계산한다.
            3.  `PER_SHARE`: (건물 전체 `totalFee` 또는 항목별 총액 / 건물 전체 `totalShares` (예: 총 세대수)) * 해당 Unit의 `share` (예: 1)로 계산. (총액 기준 항목은 5.1.2 참조)
            4.  `PER_USAGE`: (FeeItem의 `unitPrice` * 해당 Unit, 해당 청구월, 해당 항목의 `usage` (사용량))로 계산한다. 사용량 데이터가 없으면 0 또는 오류 처리(정책에 따라).
            5.  `COMMON_TOTAL_PER_AREA`: (해당 청구월의 해당 항목 `totalAmountForMonth` / 건물 전체 유효 면적 합계) * 해당 Unit의 `area`로 계산한다.
            6.  `COMMON_TOTAL_PER_SHARE`: (해당 청구월의 해당 항목 `totalAmountForMonth` / 건물 전체 유효 세대수)로 계산한다 (N등분).
        ii. **부가세 계산:** 해당 항목이 `vatApplicable`이면, 계산된 금액의 10%를 `vatAmount`로 계산한다.
        iii. 계산된 항목 금액, 부가세액을 `UnitFeeDetail`에 저장한다.
    b.  **세대별 총 관리비 합산:** 해당 세대의 모든 항목별 `totalAmountWithVat`를 합산하여 `UnitMonthlyFee`의 `finalAmountDue`를 계산하고 저장한다.

### 5.2. 주요 비즈니스 규칙
- **R-FEE-CALC-001:** 관리비 산정은 대상 청구월의 상태가 `CALC_READY`일 때만 실행 가능하다. (즉, 모든 기초 데이터 입력이 완료되어야 함)
- **R-FEE-CALC-002:** 계산에 필요한 필수 데이터(예: 면적, 단가, 사용량 등)가 누락된 경우, 해당 항목/세대는 0원으로 처리하거나 오류로 표시하고 관리자에게 알린다 (정책 결정 필요).
- **R-FEE-CALC-003:** 모든 금액 계산 시 소수점 처리 규칙(예: 반올림, 절사, 특정 자릿수)을 일관되게 적용한다. (시스템 설정 또는 항목별 설정)
- **R-FEE-CALC-004:** [산정 결과 확정] 전까지는 [재계산]이 가능해야 한다. 재계산 시 기존 산정 내역은 삭제(또는 비활성화)되고 새로운 내역으로 대체된다.
- **R-FEE-CALC-005:** [산정 결과 확정] 후에는 해당 청구월의 관리비 산정 내역은 수정이 불가하며, 청구월 상태는 `NOTIFIED`로 변경 준비가 된다. (만약 수정이 필요하면 '정정 부과' 프로세스를 따름 - 별도 기능)

## 6. 오류 처리 및 예외 관리
| 오류 코드 (선택) | 발생 조건                                   | 오류 메시지 (User-facing)                                    | 시스템 처리 방안                                     |
| :--------------- | :------------------------------------------ | :----------------------------------------------------------- | :--------------------------------------------------- |
| E-FEE-CALC-01    | 필수 기초 데이터(항목 설정, 검침값 등) 누락 | "관리비 산정에 필요한 [누락 데이터 종류] 정보가 부족합니다. 확인 후 다시 시도해주세요." | 산정 중단, 관리자에게 상세 오류 내용 안내            |
| E-FEE-CALC-02    | 계산 로직 수행 중 예기치 않은 오류 발생     | "관리비 산정 중 오류가 발생했습니다. (오류코드: XXXXX)"      | 산정 중단, 오류 로깅, 관리자에게 기술 지원 요청 안내 |
| E-FEE-CALC-03    | 청구월 상태 부적합 (예: 이미 마감됨)        | "현재 청구월 상태([상태명])에서는 관리비 산정을 실행할 수 없습니다." | 산정 실행 차단, 안내 메시지 표시                     |

## 7. (기능별) 성능 요구사항
- P-FEE-CALC-01: 500세대, 20개 관리비 항목 기준, 전체 관리비 자동 산정 완료까지 30초 이내.
- P-FEE-CALC-02: 산정 결과 상세 조회 화면(세대별, 항목별) 로딩 시간 3초 이내.

## 8. (기능별) 보안 요구사항
- S-FEE-CALC-01: 관리비 산정 및 확정 기능은 '관리소장', '경리담당자' 등 인가된 역할만 접근 가능하다.
- S-FEE-CALC-02: 관리비 산정 실행, 결과 확정, 재계산 등의 주요 행위는 감사 로그에 기록되어야 한다.
- S-FEE-CALC-03: 산정 로직 및 단가 등 중요 설정값 변경은 엄격한 권한 통제 하에 이루어져야 한다.

## 9. 다른 기능/모듈과의 연관성
- **청구월 관리:** 본 기능은 '청구월 관리'에서 선택된 특정 청구월 및 해당 청구월의 상태에 강하게 의존한다.
- **관리비 항목 설정:** 본 기능의 계산 로직은 '관리비 항목 설정'에서 정의된 항목별 부과 방식, 단가, 부가세 여부 등을 직접 사용한다.
- **공과금 입력 (개별사용료 입력):** 세대별 사용량 기반 관리비 항목 계산 시 이 기능에서 입력된 검침값/사용량 데이터를 사용한다.
- **관리비 입력 (공용 관리비 입력):** 공용 관리비 배분 항목 계산 시 이 기능에서 입력된 월별 공용비 총액 데이터를 사용한다.
- **고지서 발급:** 본 기능에서 산정되고 확정된 세대별 관리비 내역은 '고지서 발급' 기능의 핵심 기초 데이터가 된다.

## 10. (선택 사항) 테스트 고려 사항
- 다양한 관리비 항목 조합(고정액, 면적 비례, 사용량 비례, 공용비 배분 등)에 대한 계산 정확성 검증.
- 경계값 테스트 (예: 사용량 0, 면적 0, 단가 0 등).
- 필수 데이터 누락 시 예외 처리 및 알림 기능 테스트.
- 대량 세대 데이터에 대한 계산 성능 및 안정성 테스트.
- 재계산 시 기존 데이터 처리 및 신규 데이터 정확성 검증.
- 확정 후 데이터 수정 불가 및 상태 변경 연동 테스트.

## 11. 용어 정의 (선택 사항)
- **배분 (Allocation/Apportionment):** 공용으로 발생한 비용을 일정한 기준(면적, 세대수 등)에 따라 각 세대에 나누어 부담시키는 과정.

## 12. 문서 이력
| 버전 | 날짜       | 작성자      | 주요 변경 내용   |
| :--- | :--------- | :---------- | :--------------- |
| 1.0  | 2025-05-28 | QIRO 기획팀 | 초기 명세서 작성 |
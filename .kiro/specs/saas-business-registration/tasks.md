# 사업자 회원가입 및 멀티테넌시 구현 계획

## 개요

이 구현 계획은 QIRO 건물 관리 SaaS의 사업자 회원가입 시스템과 멀티테넌시 아키텍처 구현에 집중한 작업 목록입니다. 조직별 데이터 격리, 사업자 인증, 건물 그룹 관리, 그리고 보안 강화를 포함합니다.

## 작업 목록

- [x] 1. 멀티테넌시 기반 조직 관리 테이블 구현
  - 사업자 회원가입을 위한 핵심 테이블 구조 설계 및 구현
  - 조직별 데이터 격리를 위한 멀티테넌트 아키텍처 구축
  - 사업자 인증 및 권한 관리 시스템 구현
  - _요구사항: 1.1, 1.2, 1.3, 1.4, 1.5, 2.1, 2.2, 2.3, 2.4, 4.1, 4.2, 4.3_

- [x] 1.1 Companies 테이블 생성 및 사업자 정보 관리 구조 구현
  - 사업자등록번호 유효성 검증 및 중복 방지
  - 사업자 인증 상태 관리 (PENDING, VERIFIED, REJECTED, SUSPENDED)
  - 구독 플랜 및 상태 관리
  - _요구사항: 1.1, 1.3, 1.4, 1.5_

- [x] 1.2 Users 테이블 생성 및 멀티테넌시 구조 설정
  - 조직별 사용자 격리 (company_id 외래키)
  - 사용자 타입 구분 (SUPER_ADMIN, EMPLOYEE)
  - 이메일/전화번호 인증 상태 관리
  - 계정 잠금 및 보안 기능
  - _요구사항: 2.1, 2.2, 2.3, 2.4_

- [x] 1.3 Roles 및 User_role_links 테이블 생성
  - 조직별 역할 관리 (company_id 기반 격리)
  - 시스템 기본 역할 및 커스텀 역할 지원
  - JSONB 기반 세분화된 권한 관리
  - _요구사항: 4.2, 4.3, 5.3_

- [x] 2. 건물 그룹 관리 시스템 구현
  - 조직별 건물 그룹 관리 및 담당자 배치 시스템 구축
  - 건물과 그룹 간의 다대다 관계 관리
  - 사용자별 그룹 접근 권한 제어
  - _요구사항: 3.1, 3.2, 3.3, 3.4, 4.1, 4.2, 4.3, 4.4_

- [x] 2.1 Building_groups 테이블 생성
  - 조직별 건물 그룹 관리 (company_id 기반)
  - 그룹 타입 분류 (COST_ALLOCATION, MANAGEMENT_UNIT, GEOGRAPHIC, CUSTOM)
  - 그룹 활성화 상태 관리
  - _요구사항: 3.1, 3.2, 3.3_

- [x] 2.2 Building_group_assignments 테이블 생성
  - 건물과 그룹 간의 다대다 관계 관리
  - 배정 이력 추적 (assigned_at, assigned_by)
  - _요구사항: 3.3, 3.4_

- [x] 2.3 User_group_assignments 테이블 생성
  - 사용자와 건물 그룹 간의 담당자 배치 관리
  - 접근 권한 레벨 설정 (read, write, admin)
  - 배정 만료일 및 활성화 상태 관리
  - _요구사항: 4.1, 4.2, 4.3, 4.4_

- [x] 3. 사업자 인증 및 검증 시스템 구현
  - 사업자등록번호, 전화번호, 이메일 인증 시스템 구축
  - 인증 토큰 관리 및 보안 강화
  - 국세청 API 연동을 위한 인터페이스 준비
  - _요구사항: 1.1, 1.2, 2.1, 2.2, 2.3_

- [x] 3.1 Business_verification_records 테이블 생성
  - 사업자등록번호, 전화번호, 이메일 인증 기록 관리
  - 인증 데이터 JSONB 저장 및 상태 추적
  - 인증 만료일 및 오류 메시지 관리
  - _요구사항: 1.1, 1.2, 2.1, 2.2_

- [x] 3.2 Phone_verification_tokens 테이블 생성
  - 휴대폰 인증 토큰 및 코드 관리
  - 토큰 만료 시간 및 사용 횟수 제한
  - 보안을 위한 토큰 해시 저장
  - _요구사항: 2.1, 2.2, 2.3_

- [x] 3.3 사업자등록번호 검증 함수 개선 및 API 연동 준비
  - 기존 체크섬 검증 함수 확장
  - 국세청 API 연동을 위한 인터페이스 준비
  - 검증 결과 캐싱 및 재검증 로직
  - _요구사항: 1.1, 1.2_

- [-] 4. Row Level Security (RLS) 및 데이터 격리 구현
  - 조직별 데이터 격리를 위한 RLS 정책 설정
  - 권한 기반 접근 제어 시스템 구축
  - 감사 로그 및 활동 추적 시스템 구현
  - _요구사항: 5.1, 5.2, 5.3, 5.4, 6.1, 6.2, 6.3, 6.4_

- [x] 4.1 조직별 데이터 격리를 위한 RLS 정책 설정
  - Companies, Users, Building_groups 테이블 RLS 활성화
  - current_setting을 통한 조직 컨텍스트 설정
  - 애플리케이션 역할 기반 정책 적용
  - _요구사항: 6.1, 6.2, 6.3_

- [x] 4.2 권한 기반 접근 제어 함수 구현
  - 사용자 권한 검증 함수
  - 건물 그룹 접근 권한 확인 함수
  - 역할별 기능 접근 제어 함수
  - _요구사항: 5.1, 5.2, 5.3, 5.4_

- [ ] 4.3 감사 로그 시스템 구현
  - 중요 작업에 대한 감사 추적
  - 사용자 활동 로그 기록
  - 데이터 변경 이력 관리
  - _요구사항: 6.4_

- [x] 5. 조직 관리 자동화 및 비즈니스 로직 구현
  - 회사 생성 시 기본 역할 자동 생성 시스템
  - 사용자 생성 및 역할 할당 자동화
  - 그룹 관리 비즈니스 로직 구현
  - _요구사항: 1.5, 3.1, 3.2, 3.3, 3.4, 4.1, 4.2, 4.3, 7.1, 7.2, 7.3, 7.4_

- [x] 5.1 회사 생성 시 기본 역할 자동 생성 트리거
  - 총괄관리자, 관리소장, 경리담당자 역할 자동 생성
  - 각 역할별 기본 권한 설정
  - 트리거 함수 및 예외 처리
  - _요구사항: 1.5, 4.2_

- [x] 5.2 사용자 생성 및 역할 할당 함수
  - 사용자 생성 시 기본 역할 할당
  - 이메일 중복 검증 (조직 내)
  - 초기 비밀번호 설정 및 변경 강제
  - _요구사항: 4.1, 4.2, 4.3_

- [x] 5.3 그룹 관리 비즈니스 로직 구현
  - 그룹 생성/수정/삭제 함수
  - 건물 배정 및 해제 함수
  - 담당자 배치 및 권한 관리 함수
  - _요구사항: 3.1, 3.2, 3.3, 3.4, 7.1, 7.2, 7.3, 7.4_

- [x] 6. 기존 테이블과의 통합 및 마이그레이션
  - 기존 데이터베이스 스키마를 멀티테넌시 구조로 변경
  - 기존 데이터 마이그레이션 및 무결성 검증
  - RLS 정책 확장 적용
  - _요구사항: 1.2, 3.1, 4.1, 6.1, 6.2_

- [x] 6.1 기존 Buildings 테이블에 company_id 추가
  - 외래키 제약조건 추가
  - 기존 데이터 마이그레이션 스크립트
  - RLS 정책 적용
  - _요구사항: 3.1, 6.1_

- [x] 6.2 기존 Users 테이블 구조 조정
  - 멀티테넌시 지원을 위한 스키마 변경
  - 기존 사용자 데이터 마이그레이션
  - 권한 시스템 통합
  - _요구사항: 1.2, 4.1, 6.1_

- [x] 6.3 관리비 및 임대차 테이블 조직 격리 적용
  - 조직별 데이터 격리를 위한 스키마 수정
  - RLS 정책 확장 적용
  - 데이터 무결성 검증
  - _요구사항: 6.1, 6.2_

- [x] 7. 보안 강화 및 데이터 보호
  - 민감 정보 암호화 및 보안 강화
  - 인증 시스템 보안 개선
  - 접근 로그 및 모니터링 시스템 구축
  - _요구사항: 2.1, 2.2, 2.3, 2.4, 6.4_

- [x] 7.1 민감 정보 암호화 구현
  - 개인정보 암호화 함수 개선
  - 사업자등록번호, 전화번호 등 암호화 저장
  - 암호화 키 관리 시스템
  - _요구사항: 6.4_

- [x] 7.2 인증 보안 강화
  - JWT 토큰 기반 인증 준비
  - 비밀번호 정책 강화
  - 다단계 인증 지원 구조
  - _요구사항: 2.1, 2.2, 2.3, 2.4_

- [x] 7.3 접근 로그 및 모니터링 시스템
  - 로그인 시도 및 실패 기록
  - 권한 변경 이력 추적
  - 의심스러운 활동 감지
  - _요구사항: 6.4_

- [x] 8. 성능 최적화 및 인덱스 설계
  - 멀티테넌시 환경에 최적화된 인덱스 설계
  - 대용량 데이터 처리 최적화
  - RLS 성능 최적화
  - _요구사항: 성능 요구사항_

- [x] 8.1 멀티테넌시 환경 최적화 인덱스 생성
  - company_id 기반 복합 인덱스
  - RLS 성능 최적화 인덱스
  - 자주 사용되는 쿼리 패턴 최적화
  - _요구사항: 성능 요구사항_

- [x] 8.2 대용량 데이터 처리 최적화
  - 파티셔닝 전략 수립
  - 쿼리 성능 모니터링
  - 동시성 제어 최적화
  - _요구사항: 성능 요구사항_

- [x] 9. 테스트 및 검증
  - 멀티테넌시 데이터 격리 검증
  - 사업자 회원가입 플로우 통합 테스트
  - 성능 및 부하 테스트
  - _요구사항: 1.1, 1.2, 1.3, 1.4, 1.5, 2.1, 2.2, 2.3, 2.4, 6.1, 6.2, 6.3, 성능 요구사항_

- [x] 9.1 멀티테넌시 데이터 격리 테스트
  - 조직 간 데이터 접근 차단 검증
  - RLS 정책 동작 확인
  - 권한 기반 접근 제어 테스트
  - _요구사항: 6.1, 6.2, 6.3_

- [x] 9.2 사업자 회원가입 플로우 통합 테스트
  - 전체 가입 프로세스 검증
  - 인증 시스템 동작 확인
  - 오류 상황 처리 테스트
  - _요구사항: 1.1, 1.2, 1.3, 1.4, 1.5, 2.1, 2.2, 2.3, 2.4_

- [x] 9.3 성능 및 부하 테스트
  - 다중 조직 환경에서의 성능 측정
  - 동시 접속 시나리오 테스트
  - 데이터베이스 부하 테스트
  - _요구사항: 성능 요구사항_
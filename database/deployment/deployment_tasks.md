# QIRO 사업자 회원가입 시스템 배포 태스크

## 개요
이 문서는 QIRO 사업자 회원가입 시스템의 데이터베이스 스키마와 관련 구성 요소를 프로덕션 환경에 배포하기 위한 단계별 가이드입니다.

## 전제 조건
- PostgreSQL 17.5 이상
- 적절한 데이터베이스 권한 (CREATE, ALTER, DROP 등)
- 백업 및 롤백 계획 수립

## 배포 단계

### 1단계: 환경 준비 및 백업
- [ ] 1.1 현재 데이터베이스 백업 생성
- [ ] 1.2 배포 환경 확인 (PostgreSQL 버전, 권한 등)
- [ ] 1.3 롤백 계획 수립
- [ ] 1.4 배포 로그 디렉토리 생성

### 2단계: 기본 스키마 및 확장 기능 설정
- [ ] 2.1 필요한 PostgreSQL 확장 기능 설치
- [ ] 2.2 bms 스키마 생성
- [ ] 2.3 ENUM 타입 생성
- [ ] 2.4 공통 함수 생성 (update_updated_at_column, validate_business_registration_number)

### 3단계: 핵심 테이블 생성
- [ ] 3.1 companies 테이블 생성
- [ ] 3.2 roles 테이블 생성
- [ ] 3.3 users 테이블 생성
- [ ] 3.4 user_role_links 테이블 생성

### 4단계: 건물 관리 테이블 생성
- [ ] 4.1 building_groups 테이블 생성
- [ ] 4.2 buildings 테이블 생성
- [ ] 4.3 building_group_assignments 테이블 생성
- [ ] 4.4 user_group_assignments 테이블 생성

### 5단계: 인증 관련 테이블 생성
- [ ] 5.1 business_verification_records 테이블 생성
- [ ] 5.2 phone_verification_tokens 파티션 테이블 생성
- [ ] 5.3 email_verification_tokens 파티션 테이블 생성
- [ ] 5.4 파티션 테이블 생성 (현재 월)

### 6단계: 인덱스 및 트리거 생성
- [ ] 6.1 성능 최적화 인덱스 생성
- [ ] 6.2 updated_at 자동 업데이트 트리거 생성
- [ ] 6.3 인덱스 성능 검증

### 7단계: 보안 설정 (RLS)
- [ ] 7.1 application_role 생성
- [ ] 7.2 RLS 정책 활성화
- [ ] 7.3 멀티테넌시 격리 정책 생성
- [ ] 7.4 권한 부여

### 8단계: 초기 데이터 설정
- [ ] 8.1 시스템 기본 역할 생성
- [ ] 8.2 테스트 데이터 생성 (개발 환경만)
- [ ] 8.3 기본 설정 데이터 삽입

### 9단계: 테스트 및 검증
- [ ] 9.1 스키마 무결성 검증
- [ ] 9.2 RLS 정책 동작 테스트
- [ ] 9.3 성능 테스트 실행
- [ ] 9.4 멀티테넌시 격리 테스트

### 10단계: 모니터링 및 유지보수 설정
- [ ] 10.1 성능 모니터링 설정
- [ ] 10.2 로그 설정
- [ ] 10.3 백업 스케줄 설정
- [ ] 10.4 파티션 관리 자동화 설정

## 상세 실행 명령어

### 환경별 배포 스크립트
```bash
# 개발 환경
./deploy_dev.sh

# 스테이징 환경  
./deploy_staging.sh

# 프로덕션 환경
./deploy_production.sh
```

### 롤백 스크립트
```bash
# 긴급 롤백
./rollback.sh [backup_timestamp]
```

## 검증 체크리스트
- [ ] 모든 테이블이 정상 생성되었는가?
- [ ] RLS 정책이 올바르게 적용되었는가?
- [ ] 인덱스가 모두 생성되었는가?
- [ ] 트리거가 정상 동작하는가?
- [ ] 성능 요구사항을 만족하는가?
- [ ] 보안 요구사항을 만족하는가?

## 문제 해결 가이드
- 배포 중 오류 발생 시 즉시 롤백
- 로그 파일 확인 및 분석
- 필요시 단계별 재실행

## 연락처
- 개발팀: dev-team@qiro.com
- 인프라팀: infra-team@qiro.com
- 긴급 연락처: emergency@qiro.com
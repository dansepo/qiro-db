# 월별 관리비 처리 워크플로우 데이터베이스 설계 완료 보고서

## 개요
QIRO 건물 관리 SaaS의 핵심 기능인 월별 관리비 처리 워크플로우에 대한 데이터베이스 설계가 완료되었습니다. 이 워크플로우는 청구월 생성부터 수납 완료까지의 전체 프로세스를 체계적으로 지원합니다.

## 완료된 작업 목록

### 3.1 청구월 및 검침 데이터 테이블 설계 ✅
- **billing_months 테이블**: 청구월 관리 및 상태 추적
- **unit_meter_readings 테이블**: 호실별 검침 데이터 (전기, 수도, 가스 등)
- **common_meter_readings 테이블**: 공용 시설 검침 데이터
- **billing_month_status_history 테이블**: 청구월 상태 변경 이력
- 월별 데이터 분할 및 아카이빙 전략 설계
- 검침 데이터 유효성 검증 제약조건 및 트리거 구현

### 3.2 관리비 산정 및 고지서 테이블 설계 ✅
- **monthly_fees 테이블**: 호실별, 항목별 관리비 산정 결과
- **fee_calculation_verification 테이블**: 복식부기 원칙 적용 검증
- **invoices 테이블**: 고지서 정보 및 상태 관리
- **invoice_line_items 테이블**: 고지서 상세 항목
- **invoice_status_history 테이블**: 고지서 상태 변경 이력
- 관리비 계산 결과 검증 제약조건 및 자동 검증 함수 구현

### 3.3 수납 처리 및 미납 관리 테이블 설계 ✅
- **payments 테이블**: 수납 내역 관리
- **payment_details 테이블**: 수납 상세 내역 (부분 수납 추적)
- **delinquencies 테이블**: 미납 관리 및 연체료 계산
- **late_fee_calculations 테이블**: 연체료 계산 이력
- 연체료 자동 계산 함수 및 트리거 구현
- 수납 상태별 데이터 무결성 보장 제약조건 설정

## 핵심 기능 및 특징

### 1. 상태 기반 워크플로우 관리
```sql
-- 청구월 상태 전환: DRAFT → DATA_INPUT → CALCULATING → CALCULATED → INVOICED → CLOSED
CREATE TYPE billing_month_status AS ENUM (
    'DRAFT', 'DATA_INPUT', 'CALCULATING', 'CALCULATED', 'INVOICED', 'CLOSED'
);
```

### 2. 자동 계산 및 검증
- 검침 데이터 기반 사용량 자동 계산 (GENERATED ALWAYS AS)
- 관리비 항목별 계산 방식 지원 (고정금액, 단위기준, 사용량기준, 비율기준)
- 복식부기 원칙 적용 검증 (총액과 배분액 일치 확인)

### 3. 연체료 자동 계산
```sql
-- 연체료 계산 함수 (단리 방식, 유예기간 적용)
CREATE OR REPLACE FUNCTION calculate_late_fee(
    p_overdue_amount DECIMAL(12,2),
    p_overdue_days INTEGER,
    p_late_fee_rate DECIMAL(5,2),
    p_grace_period_days INTEGER DEFAULT 0
) RETURNS DECIMAL(12,2)
```

### 4. 데이터 무결성 보장
- 외래키 제약조건을 통한 참조 무결성
- CHECK 제약조건을 통한 비즈니스 규칙 적용
- 트리거를 통한 자동 상태 업데이트 및 이력 관리

## 지원하는 비즈니스 시나리오

### 1. 정상 수납 시나리오
- 완전 납부: 고지서 전액 일시 납부
- 부분 납부: 우선순위에 따른 항목별 배분
- 다양한 결제 수단: 현금, 계좌이체, 카드, CMS, 가상계좌

### 2. 연체 관리 시나리오
- 자동 연체 감지 및 연체료 계산
- 유예기간 적용 (납부 정책 기반)
- 연체 상태별 관리 (연체, 부분납부, 해결, 손실처리)

### 3. 분할 납부 시나리오
- 분할 납부 계획 수립 및 관리
- 분할 납부 진행 상황 추적

## 성능 최적화

### 1. 인덱스 설계
- 주요 조회 패턴별 복합 인덱스
- 상태별 부분 인덱스 (WHERE 조건 포함)
- 날짜 기반 인덱스 (월별 데이터 조회 최적화)

### 2. 파티셔닝 준비
- 연도별 파티셔닝 가능한 구조 설계
- 대용량 데이터 처리를 위한 확장성 확보

### 3. 뷰 및 집계 함수
- 자주 사용되는 조회 패턴을 위한 뷰 제공
- 통계 및 집계 데이터 효율적 조회

## 보안 및 감사

### 1. 감사 로그
- 모든 중요 테이블에 감사 필드 포함
- 상태 변경 이력 자동 기록

### 2. 데이터 검증
- 입력 데이터 유효성 검증 함수
- 계산 결과 검증 및 오류 감지

### 3. 권한 관리
- 사용자별 데이터 접근 제어
- 민감 정보 암호화 지원

## 테스트 및 검증

### 1. 단위 테스트
- 각 함수별 단위 테스트 케이스
- 제약조건 및 트리거 테스트

### 2. 통합 테스트
- 전체 워크플로우 통합 테스트
- 다양한 시나리오별 테스트 데이터

### 3. 성능 테스트
- 대용량 데이터 기준 성능 테스트
- 동시 접속 시나리오 테스트

## 확장성 및 유지보수

### 1. 확장 가능한 구조
- 새로운 관리비 항목 추가 용이
- 다양한 계산 방식 지원
- 외부 시스템 연동 준비

### 2. 유지보수성
- 명확한 테이블 구조 및 관계
- 상세한 코멘트 및 문서화
- 표준화된 명명 규칙

## 결론

월별 관리비 처리 워크플로우 데이터베이스 설계가 성공적으로 완료되었습니다. 이 설계는 다음과 같은 핵심 가치를 제공합니다:

1. **완전성**: 청구월 생성부터 수납 완료까지 전체 프로세스 지원
2. **정확성**: 자동 계산 및 검증을 통한 오류 최소화
3. **효율성**: 최적화된 인덱스 및 쿼리 성능
4. **확장성**: 미래 요구사항 변화에 대응 가능한 유연한 구조
5. **신뢰성**: 데이터 무결성 및 감사 추적 보장

이제 이 설계를 바탕으로 Spring Boot 백엔드 애플리케이션 개발을 진행할 수 있습니다.
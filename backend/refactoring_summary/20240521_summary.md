# Qiro-DB 백엔드 프로젝트 리팩토링 및 오류 수정 내역 (2024-05-21)

## 1. 빌드 및 설정 (Build & Configuration)

### 1.1. `build.gradle.kts`
- **QueryDSL 설정 오류 수정**: `kapt`로 생성된 QueryDSL Q-Type 클래스들이 컴파일 시점에 포함되도록 `sourceSets` 설정을 수정하여 빌드 오류를 방지했습니다.

### 1.2. `src/main/resources/application.yml`
- **보안 강화**: 하드코딩되어 있던 JWT 비밀 키와 데이터베이스 접속 정보를 환경 변수에서 읽어오도록 변경했습니다. (`${JWT_SECRET}`, `${PROD_DB_URL}` 등)
- **프로덕션 설정 오류 수정**: `prod` 프로필에 누락되었던 데이터베이스 설정을 추가하여, 프로덕션 환경에서 개발용 DB에 접속하는 치명적인 오류를 해결했습니다.

## 2. 보안 (Security)

### 2.1. `src/main/kotlin/com/qiro/config/SecurityConfig.kt`
- **CORS 취약점 해결**: 모든 출처(`*`)를 허용하고 `allowCredentials`를 `true`로 설정했던 매우 위험한 CORS 설정을 수정했습니다. 이제 로컬 개발 환경(`localhost:3000`)만 명시적으로 허용하며, 프로덕션 배포 시 실제 프론트엔드 도메인을 추가하도록 주석을 남겼습니다.
- **H2 콘솔 보안 강화**: 프로덕션 환경(`prod` 프로필)에서는 H2 데이터베이스 콘솔 접근이 불가능하도록 차단하여 보안을 강화했습니다.

### 2.2. `src/main/kotlin/com/qiro/security/jwt/JwtTokenProvider.kt`
- **로깅 강화**: 토큰 검증(`validateToken`) 실패 시, 원인을 파악할 수 없었던 문제를 해결하기 위해 각 예외(`ExpiredJwtException`, `MalformedJwtException` 등)에 대한 로그를 추가했습니다.
- **오래된 API 교체**: `jjwt` 라이브러리의 사용되지 않는(deprecated) `signWith(key, algorithm)` 메소드를 최신 권장 방식인 `signWith(key)`로 수정했습니다.

### 2.3. `src/main/kotlin/com/qiro/security/jwt/JwtAuthenticationFilter.kt`
- **안정성 및 효율성 개선**: `!!` 연산자를 제거하고 `let` 스코프 함수를 사용하여 JWT 토큰을 null-safe하게 처리하도록 개선했습니다. 또한, 이미 인증된 사용자에 대해서는 불필요한 인증 절차를 건너뛰도록 로직을 추가하여 효율성을 높였습니다.

## 3. 도메인 로직 (Domain Logic)

### 3.1. `src/main/kotlin/com/qiro/domain/user/entity/User.kt`
- **치명적 버그 수정**: 계정 잠금 시 `userStatus`와 실제 잠금 상태가 일치하지 않던 데이터 불일치 버그를 수정했습니다. 이제 잠금/해제 시 상태가 명확하게 동기화됩니다.
- **유지보수성 향상**: 로그인 실패 횟수(5), 잠금 시간(30분) 등 하드코딩된 "매직 넘버"를 `companion object` 상수로 정의하여 가독성과 유지보수성을 개선했습니다.
- **안정성 강화**: 이메일, 사용자 이름 등에 Bean Validation 어노테이션(`@Email`, `@Size`)을 추가하여 애플리케이션 레벨에서 데이터 무결성을 검증하도록 강화했습니다.

### 3.2. `src/main/kotlin/com/qiro/domain/user/repository/UserRepository.kt`
- **성능 최적화**: 사용자 검색 시 `LOWER()` 함수 사용으로 인해 인덱스를 타지 못하던 비효율적인 JPQL 쿼리를, 대소문자를 구분하지 않는 검색을 지원하며 인덱스를 활용할 수 있는 PostgreSQL의 `ILIKE` 연산자를 사용하는 네이티브 쿼리로 변경하여 검색 성능을 크게 향상시켰습니다.
